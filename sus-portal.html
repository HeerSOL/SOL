<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL SuS Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modals */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom button styling for a modern look */
        .modern-button {
            transition: all 0.2s ease-in-out;
        }
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .modern-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md text-center">
            <div class="w-12 h-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Firebase wird geladen...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-96">
            <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">SOL Portal Login (SuS)</h1>
            <div>
                <div class="mb-4">
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Passwort</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                </div>
                <button id="loginButton" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 modern-button text-lg font-semibold">
                    Anmelden
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="min-h-screen hidden">
        <div class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-3xl font-bold text-gray-900">SOL Sch√ºler Portal</h1>
                    <div class="flex items-center space-x-4">
                        <span id="userEmail" class="text-base text-gray-600 font-medium"></span>
                        <button id="logoutButton" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 p-2 rounded-md hover:bg-gray-100 transition-colors modern-button">
                            <span>Abmelden</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-xl shadow-lg">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button data-tab="tasks" class="tab-button py-4 px-2 border-b-2 font-medium text-base border-transparent text-gray-500 hover:text-gray-700 transition-colors">
                            ‚úÖ Auftr√§ge der Woche
                        </button>
                        <button data-tab="timetable" class="tab-button py-4 px-2 border-b-2 font-medium text-base border-transparent text-gray-500 hover:text-gray-700 transition-colors">
                            üìÖ Mein Stundenplan
                        </button>
                    </nav>
                </div>

                <div class="p-8">
                    <!-- Aufgaben-Tab -->
                    <div id="tasks-content" class="tab-content hidden">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Auftr√§ge der Woche</h2>
                        <p class="text-gray-600 mb-6">Hier findest du alle Aufgaben f√ºr die SOL-F√§cher. Markiere sie als erledigt, wenn du fertig bist!</p>
                        <p id="noTasksMessage" class="text-gray-500 text-center mt-8 hidden">
                            Es gibt noch keine Aufgaben f√ºr diese Woche.
                        </p>
                        <div id="weeklyTasksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <!-- Weekly tasks will be rendered here -->
                        </div>
                    </div>

                    <!-- Stundenplan-Tab -->
                    <div id="timetable-content" class="tab-content hidden">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Mein Stundenplan</h2>
                        <p class="text-gray-600 mb-6">Plane deine SOL-Lektionen und halte fest, woran du arbeitest.</p>
                        <div class="overflow-x-auto rounded-lg shadow-sm">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="px-4 py-3 border-b text-left font-semibold text-gray-700 rounded-tl-lg">Zeit</th>
                                        <th class="px-4 py-3 border-b text-center font-semibold text-gray-700">Montag</th>
                                        <th class="px-4 py-3 border-b text-center font-semibold text-gray-700">Dienstag</th>
                                        <th class="px-4 py-3 border-b text-center font-semibold text-gray-700">Mittwoch</th>
                                        <th class="px-4 py-3 border-b text-center font-semibold text-gray-700">Donnerstag</th>
                                        <th class="px-4 py-3 border-b text-center font-semibold text-gray-700">Freitag</th>
                                    </tr>
                                </thead>
                                <tbody id="studentTimetableBody">
                                    <!-- Student's weekly plan content will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="customMessageModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-[9999]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="customMessageTitle" class="text-xl font-semibold mb-4 text-gray-900"></h3>
            <p id="customMessageContent" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="customMessageCloseButton" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 modern-button">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-[9999]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="customConfirmTitle" class="text-xl font-semibold mb-4 text-gray-900">Best√§tigung</h3>
            <p id="customConfirmContent" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="customConfirmCancelButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 modern-button">Abbrechen</button>
                <button id="customConfirmOkButton" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 modern-button">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Student Lesson Plan Edit Modal -->
    <div id="studentPlanEditModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-4">
            <h3 class="text-xl font-semibold mb-4 text-gray-900" id="studentPlanModalTitle">SOL-Lektion planen</h3>
            <form id="studentPlanForm" class="space-y-4">
                <div>
                    <label for="studentPlanSubject" class="block text-sm font-medium text-gray-700">Fach</label>
                    <select id="studentPlanSubject" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <!-- Options will be dynamically added here based on SOL subjects -->
                    </select>
                </div>
                <div>
                    <label for="studentPlanTimeSlot" class="block text-sm font-medium text-gray-700">Zeitfenster</label>
                    <input type="text" id="studentPlanTimeSlot" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" readonly>
                </div>
                <div>
                    <label for="studentPlanTitle" class="block text-sm font-medium text-gray-700">Was m√∂chtest du tun? (Titel)</label>
                    <input type="text" id="studentPlanTitle" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="studentPlanDescription" class="block text-sm font-medium text-gray-700">Beschreibung (optional)</label>
                    <textarea id="studentPlanDescription" rows="3" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="studentPlanCancelButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 modern-button">Abbrechen</button>
                    <button type="submit" id="studentPlanSaveButton" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 modern-button">Speichern</button>
                    <button type="button" id="studentPlanDeleteButton" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden modern-button">L√∂schen</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyAsexnWyCjkYz8kfAPd7Od1g0xsfcSEKRk",
            authDomain: "sol-portal-cf905.firebaseapp.com",
            projectId: "sol-portal-cf905",
            storageBucket: "sol-portal-cf905.firebasestorage.app",
            messagingSenderId: "478097533058",
            appId: "1:478097533058:web:b2afa0a73892b90d8a2c9b",
            measurementId: "G-JJ3RRJNK7T"
        };

        // Initialize Firebase App and services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null; // Firebase user object
        let userId = null; // User ID (UID)
        let isAuthReady = false; // Flag to ensure DB operations wait for auth

        let activeTab = 'tasks'; // Default tab for SuS portal
        let timetable = {}; // Annual timetable from LP portal
        let solSubjects = []; // List of subjects defined as SOL
        let weeklyTasks = []; // Weekly tasks from LP portal
        let studentWeeklyPlans = {}; // Student's personal weekly plan entries
        let susAccounts = []; // To check if logged-in user is a SuS

        // Currently edited student plan entry in modal
        let currentStudentPlanEntry = null;

        const subjects = [
            { name: 'Deutsch', color: 'bg-red-400', lightColor: 'bg-red-50', textColor: 'text-red-700' },
            { name: 'Englisch', color: 'bg-blue-400', lightColor: 'bg-blue-50', textColor: 'text-blue-700' },
            { name: 'Franzoesisch', color: 'bg-purple-400', lightColor: 'bg-purple-50', textColor: 'text-purple-700' },
            { name: 'Mathematik', color: 'bg-green-400', lightColor: 'bg-green-50', textColor: 'text-green-700' },
            { name: 'Natur und Technik', color: 'bg-yellow-400', lightColor: 'bg-yellow-50', textColor: 'text-yellow-700' },
            { name: 'NT / MI', color: 'bg-yellow-300', lightColor: 'bg-yellow-50', textColor: 'text-yellow-700' },
            { name: 'Raeume Zeiten Gesellschaften', color: 'bg-orange-400', lightColor: 'bg-orange-50', textColor: 'text-orange-700' },
            { name: 'Ethik Religion Gemeinschaft', color: 'bg-pink-400', lightColor: 'bg-pink-50', textColor: 'text-pink-700' },
            { name: 'Bewegung und Sport', color: 'bg-red-500', lightColor: 'bg-red-50', textColor: 'text-red-700' },
            { name: 'Textiles und Technisches Gestalten', color: 'bg-indigo-400', lightColor: 'bg-indigo-50', textColor: 'text-indigo-700' },
            { name: 'Musik', color: 'bg-violet-400', lightColor: 'bg-violet-50', textColor: 'text-violet-700' },
            { name: 'Bildnerisches Gestalten', color: 'bg-teal-400', lightColor: 'bg-teal-50', textColor: 'text-teal-700' },
            { name: 'Lernatelier', color: 'bg-gray-400', lightColor: 'bg-gray-50', textColor: 'text-gray-700' },
            { name: 'Individuelle Vertiefung', color: 'bg-cyan-400', lightColor: 'bg-cyan-50', textColor: 'text-cyan-700' },
            { name: 'Wirtschaft, Arbeit, Haushalt', color: 'bg-amber-400', lightColor: 'bg-amber-50', textColor: 'text-amber-700' }
        ];

        const timeSlots = [
            { id: 1, time: '07:30 - 08:15', name: 'Lektion 1' },
            { id: 2, time: '08:20 - 09:05', name: 'Lektion 2' },
            { id: 3, time: '09:10 - 09:55', name: 'Lektion 3' },
            { id: 4, time: '10:20 - 11:05', name: 'Lektion 4' },
            { id: 5, time: '11:10 - 11:55', name: 'Lektion 5' },
            { id: 6, time: '12:10 - 12:55', name: 'Lektion 6' },
            { id: 7, time: '13:00 - 13:45', name: 'Lektion 7' },
            { id: 8, time: '13:50 - 14:35', name: 'Lektion 8' },
            { id: 9, time: '14:40 - 15:25', name: 'Lektion 9' },
            { id: 10, time: '15:40 - 16:25', name: 'Lektion 10' },
            { id: 11, time: '16:30 - 17:15', name: 'Lektion 11' }
        ];

        const weekDays = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];

        // --- Firebase Initialization ---
        window.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            hideLoadingScreen();
        });

        async function initializeFirebase() {
            try {
                onAuthStateChanged(auth, async (firebaseUser) => {
                    user = firebaseUser;
                    console.log("Authentication state changed. User:", user);
                    if (user) {
                        userId = user.uid;
                        console.log("Logged-in user ID:", userId);
                        // Check if the user is a SuS account
                        const susDoc = await getFirestoreDoc(db, 'susAccounts', userId);
                        if (susDoc.exists()) {
                            showMainApp();
                            await loadUserData();
                        } else {
                            // If not a SuS account, log out and show login screen
                            await signOut(auth);
                            showLoginScreen();
                            showCustomMessage('Dieser Account ist kein Sch√ºler/innen-Account. Bitte melden Sie sich mit einem g√ºltigen SuS-Account an.', 'error', 'Zugriff verweigert');
                        }
                    } else {
                        showLoginScreen();
                    }
                    isAuthReady = true;
                });

                initializeEventListeners();
                generateStudentTimetableTable(); // Generate the table structure
            } catch (error) {
                console.error('Critical error during Firebase initialization:', error);
                showCustomMessage('A critical error occurred during Firebase initialization: ' + error.message, 'error', 'Initialization Error');
                showLoginScreen();
            }
        }

        // Helper to get a Firestore document (used for checking SuS account type)
        async function getFirestoreDoc(dbInstance, collectionName, docId) {
            return await new Promise((resolve, reject) => {
                const unsubscribe = onSnapshot(doc(dbInstance, collectionName, docId), (docSnapshot) => {
                    unsubscribe(); // Unsubscribe immediately after first snapshot
                    resolve(docSnapshot);
                }, (error) => {
                    reject(error);
                });
            });
        }

        // --- UI State Management ---
        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = user ? user.email : 'Gast';
            switchTab(activeTab);
        }

        function switchTab(tabName) {
            activeTab = tabName;

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add('border-blue-500', 'text-blue-600');
                    button.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    button.classList.remove('border-blue-500', 'text-blue-600');
                    button.classList.add('border-transparent', 'text-gray-500');
                }
            });

            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + '-content').classList.remove('hidden');

            if (tabName === 'tasks') {
                updateTasksDisplay();
            } else if (tabName === 'timetable') {
                updateStudentTimetableDisplay();
            }
        }

        // --- Custom Modals ---
        function showCustomMessage(message, type = 'info', title = 'Nachricht') {
            const modal = document.getElementById('customMessageModal');
            document.getElementById('customMessageTitle').textContent = title;
            document.getElementById('customMessageContent').textContent = message;
            modal.classList.remove('hidden');
        }

        function hideCustomMessage() {
            document.getElementById('customMessageModal').classList.add('hidden');
        }

        document.getElementById('customMessageCloseButton').addEventListener('click', hideCustomMessage);

        function showCustomConfirm(message, callback, title = 'Best√§tigen') {
            const modal = document.getElementById('customConfirmModal');
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmContent').textContent = message;
            modal.classList.remove('hidden');

            const okButton = document.getElementById('customConfirmOkButton');
            const cancelButton = document.getElementById('customConfirmCancelButton');

            okButton.onclick = null;
            cancelButton.onclick = null;

            okButton.onclick = () => {
                modal.classList.add('hidden');
                callback(true);
            };
            cancelButton.onclick = () => {
                modal.classList.add('hidden');
                callback(false);
            };
        }

        // --- Event Listeners ---
        function initializeEventListeners() {
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });

            document.getElementById('logoutButton').addEventListener('click', handleLogout);

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Student Plan Modal Event Listeners
            document.getElementById('studentPlanForm').addEventListener('submit', handleSaveStudentPlanEntry);
            document.getElementById('studentPlanCancelButton').addEventListener('click', hideStudentPlanEditModal);
            document.getElementById('studentPlanDeleteButton').addEventListener('click', handleDeleteStudentPlanEntry);
        }

        // --- Authentication Handlers ---
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');

            if (!email || !password) {
                showCustomMessage('Bitte E-Mail und Passwort eingeben.', 'warning', 'Eingabe erforderlich');
                return;
            }

            button.disabled = true;
            button.textContent = 'Anmelden...';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const loggedInUserId = userCredential.user.uid;

                // Verify if the user is a SuS account
                const susDoc = await getFirestoreDoc(db, 'susAccounts', loggedInUserId);
                if (!susDoc.exists()) {
                    await signOut(auth); // Log out if not a SuS account
                    showCustomMessage('Dieser Account ist kein Sch√ºler/innen-Account. Bitte melden Sie sich mit einem g√ºltigen SuS-Account an.', 'error', 'Zugriff verweigert');
                }
                // onAuthStateChanged will handle showing main app if successful and is SuS
            } catch (error) {
                console.error("Login failed:", error);
                showCustomMessage('Login fehlgeschlagen: ' + error.message, 'error', 'Login Fehler');
            } finally {
                button.disabled = false;
                button.textContent = 'Anmelden';
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // No need to switch tab, onAuthStateChanged will handle showing login screen
            } catch (error) {
                console.error("Error logging out:", error);
                showCustomMessage("Error logging out: " + error.message, 'error', 'Logout Error');
            }
        }

        // --- Load Data from Firestore ---
        async function loadUserData() {
            if (!isAuthReady || !user) {
                console.warn("Authentication not ready or no user, skipping data load.");
                return;
            }

            // Listen to annualTimetable (public data)
            onSnapshot(doc(db, 'public_data', 'annualTimetable'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    timetable = docSnapshot.data();
                    updateStudentTimetableDisplay();
                } else {
                    timetable = {};
                    updateStudentTimetableDisplay();
                }
            }, (error) => {
                console.error("Error fetching annual timetable:", error);
                showCustomMessage("Error loading annual timetable: " + error.message, 'error', 'Loading Error');
            });

            // Listen to enabledSolSubjects (public data)
            onSnapshot(doc(db, 'public_data', 'enabledSolSubjects'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    solSubjects = docSnapshot.data().subjects || [];
                    updateStudentTimetableDisplay(); // Update timetable if SOL subjects change
                    updateTasksDisplay(); // Update tasks display as it depends on SOL subjects
                } else {
                    solSubjects = [];
                    updateStudentTimetableDisplay();
                    updateTasksDisplay();
                }
            }, (error) => {
                console.error("Error fetching SOL subjects:", error);
                showCustomMessage("Error loading SOL subjects: " + error.message, 'error', 'Loading Error');
            });

            // Listen to weeklyTasks (public data)
            onSnapshot(collection(db, 'weeklyTasks'), (querySnapshot) => {
                weeklyTasks = [];
                querySnapshot.forEach((doc) => {
                    weeklyTasks.push({ id: doc.id, ...doc.data() });
                });
                console.log("Weekly tasks loaded:", weeklyTasks);
                updateTasksDisplay();
            }, (error) => {
                console.error("Error fetching weekly tasks:", error);
                showCustomMessage("Error loading weekly tasks: " + error.message, 'error', 'Loading Error');
            });

            // Listen to student's personal weekly plans
            onSnapshot(collection(db, `studentWeeklyPlans/${userId}/plans`), (querySnapshot) => {
                studentWeeklyPlans = {};
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const key = `${data.day}_${data.slotId}`;
                    studentWeeklyPlans[key] = { id: doc.id, ...data };
                });
                console.log("Student weekly plans loaded:", studentWeeklyPlans);
                updateStudentTimetableDisplay();
            }, (error) => {
                console.error("Error fetching student weekly plans:", error);
                showCustomMessage("Error loading your weekly plan: " + error.message, 'error', 'Loading Error');
            });
        }

        // --- Tasks Tab (Auftr√§ge der Woche) ---
        function updateTasksDisplay() {
            const tasksContainer = document.getElementById('weeklyTasksContainer');
            const noTasksMessage = document.getElementById('noTasksMessage');
            tasksContainer.innerHTML = ''; // Clear existing tasks

            if (solSubjects.length === 0) {
                noTasksMessage.classList.remove('hidden');
                tasksContainer.classList.add('hidden'); // Hide the grid if no SOL subjects
                return;
            } else {
                noTasksMessage.classList.add('hidden');
                tasksContainer.classList.remove('hidden'); // Show the grid
            }

            // Group tasks by subject
            const tasksBySubject = {};
            solSubjects.forEach(solSubjectName => {
                tasksBySubject[solSubjectName] = weeklyTasks.filter(task => task.subject === solSubjectName);
            });

            // Render columns for each SOL subject
            solSubjects.forEach(solSubjectName => {
                const subjectData = subjects.find(s => s.name === solSubjectName);
                const cardBgColor = subjectData?.lightColor || 'bg-gray-100';
                const cardTextColor = subjectData?.textColor || 'text-gray-900';
                const borderColor = subjectData?.color || 'border-gray-200';

                const subjectColumn = document.createElement('div');
                subjectColumn.className = `bg-white rounded-xl shadow-lg p-4 border-t-4 ${borderColor}`;

                subjectColumn.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold ${cardTextColor}">${solSubjectName}</h3>
                    </div>
                    <div class="tasks-list space-y-4">
                        <!-- Tasks for this subject will go here -->
                    </div>
                `;

                const tasksList = subjectColumn.querySelector('.tasks-list');
                const filteredTasks = tasksBySubject[solSubjectName];

                if (filteredTasks.length === 0) {
                    const noTasksInColumn = document.createElement('p');
                    noTasksInColumn.className = `text-sm text-gray-500 italic text-center p-4 ${cardTextColor}`;
                    noTasksInColumn.textContent = 'Noch keine Aufgaben f√ºr dieses Fach.';
                    tasksList.appendChild(noTasksInColumn);
                } else {
                    filteredTasks.forEach(task => {
                        const isCompleted = task.completedBy && task.completedBy[userId];
                        const completedClass = isCompleted ? 'opacity-60 border-green-500' : '';
                        const checkboxChecked = isCompleted ? 'checked' : '';

                        const taskCard = document.createElement('div');
                        taskCard.className = `bg-white rounded-lg shadow-sm p-4 relative border-l-2 ${borderColor} ${completedClass}`;
                        taskCard.setAttribute('data-task-id', task.id);

                        const materialsHtml = task.materials ?
                            task.materials.split('\n').map(line => {
                                try {
                                    const url = new URL(line.trim());
                                    return `<a href="${url.href}" target="_blank" class="text-blue-600 hover:underline block">${line.trim()}</a>`;
                                } catch (_) {
                                    return `<span>${line.trim()}</span>`;
                                }
                            }).join('<br>') : '';

                        taskCard.innerHTML = `
                            <div class="absolute top-2 right-2 text-2xl ${cardTextColor}">
                                ${task.requirementType === 'basic' ? 'üîµ' : '‚≠ê'}
                            </div>
                            <h4 class="text-md font-semibold mb-1 ${cardTextColor}">${task.title}</h4>
                            ${materialsHtml ? `<p class="${cardTextColor} text-sm mb-4 whitespace-pre-wrap">${materialsHtml}</p>` : ''}
                            <div class="flex items-center mt-4">
                                <input type="checkbox" id="task-complete-${task.id}" data-task-id="${task.id}" class="h-5 w-5 text-green-600 rounded focus:ring-green-500 border-gray-300" ${checkboxChecked}>
                                <label for="task-complete-${task.id}" class="ml-2 text-base font-medium text-gray-700">Erledigt</label>
                            </div>
                        `;

                        const checkbox = taskCard.querySelector(`#task-complete-${task.id}`);
                        checkbox.addEventListener('change', (event) => {
                            toggleTaskCompletion(task.id, event.target.checked);
                        });

                        tasksList.appendChild(taskCard);
                    });
                }
                tasksContainer.appendChild(subjectColumn);
            });
        }

        async function toggleTaskCompletion(taskId, isCompleted) {
            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um Aufgaben als erledigt zu markieren.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            const taskRef = doc(db, 'weeklyTasks', taskId);
            const updateData = {};
            // Use dot notation to update map field for the specific user
            updateData[`completedBy.${userId}`] = isCompleted;

            try {
                await setDoc(taskRef, updateData, { merge: true });
                // The onSnapshot listener for 'weeklyTasks' will automatically re-render the display
                // showCustomMessage(`Aufgabe als ${isCompleted ? 'erledigt' : 'unerledigt'} markiert.`, 'success', 'Status aktualisiert');
            } catch (error) {
                console.error("Error updating task completion status:", error);
                showCustomMessage("Fehler beim Aktualisieren des Aufgabenstatus: " + error.message, 'error', 'Fehler');
            }
        }

        // --- Timetable Tab (Mein Stundenplan) ---
        function generateStudentTimetableTable() {
            const tbody = document.getElementById('studentTimetableBody');
            tbody.innerHTML = '';

            timeSlots.forEach(slot => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const timeCell = document.createElement('td');
                timeCell.className = 'px-4 py-2 border-b font-medium text-sm text-gray-700';
                timeCell.textContent = slot.time;
                row.appendChild(timeCell);

                weekDays.forEach(day => {
                    const cell = document.createElement('td');
                    cell.className = 'px-2 py-2 border-b text-center text-sm relative';
                    cell.setAttribute('data-day', day);
                    cell.setAttribute('data-slot', slot.id.toString());
                    
                    // Add click listener only if it's an SOL lesson
                    // The actual content and clickability based on SOL status will be handled by updateStudentTimetableDisplay
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
        }

        function updateStudentTimetableDisplay() {
            const tbody = document.getElementById('studentTimetableBody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach((row, i) => {
                const slot = timeSlots[i];
                const cells = row.querySelectorAll('td');

                weekDays.forEach((day, j) => {
                    const cell = cells[j + 1]; // +1 to skip the time cell
                    cell.innerHTML = ''; // Clear existing content
                    cell.className = `px-2 py-2 border-b text-center text-sm relative`; // Reset classes

                    const annualSubject = timetable[day] && timetable[day][slot.id] ? timetable[day][slot.id] : '';
                    const isSolSubject = solSubjects.includes(annualSubject);
                    const studentPlanKey = `${day}_${slot.id}`;
                    const studentEntry = studentWeeklyPlans[studentPlanKey];

                    if (studentEntry) {
                        // Student has a custom plan for this slot
                        const subjectData = subjects.find(s => s.name === studentEntry.subjectName);
                        const cellBgColor = subjectData?.lightColor || 'bg-blue-50';
                        const cellTextColor = subjectData?.textColor || 'text-blue-700';

                        cell.classList.add(cellBgColor, cellTextColor, 'cursor-pointer');
                        cell.innerHTML = `
                            <div class="font-semibold">${studentEntry.title}</div>
                            ${studentEntry.description ? `<div class="text-xs">${studentEntry.description}</div>` : ''}
                        `;
                        cell.onclick = () => showStudentPlanEditModal(day, slot.id, studentEntry);

                    } else if (annualSubject && isSolSubject) {
                        // It's an SOL lesson from the annual timetable, and no personal plan yet
                        cell.classList.add('bg-green-100', 'text-green-800', 'cursor-pointer');
                        // Removed the annualSubject from display for SOL lessons
                        cell.innerHTML = `<span class="font-medium">SOL</span>`;
                        cell.onclick = () => showStudentPlanEditModal(day, slot.id);

                    } else if (annualSubject && !isSolSubject) {
                        // Regular (non-SOL) subject from annual timetable
                        const subjectData = subjects.find(s => s.name === annualSubject);
                        const cellBgColor = subjectData?.color || 'bg-gray-200';
                        const cellTextColor = ['bg-red-400', 'bg-blue-400', 'bg-purple-400', 'bg-green-400', 'bg-orange-400',
                                             'bg-pink-400', 'bg-red-500', 'bg-indigo-400', 'bg-violet-400', 'bg-cyan-400',
                                             'bg-amber-400', 'bg-gray-400'].includes(cellBgColor) ? 'text-white' : 'text-gray-900';

                        cell.classList.add(cellBgColor, cellTextColor);
                        cell.textContent = annualSubject;
                        cell.onclick = null; // Not clickable for regular lessons

                    } else {
                        // Free slot
                        cell.classList.add('bg-white', 'text-gray-400', 'italic');
                        cell.textContent = 'Frei';
                        cell.onclick = null;
                    }
                });
            });
        }

        function showStudentPlanEditModal(day, slotId, entry = null) {
            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um Ihren Stundenplan zu bearbeiten.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            const modal = document.getElementById('studentPlanEditModal');
            const form = document.getElementById('studentPlanForm');
            const subjectSelect = document.getElementById('studentPlanSubject');
            const timeSlotInput = document.getElementById('studentPlanTimeSlot');
            const titleInput = document.getElementById('studentPlanTitle');
            const descriptionInput = document.getElementById('studentPlanDescription');
            const deleteButton = document.getElementById('studentPlanDeleteButton');

            currentStudentPlanEntry = entry; // Set global current entry

            const slot = timeSlots.find(s => s.id === slotId);

            // Populate subject select with ONLY SOL subjects
            subjectSelect.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Fach ausw√§hlen';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            subjectSelect.appendChild(defaultOption);

            // Populate with only SOL subjects
            solSubjects.forEach(solSubjName => {
                const option = document.createElement('option');
                option.value = solSubjName;
                option.textContent = solSubjName;
                subjectSelect.appendChild(option);
            });

            timeSlotInput.value = `${day}, ${slot.time}`;

            if (entry) {
                document.getElementById('studentPlanModalTitle').textContent = 'Eintrag bearbeiten';
                subjectSelect.value = entry.subjectName || '';
                titleInput.value = entry.title || '';
                descriptionInput.value = entry.description || '';
                deleteButton.classList.remove('hidden');
                form.dataset.entryId = entry.id;
            } else {
                document.getElementById('studentPlanModalTitle').textContent = 'SOL-Lektion planen';
                form.reset();
                titleInput.value = ''; // Clear title for new entries
                descriptionInput.value = ''; // Clear description for new entries
                deleteButton.classList.add('hidden');
                form.dataset.entryId = '';
            }

            // Always enable subject selection for students
            subjectSelect.disabled = false;
            subjectSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');

            form.dataset.day = day;
            form.dataset.slotId = slotId;

            modal.classList.remove('hidden');
        }

        function hideStudentPlanEditModal() {
            document.getElementById('studentPlanEditModal').classList.add('hidden');
            document.getElementById('studentPlanForm').reset();
            currentStudentPlanEntry = null;
            // Re-enable subject select and remove disabled styling
            const subjectSelect = document.getElementById('studentPlanSubject');
            subjectSelect.disabled = false;
            subjectSelect.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }

        async function handleSaveStudentPlanEntry(event) {
            event.preventDefault();

            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um Ihren Stundenplan zu speichern.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            const form = document.getElementById('studentPlanForm');
            const day = form.dataset.day;
            const slotId = parseInt(form.dataset.slotId);
            const subjectName = document.getElementById('studentPlanSubject').value;
            const title = document.getElementById('studentPlanTitle').value.trim();
            const description = document.getElementById('studentPlanDescription').value.trim();

            if (!subjectName || !title) {
                showCustomMessage('Bitte Fach und Titel eingeben.', 'warning', 'Eingabe erforderlich');
                return;
            }

            const saveButton = document.getElementById('studentPlanSaveButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Speichern...';

            try {
                const entryData = {
                    day: day,
                    slotId: slotId,
                    subjectName: subjectName,
                    title: title,
                    description: description,
                    createdBy: user.email, // Store student's email
                    createdAt: currentStudentPlanEntry?.createdAt || new Date().toISOString()
                };

                const entryId = currentStudentPlanEntry ? currentStudentPlanEntry.id : `${day}_${slotId}`;
                // Save to student-specific subcollection
                await setDoc(doc(db, `studentWeeklyPlans/${userId}/plans`, entryId), entryData);

                showCustomMessage('Dein Stundenplan-Eintrag wurde erfolgreich gespeichert!', 'success', 'Erfolg');
                hideStudentPlanEditModal();
            } catch (error) {
                console.error("Error saving student plan entry:", error);
                showCustomMessage('Fehler beim Speichern deines Stundenplan-Eintrags: ' + error.message, 'error', 'Speicherfehler');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Speichern';
            }
        }

        async function handleDeleteStudentPlanEntry() {
            const form = document.getElementById('studentPlanForm');
            const entryIdToDelete = form.dataset.entryId;

            if (!isAuthReady || !user || !entryIdToDelete) {
                showCustomMessage("Kein Eintrag zum L√∂schen ausgew√§hlt oder keine Berechtigung.", 'warning', 'Fehler');
                return;
            }

            showCustomConfirm('Bist du sicher, dass du diesen Stundenplan-Eintrag l√∂schen m√∂chtest? Dies kann nicht r√ºckg√§ngig gemacht werden.', async (confirmed) => {
                if (confirmed) {
                    const deleteButton = document.getElementById('studentPlanDeleteButton');
                    deleteButton.disabled = true;
                    deleteButton.textContent = 'L√∂schen...';

                    try {
                        // Delete from student-specific subcollection
                        await deleteDoc(doc(db, `studentWeeklyPlans/${userId}/plans`, entryIdToDelete));
                        showCustomMessage('Stundenplan-Eintrag erfolgreich gel√∂scht!', 'success', 'Gel√∂scht');
                        hideStudentPlanEditModal();
                    } catch (error) {
                        console.error("Error deleting student plan entry:", error);
                        showCustomMessage('Fehler beim L√∂schen deines Stundenplan-Eintrags: ' + error.message, 'error', 'L√∂schfehler');
                    } finally {
                        deleteButton.disabled = false;
                        deleteButton.textContent = 'L√∂schen';
                    }
                }
            }, 'Eintrag l√∂schen');
        }

    </script>
</body>
</html>

