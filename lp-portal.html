<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL Lehrpersonen Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modals */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md text-center">
            <div class="w-12 h-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Firebase wird geladen...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h1 class="text-2xl font-bold text-center mb-6">SOL Portal Login</h1>
            <div>
                <div class="mb-4">
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
                    <input type="email" id="loginEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Passwort</label>
                    <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                </div>
                <button id="loginButton" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50">
                    Anmelden
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="min-h-screen hidden">
        <div class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-gray-900">SOL Lehrpersonen Portal</h1>
                    <div class="flex items-center space-x-4">
                        <span id="userEmail" class="text-sm text-gray-600"></span>
                        <button id="logoutButton" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900">
                            <span>Abmelden</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="bg-white rounded-lg shadow">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button data-tab="stundenplan" class="tab-button py-4 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                            üìÖ Stundenplan der Woche
                        </button>
                        <button data-tab="arbeitsplan" class="tab-button py-4 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                            üìã Arbeitsplan der Woche
                        </button>
                        <button data-tab="verwaltung" class="tab-button py-4 px-2 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                            ‚öôÔ∏è Verwaltung
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <div id="stundenplan-content" class="tab-content hidden">
                        <h2 class="text-xl font-semibold mb-4">Stundenplan der Woche</h2>
                        <p class="text-gray-600">Hier k√∂nnen Sie SOL-Lektionen blockieren und verwalten.</p>
                        <div class="mt-4 text-center text-gray-500">
                            <div class="text-5xl mb-2">üìÖ</div>
                            <p>Stundenplan-Funktionalit√§t wird nach Vervollst√§ndigung der Verwaltung implementiert.</p>
                        </div>
                    </div>

                    <div id="arbeitsplan-content" class="tab-content hidden">
                        <h2 class="text-xl font-semibold mb-4">Arbeitsplan der Woche</h2>
                        <p class="text-gray-600">Digitale Pinwand f√ºr Auftr√§ge und Fortschritts√ºbersicht.</p>
                        <div class="mt-4 text-center text-gray-500">
                            <div class="text-5xl mb-2">üìã</div>
                            <p>Arbeitsplan-Funktionalit√§t wird nach Vervollst√§ndigung der Verwaltung implementiert.</p>
                        </div>
                    </div>

                    <div id="verwaltung-content" class="tab-content">
                        <div class="space-y-8">
                            <div>
                                <h2 class="text-xl font-semibold mb-4">Verwaltung</h2>
                            </div>

                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h3 class="text-lg font-medium mb-4">Jahresstundenplan</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white border border-gray-200 rounded-md">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="px-4 py-2 border-b text-left font-medium text-gray-700 rounded-tl-md">Zeit</th>
                                                <th class="px-4 py-2 border-b text-center font-medium text-gray-700">Montag</th>
                                                <th class="px-4 py-2 border-b text-center font-medium text-gray-700">Dienstag</th>
                                                <th class="px-4 py-2 border-b text-center font-medium text-gray-700">Mittwoch</th>
                                                <th class="px-4 py-2 border-b text-center font-medium text-gray-700">Donnerstag</th>
                                                <th class="px-4 py-2 border-b text-center font-medium text-gray-700">Freitag</th>
                                            </tr>
                                        </thead>
                                        <tbody id="timetableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h3 class="text-lg font-medium mb-4">SOL-F√§cher definieren</h3>
                                <p class="text-sm text-gray-600 mb-4">W√§hlen Sie aus, welche F√§cher als SOL-Lektionen angeboten werden sollen.</p>
                                <div id="solSubjectsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                </div>
                            </div>

                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h3 class="text-lg font-medium mb-4">Account-Verwaltung</h3>

                                <div class="mb-6">
                                    <h4 class="font-medium mb-3">Neuen Account erstellen</h4>
                                    <div class="flex flex-wrap gap-3 items-end">
                                        <div class="flex-1 min-w-[180px]">
                                            <label for="newAccountEmail" class="sr-only">E-Mail-Adresse</label>
                                            <input type="email" id="newAccountEmail" placeholder="E-Mail-Adresse" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                        <div class="flex-1 min-w-[180px]">
                                            <label for="newAccountPassword" class="sr-only">Passwort</label>
                                            <input type="password" id="newAccountPassword" placeholder="Passwort" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                        </div>
                                        <select id="newAccountType" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="LP">Lehrperson</option>
                                            <option value="SuS">Sch√ºler/in</option>
                                        </select>
                                        <button id="createAccountButton" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 disabled:opacity-50 flex items-center justify-center">
                                            ‚ûï Erstellen
                                        </button>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <h4 class="font-medium mb-3 flex items-center">
                                        üë• Lehrpersonen-Accounts (<span id="lpAccountCount">0</span>)
                                    </h4>
                                    <div id="lpAccountsList" class="bg-white rounded border">
                                        <p class="p-4 text-gray-500 text-center">Noch keine LP-Accounts erstellt.</p>
                                    </div>
                                </div>

                                <div>
                                    <h4 class="font-medium mb-3 flex items-center">
                                        üë• Sch√ºler/innen-Accounts (<span id="susAccountCount">0</span>)
                                    </h4>
                                    <div id="susAccountsList" class="bg-white rounded border">
                                        <p class="p-4 text-gray-500 text-center">Noch keine SuS-Accounts erstellt.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="customMessageModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 id="customMessageTitle" class="text-lg font-semibold mb-4 text-gray-900"></h3>
            <p id="customMessageContent" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="customMessageCloseButton" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 id="customConfirmTitle" class="text-lg font-semibold mb-4 text-gray-900">Best√§tigung</h3>
            <p id="customConfirmContent" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="customConfirmCancelButton" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">Abbrechen</button>
                <button id="customConfirmOkButton" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">L√∂schen</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app;
        let auth;
        let db;
        let user = null; // Firebase user object
        let userId = null; // User ID (UID)
        let isAuthReady = false; // Flag to ensure Firestore operations wait for auth

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let activeTab = 'verwaltung';
        let timetable = {};
        let solSubjects = [];
        let lpAccounts = [];
        let susAccounts = [];

        const subjects = [
            { name: 'Deutsch', color: 'bg-red-500' },
            { name: 'Englisch', color: 'bg-blue-500' },
            { name: 'Franzoesisch', color: 'bg-purple-500' },
            { name: 'Mathematik', color: 'bg-green-500' },
            { name: 'Natur und Technik', color: 'bg-yellow-500' },
            { name: 'NT / MI', color: 'bg-yellow-400' },
            { name: 'Raeume Zeiten Gesellschaften', color: 'bg-orange-500' },
            { name: 'Ethik Religion Gemeinschaft', color: 'bg-pink-500' },
            { name: 'Bewegung und Sport', color: 'bg-red-600' },
            { name: 'Textiles und Technisches Gestalten', color: 'bg-indigo-500' },
            { name: 'Musik', color: 'bg-violet-500' },
            { name: 'Bildnerisches Gestalten', color: 'bg-teal-500' },
            { name: 'Lernatelier', color: 'bg-gray-500' },
            { name: 'Individuelle Vertiefung', color: 'bg-cyan-500' }
        ];

        const timeSlots = [
            { id: 1, time: '07:30 - 08:15', name: 'Lektion 1' },
            { id: 2, time: '08:20 - 09:05', name: 'Lektion 2' },
            { id: 3, time: '09:25 - 10:10', name: 'Lektion 3' },
            { id: 4, time: '10:15 - 11:00', name: 'Lektion 4' },
            { id: 5, time: '11:05 - 11:50', name: 'Lektion 5' },
            { id: 6, time: '13:15 - 14:00', name: 'Lektion 6' },
            { id: 7, time: '14:05 - 14:50', name: 'Lektion 7' },
            { id: 8, time: '15:05 - 15:50', name: 'Lektion 8' },
            { id: 9, time: '15:55 - 16:40', name: 'Lektion 9' }
        ];

        const weekDays = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];

        // Helper to get a Firestore document (used for checking account type)
        async function getFirestoreDoc(dbInstance, collectionName, docId) {
            return await new Promise((resolve, reject) => {
                const unsubscribe = onSnapshot(doc(dbInstance, collectionName, docId), (docSnapshot) => {
                    unsubscribe(); // Unsubscribe immediately after first snapshot
                    resolve(docSnapshot);
                }, (error) => {
                    reject(error);
                });
            });
        }

        // --- Firebase Initialization ---
        window.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        async function initializeFirebase() {
            try {
                // Log Firebase config and token for debugging in Canvas
                console.log("Firebase Config:", firebaseConfig);
                console.log("Initial Auth Token:", initialAuthToken);

                if (!firebaseConfig) {
                    showCustomMessage("Firebase Konfiguration nicht gefunden. Die App kann nicht gestartet werden.", 'error', 'Fehler');
                    hideLoadingScreen();
                    return;
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Use a Promise to wait for the initial auth state to be ready
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
                        user = firebaseUser;
                        if (user) {
                            userId = user.uid; // Set userId from authenticated user
                            console.log("Logged-in user ID:", userId);

                            // Check if the user is an LP account
                            const lpDoc = await getFirestoreDoc(db, 'artifacts', appId, 'public', 'data', 'lpAccounts', userId);
                            if (lpDoc.exists()) {
                                showMainApp();
                                await loadUserData(); // Load data after user is authenticated
                            } else {
                                // If not an LP account, log out and show login screen
                                await signOut(auth);
                                showLoginScreen();
                                showCustomMessage('Dieser Account ist kein Lehrpersonen-Account. Bitte melden Sie sich mit einem g√ºltigen LP-Account an.', 'error', 'Zugriff verweigert');
                            }
                        } else {
                            // If no user, try to sign in anonymously if no initial token
                            if (initialAuthToken) {
                                try {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } catch (error) {
                                    console.error("Error signing in with custom token:", error);
                                    // Fallback to anonymous sign-in if custom token fails
                                    await signInAnonymously(auth);
                                }
                            } else {
                                // If no custom token and no user, sign in anonymously
                                await signInAnonymously(auth);
                            }
                            showLoginScreen();
                        }
                        isAuthReady = true; // Auth state is ready
                        hideLoadingScreen(); // Hide loading screen once auth state is processed
                        unsubscribe(); // Unsubscribe after the first state change
                        resolve(); // Resolve the promise
                    });
                });

                // These should only run after auth state is determined and loading screen is hidden
                initializeEventListeners();
                generateTimetable();
                generateSolSubjectsGrid();

            } catch (error) {
                console.error('Fehler bei Firebase-Initialisierung:', error);
                showCustomMessage('Firebase-Initialisierung fehlgeschlagen: ' + error.message, 'error', 'Initialisierungsfehler');
                hideLoadingScreen(); // Ensure loading screen is hidden on error
            }
        }

        // --- UI State Management ---
        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = user ? user.email : 'Gast';
            switchTab(activeTab); // Ensure the correct tab is shown on login
        }

        function switchTab(tabName) {
            activeTab = tabName;

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add('border-blue-500', 'text-blue-600');
                    button.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    button.classList.remove('border-blue-500', 'text-blue-600');
                    button.classList.add('border-transparent', 'text-gray-500');
                }
            });

            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + '-content').classList.remove('hidden');
        }

        // --- Custom Modals ---
        function showCustomMessage(message, type = 'info', title = 'Nachricht') {
            const modal = document.getElementById('customMessageModal');
            document.getElementById('customMessageTitle').textContent = title;
            document.getElementById('customMessageContent').textContent = message;
            modal.classList.remove('hidden');
        }

        function hideCustomMessage() {
            document.getElementById('customMessageModal').classList.add('hidden');
        }

        document.getElementById('customMessageCloseButton').addEventListener('click', hideCustomMessage);

        function showCustomConfirm(message, callback, title = 'Best√§tigen') {
            const modal = document.getElementById('customConfirmModal');
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmContent').textContent = message;
            modal.classList.remove('hidden');

            const okButton = document.getElementById('customConfirmOkButton');
            const cancelButton = document.getElementById('customConfirmCancelButton');

            // Clear previous listeners to prevent multiple calls
            okButton.onclick = null;
            cancelButton.onclick = null;

            okButton.onclick = () => {
                modal.classList.add('hidden');
                callback(true);
            };
            cancelButton.onclick = () => {
                modal.classList.add('hidden');
                callback(false);
            };
        }

        // --- Event Listeners ---
        function initializeEventListeners() {
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });

            document.getElementById('logoutButton').addEventListener('click', handleLogout);

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            document.getElementById('createAccountButton').addEventListener('click', handleCreateAccount);
        }

        // --- Authentication Handlers ---
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');

            if (!email || !password) {
                showCustomMessage('Bitte E-Mail und Passwort eingeben.', 'warning', 'Eingabe erforderlich');
                return;
            }

            button.disabled = true;
            button.textContent = 'Anmelden...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                showCustomMessage('Login fehlgeschlagen: ' + error.message, 'error', 'Login Fehler');
            } finally {
                button.disabled = false;
                button.textContent = 'Anmelden';
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                activeTab = 'verwaltung'; // Reset tab on logout
                switchTab('verwaltung');
            } catch (error) {
                console.error("Error logging out:", error);
                showCustomMessage("Fehler beim Abmelden: " + error.message, 'error', 'Abmeldefehler');
            }
        }

        // --- Data Loading from Firestore ---
        async function loadUserData() {
            if (!isAuthReady || !userId) {
                console.warn("Auth not ready or user not logged in, skipping data load.");
                return;
            }

            // Timetable: Listen to changes in the 'current' document within the 'timetable' collection
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'timetable', 'current'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    timetable = docSnapshot.data();
                    updateTimetableDisplay();
                } else {
                    timetable = {}; // Reset if no data
                    updateTimetableDisplay();
                }
            }, (error) => {
                console.error("Error fetching timetable:", error);
                showCustomMessage("Fehler beim Laden des Stundenplans: " + error.message, 'error', 'Ladefehler');
            });

            // SOL Subjects: Listen to changes in the 'enabled' document within the 'solSubjects' collection
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'solSubjects', 'enabled'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    solSubjects = docSnapshot.data().subjects || [];
                    updateSolSubjectsDisplay();
                } else {
                    solSubjects = []; // Reset if no data
                    updateSolSubjectsDisplay();
                }
            }, (error) => {
                console.error("Error fetching SOL subjects:", error);
                showCustomMessage("Fehler beim Laden der SOL-F√§cher: " + error.message, 'error', 'Ladefehler');
            });

            // LP Accounts: Listen to changes in the 'lpAccounts' collection
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'lpAccounts'), (querySnapshot) => {
                lpAccounts = [];
                querySnapshot.forEach((doc) => {
                    lpAccounts.push({ id: doc.id, ...doc.data() });
                });
                updateLpAccountsDisplay();
            }, (error) => {
                console.error("Error fetching LP accounts:", error);
                showCustomMessage("Fehler beim Laden der LP-Accounts: " + error.message, 'error', 'Ladefehler');
            });

            // SuS Accounts: Listen to changes in the 'susAccounts' collection
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'susAccounts'), (querySnapshot) => {
                susAccounts = [];
                querySnapshot.forEach((doc) => {
                    susAccounts.push({ id: doc.id, ...doc.data() });
                });
                updateSusAccountsDisplay();
            }, (error) => {
                console.error("Error fetching SuS accounts:", error);
                showCustomMessage("Fehler beim Laden der SuS-Accounts: " + error.message, 'error', 'Ladefehler');
            });
        }

        // --- Timetable Management ---
        function generateTimetable() {
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = ''; // Clear existing rows

            timeSlots.forEach(slot => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                const timeCell = document.createElement('td');
                timeCell.className = 'px-4 py-2 border-b font-medium text-sm text-gray-700';
                timeCell.textContent = slot.time;
                row.appendChild(timeCell);

                weekDays.forEach(day => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-2 border-b';

                    const select = document.createElement('select');
                    select.className = 'w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500';
                    select.setAttribute('data-day', day);
                    select.setAttribute('data-slot', slot.id.toString());
                    select.addEventListener('change', function() {
                        const dayAttr = this.getAttribute('data-day');
                        const slotAttr = parseInt(this.getAttribute('data-slot'));
                        handleTimetableChange(dayAttr, slotAttr, this.value);
                    });

                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Frei';
                    select.appendChild(emptyOption);

                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.name;
                        option.textContent = subject.name;
                        select.appendChild(option);
                    });

                    cell.appendChild(select);

                    const colorBar = document.createElement('div');
                    colorBar.className = 'mt-1 h-2 rounded hidden'; // Hidden by default
                    cell.appendChild(colorBar);

                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
        }

        function updateTimetableDisplay() {
            const tbody = document.getElementById('timetableBody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach((row, i) => {
                const slot = timeSlots[i];
                const cells = row.querySelectorAll('td'); // Includes the time cell

                weekDays.forEach((day, j) => {
                    const cell = cells[j + 1]; // +1 to skip the time cell
                    const select = cell.querySelector('select');
                    const colorBar = cell.querySelector('div');

                    const value = timetable[day] && timetable[day][slot.id] ? timetable[day][slot.id] : '';
                    select.value = value;

                    // Update color bar based on selected subject
                    if (value) {
                        const subject = subjects.find(s => s.name === value);
                        if (subject) {
                            colorBar.className = `mt-1 h-2 rounded ${subject.color}`;
                        }
                    } else {
                        colorBar.className = 'mt-1 h-2 rounded hidden';
                    }
                });
            });
        }

        async function handleTimetableChange(day, slot, subject) {
            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um den Stundenplan zu bearbeiten.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            // Ensure the day object exists in timetable
            if (!timetable[day]) {
                timetable[day] = {};
            }
            timetable[day][slot] = subject;

            try {
                // Use setDoc with merge: true to update only the specific fields
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'timetable', 'current'), timetable, { merge: true });
                // onSnapshot will automatically update the display
            } catch (error) {
                console.error("Error updating timetable:", error);
                showCustomMessage("Fehler beim Speichern des Stundenplans: " + error.message, 'error', 'Speicherfehler');
            }
        }

        // --- SOL Subjects Management ---
        function generateSolSubjectsGrid() {
            const grid = document.getElementById('solSubjectsGrid');
            grid.innerHTML = '';

            subjects.forEach((subject, i) => {
                const div = document.createElement('div');
                div.className = 'flex items-center';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'subject-' + i.toString();
                checkbox.className = 'mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded';
                checkbox.setAttribute('data-subject', subject.name);
                checkbox.addEventListener('change', function() {
                    const subjectName = this.getAttribute('data-subject');
                    handleSolSubjectToggle(subjectName);
                });

                const label = document.createElement('label');
                label.htmlFor = 'subject-' + i.toString();
                label.className = 'flex items-center cursor-pointer';

                const colorBox = document.createElement('div');
                colorBox.className = 'w-4 h-4 rounded mr-2 ' + subject.color;

                const span = document.createElement('span');
                span.className = 'text-sm text-gray-700';
                span.textContent = subject.name;

                label.appendChild(colorBox);
                label.appendChild(span);
                div.appendChild(checkbox);
                div.appendChild(label);
                grid.appendChild(div);
            });
        }

        function updateSolSubjectsDisplay() {
            subjects.forEach((subject, i) => {
                const checkbox = document.getElementById('subject-' + i.toString());
                if (checkbox) {
                    checkbox.checked = solSubjects.includes(subject.name);
                }
            });
        }

        async function handleSolSubjectToggle(subjectName) {
            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um SOL-F√§cher zu bearbeiten.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            const index = solSubjects.indexOf(subjectName);

            if (index !== -1) {
                solSubjects.splice(index, 1); // Remove if exists
            } else {
                solSubjects.push(subjectName); // Add if not exists
            }

            try {
                // Store the array directly in a document
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'solSubjects', 'enabled'), { subjects: solSubjects });
                // onSnapshot will automatically update the display
            } catch (error) {
                console.error("Error updating SOL subjects:", error);
                showCustomMessage("Fehler beim Speichern der SOL-F√§cher: " + error.message, 'error', 'Speicherfehler');
            }
        }

        // --- Account Management ---
        async function handleCreateAccount() {
            const email = document.getElementById('newAccountEmail').value;
            const password = document.getElementById('newAccountPassword').value;
            const type = document.getElementById('newAccountType').value;
            const button = document.getElementById('createAccountButton');

            if (!email || !password) {
                showCustomMessage('Bitte E-Mail und Passwort eingeben.', 'warning', 'Eingabe erforderlich');
                return;
            }

            button.disabled = true;
            button.textContent = 'Erstelle...';

            try {
                // Create user in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUserId = userCredential.user.uid;

                const accountData = {
                    email: email,
                    role: type,
                    createdAt: new Date().toISOString()
                };

                // Store user profile data in Firestore
                const collectionPath = type === 'LP' ? 'lpAccounts' : 'susAccounts';
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionPath, newUserId), accountData);

                // Clear form fields
                document.getElementById('newAccountEmail').value = '';
                document.getElementById('newAccountPassword').value = '';
                document.getElementById('newAccountType').value = 'LP';

                showCustomMessage('Account erfolgreich erstellt!', 'success', 'Erfolg');
            } catch (error) {
                console.error("Error creating account:", error);
                showCustomMessage('Fehler beim Erstellen des Accounts: ' + error.message, 'error', 'Fehler');
            } finally {
                button.disabled = false;
                button.textContent = '‚ûï Erstellen';
            }
        }

        function updateLpAccountsDisplay() {
            const container = document.getElementById('lpAccountsList');
            const countElement = document.getElementById('lpAccountCount');

            countElement.textContent = lpAccounts.length;

            if (lpAccounts.length === 0) {
                container.innerHTML = '<p class="p-4 text-gray-500 text-center">Noch keine LP-Accounts erstellt.</p>';
            } else {
                container.innerHTML = '';
                lpAccounts.forEach(account => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 border-b last:border-b-0';

                    const infoDiv = document.createElement('div');
                    infoDiv.innerHTML = `<span class="font-medium text-gray-900">${account.email}</span>` +
                                        `<span class="ml-2 text-sm text-gray-500">(Erstellt: ${new Date(account.createdAt).toLocaleDateString()})</span>`;

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'text-red-500 hover:text-red-700 p-1 rounded-md hover:bg-red-100 transition-colors';
                    deleteButton.innerHTML = 'üóëÔ∏è';
                    deleteButton.setAttribute('data-id', account.id);
                    deleteButton.addEventListener('click', function() {
                        handleDeleteAccount(this.getAttribute('data-id'), 'LP'); // Corrected type to 'LP'
                    });

                    div.appendChild(infoDiv);
                    div.appendChild(deleteButton);
                    container.appendChild(div);
                });
            }
        }

        function updateSusAccountsDisplay() {
            const container = document.getElementById('susAccountsList');
            const countElement = document.getElementById('susAccountCount');

            countElement.textContent = susAccounts.length;

            if (susAccounts.length === 0) {
                container.innerHTML = '<p class="p-4 text-gray-500 text-center">Noch keine SuS-Accounts erstellt.</p>';
            } else {
                container.innerHTML = '';
                susAccounts.forEach(account => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 border-b last:border-b-0';

                    const infoDiv = document.createElement('div');
                    infoDiv.innerHTML = `<span class="font-medium text-gray-900">${account.email}</span>` +
                                        `<span class="ml-2 text-sm text-gray-500">(Erstellt: ${new Date(account.createdAt).toLocaleDateString()})</span>`;

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'text-red-500 hover:text-red-700 p-1 rounded-md hover:bg-red-100 transition-colors';
                    deleteButton.innerHTML = 'üóëÔ∏è';
                    deleteButton.setAttribute('data-id', account.id);
                    deleteButton.addEventListener('click', function() {
                        handleDeleteAccount(this.getAttribute('data-id'), 'SuS');
                    });

                    div.appendChild(infoDiv);
                    div.appendChild(deleteButton);
                    container.appendChild(div);
                });
            }
        }

        function handleDeleteAccount(accountId, type) {
            showCustomConfirm('Sind Sie sicher, dass Sie diesen Account l√∂schen m√∂chten? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.', async (confirmed) => {
                if (confirmed) {
                    try {
                        const collectionPath = type === 'LP' ? 'lpAccounts' : 'susAccounts';
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionPath, accountId));
                        showCustomMessage('Account erfolgreich gel√∂scht.', 'success', 'Gel√∂scht');
                    } catch (error) {
                        console.error("Error deleting account:", error);
                        showCustomMessage('Fehler beim L√∂schen des Accounts: ' + error.message, 'error', 'L√∂schfehler');
                    }
                }
            }, 'Account l√∂schen');
        }
    </script>
</body>
</html>
