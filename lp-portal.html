<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL Lehrpersonen Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for modals */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom button styling for a modern look */
        .modern-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .modern-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .task-list-item {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .task-list-item:hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- Haupt-Container für Login und App -->
    <div class="w-full max-w-4xl p-6 md:p-10 bg-white rounded-lg shadow-xl">

        <!-- Login-Container -->
        <div id="login-container" class="flex flex-col items-center justify-center p-6">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">Willkommen im LP Portal</h1>
            <p class="text-gray-600 mb-8 text-center">Bitte melden Sie sich mit Ihrem Lehrperson-Konto an.</p>
            <form id="login-form" class="w-full max-w-md bg-gray-100 p-8 rounded-lg shadow-md">
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 font-semibold mb-2">E-Mail</label>
                    <input type="email" id="login-email" name="email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-700 font-semibold mb-2">Passwort</label>
                    <input type="password" id="login-password" name="password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" id="login-button" class="modern-button w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Anmelden
                </button>
            </form>
        </div>

        <!-- Haupt-App-Container (Standardmässig versteckt) -->
        <div id="main-app" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">SOL Lehrpersonen Portal</h2>
                <div class="flex items-center space-x-4">
                    <span id="welcome-message" class="text-gray-600 font-medium"></span>
                    <button id="logout-button" class="modern-button bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300">
                        Abmelden
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Wochenplan-Ansicht -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-700">Wochenplan</h3>
                        <button id="open-create-account-modal" class="modern-button bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300">
                            Neuen Account erstellen
                        </button>
                    </div>
                    <div id="weekly-plan-list" class="bg-gray-100 p-4 rounded-lg shadow-inner min-h-[200px]">
                        <!-- Wochenplan-Einträge werden hier dynamisch eingefügt -->
                    </div>
                </div>

                <!-- Aufgaben-Ansicht -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-700">Wöchentliche Aufgaben</h3>
                        <button id="add-task-button" class="modern-button bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300">
                            Aufgabe hinzufügen
                        </button>
                    </div>
                    <div id="task-list" class="bg-gray-100 p-4 rounded-lg shadow-inner min-h-[200px]">
                        <!-- Aufgaben werden hier dynamisch eingefügt -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Confirmation Modal -->
        <div id="custom-confirm-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50 modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full modal-content">
                <h4 id="confirm-title" class="text-lg font-bold mb-4">Bestätigung</h4>
                <p id="confirm-message" class="text-gray-600 mb-6">Sind Sie sicher?</p>
                <div class="flex justify-end space-x-2">
                    <button id="confirm-cancel" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg modern-button">Abbrechen</button>
                    <button id="confirm-ok" class="bg-red-500 text-white px-4 py-2 rounded-lg modern-button">OK</button>
                </div>
            </div>
        </div>

        <!-- Custom Message Modal -->
        <div id="custom-message-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50 modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full modal-content">
                <h4 id="message-title" class="text-lg font-bold mb-4">Nachricht</h4>
                <p id="message-text" class="text-gray-600 mb-6">Dies ist eine Nachricht.</p>
                <div class="flex justify-end">
                    <button id="message-ok" class="bg-blue-500 text-white px-4 py-2 rounded-lg modern-button">OK</button>
                </div>
            </div>
        </div>

        <!-- Account erstellen Modal (Standardmässig versteckt) -->
        <div id="create-account-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50 modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full modal-content">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-semibold">Neuen Account erstellen</h3>
                    <button id="close-create-account-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <form id="create-account-form">
                    <div class="mb-4">
                        <label for="create-email" class="block text-gray-700 font-semibold mb-2">E-Mail</label>
                        <input type="email" id="create-email" name="email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mb-4">
                        <label for="create-password" class="block text-gray-700 font-semibold mb-2">Passwort</label>
                        <input type="password" id="create-password" name="password" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mb-6">
                        <label for="create-role" class="block text-gray-700 font-semibold mb-2">Rolle</label>
                        <select id="create-role" name="role" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="lp">Lehrperson (LP)</option>
                            <option value="sus">Schüler (SUS)</option>
                        </select>
                    </div>
                    <button type="submit" id="create-account-button" class="modern-button w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300">
                        Account erstellen
                    </button>
                </form>
            </div>
        </div>

        <!-- Task Edit Modal (Standardmässig versteckt) -->
        <div id="task-edit-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50 modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full modal-content">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 id="task-modal-title" class="text-xl font-semibold">Aufgabe bearbeiten</h3>
                    <button id="close-task-edit-modal" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <form id="taskForm" data-task-id="">
                    <div class="mb-4">
                        <label for="task-title-input" class="block text-gray-700 font-semibold mb-2">Titel</label>
                        <input type="text" id="task-title-input" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="task-description-input" class="block text-gray-700 font-semibold mb-2">Beschreibung</label>
                        <textarea id="task-description-input" required rows="4" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex justify-between space-x-2">
                        <button type="button" id="task-delete-button" class="modern-button bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 w-1/3">
                            Löschen
                        </button>
                        <button type="submit" id="task-save-button" class="modern-button bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 w-2/3">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript und Firebase-Initialisierung -->
    <script type="module">
        // Importiere alle notwendigen Firebase SDK-Funktionen.
        // HINWEIS: 'getDoc' wurde hier hinzugefügt, um den 'ReferenceError' zu beheben.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";

        // Korrekte Firebase Konfiguration einfügen.
        const firebaseConfig = {
            apiKey: "AIzaSyBVRTrFbNL-jMpfWtDVv739vkuqrCY8PDw",
            authDomain: "selbstorganisiertes-lernen-7a.firebaseapp.com",
            projectId: "selbstorganisiertes-lernen-7a",
            storageBucket: "selbstorganisiertes-lernen-7a.firebasestorage.app",
            messagingSenderId: "283834841911",
            appId: "1:283834841911:web:189c328bca0c2ec167b8b2"
        };

        // Initialisiere Firebase Services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserRole = null;
        let currentUserData = null;

        // UI-Elemente
        const loginForm = document.getElementById('login-form');
        const createAccountForm = document.getElementById('create-account-form');
        const createAccountModal = document.getElementById('create-account-modal');
        const taskEditModal = document.getElementById('task-edit-modal');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const customMessageModal = document.getElementById('custom-message-modal');

        // Funktion zur Anzeige von benutzerdefinierten Nachrichten
        function showCustomMessage(message, type = 'info', title = 'Hinweis') {
            const modal = document.getElementById('custom-message-modal');
            const messageTitle = document.getElementById('message-title');
            const messageText = document.getElementById('message-text');
            const okButton = document.getElementById('message-ok');

            messageTitle.textContent = title;
            messageText.textContent = message;

            okButton.onclick = () => modal.classList.add('hidden');

            modal.classList.remove('hidden');
        }

        // Funktion zur Anzeige von benutzerdefinierten Bestätigungsdialogen
        function showCustomConfirm(message, callback, title = 'Bestätigung') {
            const modal = document.getElementById('custom-confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const okButton = document.getElementById('confirm-ok');
            const cancelButton = document.getElementById('confirm-cancel');

            confirmTitle.textContent = title;
            confirmMessage.textContent = message;

            okButton.onclick = () => {
                modal.classList.add('hidden');
                callback(true);
            };

            cancelButton.onclick = () => {
                modal.classList.add('hidden');
                callback(false);
            };

            modal.classList.remove('hidden');
        }

        // Rework: Die Account-Erstellung wurde überarbeitet, um das automatische Einloggen zu verhindern.
        async function handleCreateAccount(event) {
            event.preventDefault();

            const newEmail = document.getElementById('create-email').value;
            const newPassword = document.getElementById('create-password').value;
            const newRole = document.getElementById('create-role').value;
            const createButton = document.getElementById('create-account-button');

            createButton.disabled = true;
            createButton.textContent = 'Account wird erstellt...';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, newEmail, newPassword);
                const newUserId = userCredential.user.uid;

                // Logge den neu erstellten Benutzer sofort wieder aus
                await signOut(auth);

                // Schreibe die Account-Daten in Firestore
                const collectionPath = (newRole === 'lp') ? 'lpAccounts' : 'susAccounts';
                const accountData = {
                    email: newEmail,
                    role: newRole,
                    createdAt: new Date().toISOString()
                };
                await setDoc(doc(db, collectionPath, newUserId), accountData);

                showCustomMessage('Account erfolgreich erstellt! Der Benutzer muss sich nun selbst einloggen.', 'success', 'Erfolgreich');
                hideCreateAccountModal();

            } catch (error) {
                console.error("Fehler bei der Accounterstellung:", error);
                let errorMessage = "Unbekannter Fehler bei der Accounterstellung.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Diese E-Mail-Adresse wird bereits verwendet.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Die eingegebene E-Mail-Adresse ist ungültig.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Das Passwort ist zu schwach (mindestens 6 Zeichen).";
                } else {
                    errorMessage = "Fehler: " + error.message;
                }
                showCustomMessage(errorMessage, 'error', 'Fehler');

            } finally {
                createButton.disabled = false;
                createButton.textContent = 'Account erstellen';
            }
        }

        // Login-Funktion wurde aktualisiert, um Fehler zu behandeln
        async function handleLogin(event) {
            event.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.textContent = 'Anmelden...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged wird den Rest erledigen
            } catch (error) {
                console.error("Login-Fehler:", error);
                showCustomMessage("Anmeldung fehlgeschlagen. Überprüfen Sie Ihre E-Mail und Ihr Passwort.", 'error', 'Fehler');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Anmelden';
            }
        }

        // AUTH-LISTENER: onAuthStateChanged
        // Dieser Listener überwacht den Anmeldestatus und leitet die Benutzeroberfläche entsprechend weiter.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Benutzer angemeldet:", user.uid);
                // Überprüfe die Rolle des Benutzers in Firestore
                const lpDoc = doc(db, 'lpAccounts', user.uid);
                const lpSnapshot = await getDoc(lpDoc);

                if (lpSnapshot.exists()) {
                    currentUserData = lpSnapshot.data();
                    currentUserRole = currentUserData.role;

                    // Stelle sicher, dass nur LPs auf das Portal zugreifen können
                    if (currentUserRole === 'lp') {
                        document.getElementById('welcome-message').textContent = `Willkommen, ${currentUserData.email}`;
                        showMainApp();
                    } else {
                        // Wenn der Benutzer existiert, aber keine LP ist, abmelden.
                        await signOut(auth);
                        showLoginScreen();
                        showCustomMessage('Sie sind kein berechtigter Lehrperson-Account.', 'error', 'Zugriff verweigert');
                    }
                } else {
                    // Wenn kein Firestore-Dokument existiert, abmelden.
                    await signOut(auth);
                    showLoginScreen();
                    showCustomMessage('Ihr Account ist nicht gültig. Bitte kontaktieren Sie den Administrator.', 'error', 'Fehler');
                }
            } else {
                console.log("Kein Benutzer angemeldet.");
                showLoginScreen();
                currentUserRole = null;
                currentUserData = null;
            }
        });

        // UI-Logik
        function showMainApp() {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            initializeAppUI();
        }

        function showLoginScreen() {
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showCreateAccountModal() {
            if (currentUserRole === 'lp') {
                createAccountModal.classList.remove('hidden');
            } else {
                showCustomMessage('Sie haben keine Berechtigung, Accounts zu erstellen.', 'error', 'Zugriff verweigert');
            }
        }

        function hideCreateAccountModal() {
            createAccountModal.classList.add('hidden');
            document.getElementById('create-account-form').reset();
        }

        function showTaskEditModal(task = null) {
            const form = document.getElementById('taskForm');
            const titleInput = document.getElementById('task-title-input');
            const descriptionInput = document.getElementById('task-description-input');
            const saveButton = document.getElementById('task-save-button');
            const deleteButton = document.getElementById('task-delete-button');

            if (task) {
                form.dataset.taskId = task.id;
                titleInput.value = task.title;
                descriptionInput.value = task.description;
                saveButton.textContent = 'Aktualisieren';
                deleteButton.classList.remove('hidden');
            } else {
                form.dataset.taskId = '';
                titleInput.value = '';
                descriptionInput.value = '';
                saveButton.textContent = 'Hinzufügen';
                deleteButton.classList.add('hidden');
            }
            taskEditModal.classList.remove('hidden');
        }

        function hideTaskEditModal() {
            taskEditModal.classList.add('hidden');
        }


        // Event-Listener
        loginForm.addEventListener('submit', handleLogin);
        createAccountForm.addEventListener('submit', handleCreateAccount);
        document.getElementById('logout-button').addEventListener('click', async () => {
            await signOut(auth);
        });

        document.getElementById('open-create-account-modal').addEventListener('click', showCreateAccountModal);
        document.getElementById('close-create-account-modal').addEventListener('click', hideCreateAccountModal);
        document.getElementById('close-task-edit-modal').addEventListener('click', hideTaskEditModal);
        document.getElementById('add-task-button').addEventListener('click', () => showTaskEditModal());
        document.getElementById('task-delete-button').addEventListener('click', handleDeleteTask);
        document.getElementById('taskForm').addEventListener('submit', handleSaveTask);

        // Firestore-Listener und UI-Initialisierung
        function initializeAppUI() {
            setupWeeklyPlanListener();
            setupTasksListener();
        }

        function setupWeeklyPlanListener() {
            const weeklyPlanList = document.getElementById('weekly-plan-list');
            const q = query(collection(db, 'weeklyPlanEntries'));

            onSnapshot(q, (querySnapshot) => {
                weeklyPlanList.innerHTML = ''; // Leere Liste vor dem Rendern
                if (querySnapshot.empty) {
                    weeklyPlanList.innerHTML = '<p class="text-gray-500 italic">Noch keine Wochenplan-Einträge vorhanden.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-white rounded-lg shadow mb-2';
                    item.innerHTML = `
                        <p class="font-semibold text-gray-800">${data.title}</p>
                        <p class="text-sm text-gray-600">${data.description}</p>
                    `;
                    weeklyPlanList.appendChild(item);
                });
            }, (error) => {
                console.error("Fehler beim Laden des Wochenplans:", error);
                showCustomMessage('Fehler beim Laden des Wochenplans. Bitte versuchen Sie es später erneut.', 'error', 'Datenbankfehler');
            });
        }

        function setupTasksListener() {
            const taskList = document.getElementById('task-list');
            const q = query(collection(db, 'weeklyTasks'));

            onSnapshot(q, (querySnapshot) => {
                taskList.innerHTML = ''; // Leere Liste vor dem Rendern
                if (querySnapshot.empty) {
                    taskList.innerHTML = '<p class="text-gray-500 italic">Noch keine wöchentlichen Aufgaben vorhanden.</p>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'task-list-item p-3 bg-white rounded-lg shadow mb-2';
                    item.innerHTML = `
                        <p class="font-semibold text-gray-800">${data.title}</p>
                        <p class="text-sm text-gray-600">${data.description}</p>
                    `;
                    item.addEventListener('click', () => showTaskEditModal({ id: doc.id, ...data }));
                    taskList.appendChild(item);
                });
            }, (error) => {
                console.error("Fehler beim Laden der Aufgaben:", error);
                showCustomMessage('Fehler beim Laden der Aufgaben. Bitte versuchen Sie es später erneut.', 'error', 'Datenbankfehler');
            });
        }

        // CRUD-Operationen für Aufgaben
        async function handleSaveTask(event) {
            event.preventDefault();

            if (currentUserRole !== 'lp') {
                showCustomMessage('Sie haben keine Berechtigung, Aufgaben zu bearbeiten.', 'error', 'Zugriff verweigert');
                return;
            }

            const form = document.getElementById('taskForm');
            const taskId = form.dataset.taskId;
            const title = document.getElementById('task-title-input').value;
            const description = document.getElementById('task-description-input').value;

            const taskData = {
                title: title,
                description: description,
                updatedAt: new Date().toISOString()
            };

            const saveButton = document.getElementById('task-save-button');
            saveButton.disabled = true;
            saveButton.textContent = taskId ? 'Speichern...' : 'Hinzufügen...';

            try {
                if (taskId) {
                    // Update der Aufgabe
                    await setDoc(doc(db, 'weeklyTasks', taskId), taskData, { merge: true });
                    showCustomMessage('Aufgabe erfolgreich aktualisiert!', 'success', 'Aktualisiert');
                } else {
                    // Neue Aufgabe hinzufügen
                    await setDoc(doc(db, 'weeklyTasks', new Date().getTime().toString()), taskData);
                    showCustomMessage('Aufgabe erfolgreich hinzugefügt!', 'success', 'Hinzugefügt');
                }
                hideTaskEditModal();
            } catch (error) {
                console.error("Fehler beim Speichern der Aufgabe:", error);
                showCustomMessage('Fehler beim Speichern der Aufgabe: ' + error.message, 'error', 'Speicherfehler');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = taskId ? 'Speichern' : 'Hinzufügen';
            }
        }

        async function handleDeleteTask() {
            if (currentUserRole !== 'lp') {
                showCustomMessage('Sie haben keine Berechtigung, Aufgaben zu löschen.', 'error', 'Zugriff verweigert');
                return;
            }

            const form = document.getElementById('taskForm');
            const taskIdToDelete = form.dataset.taskId;

            if (!taskIdToDelete) {
                showCustomMessage("Keine Aufgabe zum Löschen ausgewählt.", 'warning', 'Fehler');
                return;
            }

            showCustomConfirm('Sind Sie sicher, dass Sie diese Aufgabe löschen möchten? Dies kann nicht rückgängig gemacht werden.', async (confirmed) => {
                if (confirmed) {
                    const deleteButton = document.getElementById('task-delete-button');
                    deleteButton.disabled = true;
                    deleteButton.textContent = 'Löschen...';

                    try {
                        await deleteDoc(doc(db, 'weeklyTasks', taskIdToDelete));
                        showCustomMessage('Aufgabe erfolgreich gelöscht!', 'success', 'Gelöscht');
                        hideTaskEditModal();
                    } catch (error) {
                        console.error("Fehler beim Löschen der Aufgabe:", error);
                        showCustomMessage('Fehler beim Löschen der Aufgabe: ' + error.message, 'error', 'Löschfehler');
                    } finally {
                        deleteButton.disabled = false;
                        deleteButton.textContent = 'Löschen';
                    }
                }
            }, 'Aufgabe löschen');
        }
    </script>
</body>
</html>
