<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL - Lehrpersonen-Dashboard</title>
    <!-- Tailwind CSS CDN für modernes Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            background-color: #ffffff;
            background-image: radial-gradient(at 0% 0%, #a5b4fc 0, transparent 50%),
                              radial-gradient(at 100% 100%, #60a5fa 0, transparent 50%);
            background-size: 100% 100%;
            background-position: center;
        }
        .header-container {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Style für den aktiven Haupt-Tab */
        .tab-button.active {
            color: #4338ca;
            border-bottom-width: 3px;
            border-color: #4338ca;
            font-weight: 600;
        }
        /* Style für den aktiven Unter-Tab */
        .sub-tab-button.active {
            color: #4338ca;
            border-bottom-width: 2px;
            border-color: #4338ca;
            font-weight: 600;
        }
        /* CSS-Übergänge für reibungslose Tab-Wechsel */
        .tab-content, .sub-tab-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Angepasste, kompaktere Stile für die Stundenplan-Zellen */
        .timetable-grid-cell {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .timetable-time-cell {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            width: 100px;
        }
        /* Post-it-Stil für den Arbeitsplan */
        .post-it {
            background-color: #fcf19d; /* Helles Gelb für den Post-it-Effekt */
            transform: rotate(1deg);
            transition: transform 0.2s ease-in-out;
        }
        .post-it:hover {
            transform: rotate(-1deg);
        }
        .post-it-title {
            font-family: 'Poppins', sans-serif;
            color: #4b5563; /* graue Farbe */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header mit Titel und Abmelde-Button -->
    <header class="header-container py-4 px-6 md:px-10 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Lehrpersonen-Dashboard</h1>
        <button id="logoutBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300">
            Abmelden
        </button>
    </header>

    <!-- Hauptinhalt mit Tabs -->
    <main class="flex-1 flex items-center justify-center p-6 md:p-10">
        <div class="main-container max-w-6xl w-full p-8 md:p-12 rounded-3xl shadow-2xl">
            <!-- Haupt-Tab-Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex flex-wrap space-x-4 md:space-x-8" aria-label="Tabs">
                    <button id="wochenplan-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Wochenstundenplan
                    </button>
                    <button id="arbeitsplan-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Arbeitsplan
                    </button>
                    <button id="sus-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        SuS-Übersicht
                    </button>
                    <button id="verwaltung-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Verwaltung
                    </button>
                </nav>
            </div>

            <!-- Tab-Inhalte -->
            <div id="tab-content-container">
                <!-- Wochenstundenplan-Inhalt -->
                <div id="wochenplan-content" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Wochenstundenplan</h2>
                    <p class="text-gray-600">
                        Hier wird der Stundenplan für die aktuelle Woche angezeigt. Klicken Sie auf eine "SOL"-Lektion, um sie zu blockieren und eine Aktivität hinzuzufügen.
                    </p>
                    <div id="weekly-timetable-container" class="mt-6">
                        <!-- Stundenplan wird hier durch JS eingefügt -->
                        <div class="text-center text-gray-500 my-8">
                            <span class="animate-pulse">Stundenplan wird geladen...</span>
                        </div>
                    </div>
                </div>

                <!-- Arbeitsplan-Inhalt -->
                <div id="arbeitsplan-content" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Arbeitsplan</h2>
                    <p class="text-gray-600 mb-6">
                        Hier können Sie Aufträge für die SOL-Fächer hinzufügen.
                    </p>
                    <div id="sol-arbeitsplan-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Die Post-its werden hier von JS eingefügt -->
                        <div class="text-center text-gray-500 my-8 col-span-full">
                            <span class="animate-pulse">Arbeitspläne werden geladen...</span>
                        </div>
                    </div>
                </div>

                <!-- SuS-Übersicht-Inhalt -->
                <div id="sus-content" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">SuS-Übersicht</h2>
                    <p class="text-gray-600">
                        Hier erhalten Lehrpersonen einen Überblick über den Fortschritt der Schülerinnen und Schüler.
                    </p>
                </div>

                <!-- Verwaltung-Inhalt mit Unter-Tabs -->
                <div id="verwaltung-content" class="tab-content hidden">
                    <!-- Unter-Tab-Navigation -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8" aria-label="Sub-Tabs">
                            <button id="stundenplan-subtab-btn" class="sub-tab-button active inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                Stundenplan
                            </button>
                            <button id="sol-subtab-btn" class="sub-tab-button inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                SOL-Fächer
                            </button>
                            <button id="accounts-subtab-btn" class="sub-tab-button inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                Accounts
                            </button>
                        </nav>
                    </div>

                    <!-- Unter-Tab-Inhalte -->
                    <div id="sub-tab-content-container">
                        <!-- Stundenplan-Verwaltung -->
                        <div id="stundenplan-subtab" class="sub-tab-content">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Stundenplan-Verwaltung</h2>
                            <p class="text-gray-600 mb-6">
                                Tragen Sie hier den Stundenplan für die ganze Woche ein. Die Änderungen werden gespeichert, sobald Sie auf den "Speichern"-Button klicken.
                            </p>
                            <div id="admin-timetable-container" class="overflow-x-auto">
                                <!-- Stundenplan-Tabelle wird hier durch JS eingefügt -->
                                <div class="text-center text-gray-500 my-8">
                                    <span class="animate-pulse">Stundenplan wird geladen...</span>
                                </div>
                            </div>
                            <div class="mt-8 flex flex-col md:flex-row items-center justify-between gap-4">
                                <button id="saveTimetableBtn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300">
                                    Stundenplan speichern
                                </button>
                                <div id="statusMessage" class="font-semibold text-sm"></div>
                            </div>
                        </div>

                        <!-- SOL-Fächer-Verwaltung -->
                        <div id="sol-subtab" class="sub-tab-content hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">SOL-Fächer-Verwaltung</h2>
                            <p class="text-gray-600 mb-6">
                                Wählen Sie aus, welche Fächer als "Selbstorganisiertes Lernen" (SOL) unterrichtet werden sollen. Im Stundenplan werden diese dann als "SOL" angezeigt.
                            </p>
                            <div id="sol-subjects-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <!-- Fächer-Checkboxen werden hier durch JS eingefügt -->
                                <div class="text-center text-gray-500 my-8 col-span-full">
                                    <span class="animate-pulse">SOL-Fächer werden geladen...</span>
                                </div>
                            </div>
                            <button id="saveSolSubjectsBtn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300">
                                SOL-Fächer speichern
                            </button>
                        </div>
                        
                        <!-- Accounts-Verwaltung (Platzhalter) -->
                        <div id="accounts-subtab" class="sub-tab-content hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Accounts-Verwaltung</h2>
                            <p class="text-gray-600">
                                Hier werden in Zukunft Accounts für Schülerinnen, Schüler und Lehrpersonen verwaltet.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal für SOL-Lektionen (im Stundenplan) -->
    <div id="sol-block-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full m-4">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">SOL-Lektion blockieren</h3>
            <form id="sol-block-form">
                <div class="mb-4">
                    <label for="block-type" class="block text-sm font-medium text-gray-700">Aktivitätstyp</label>
                    <select id="block-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Lernkontrolle">Lernkontrolle</option>
                        <option value="LP-Input">LP-Input</option>
                        <option value="Anderes">Anderes</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="block-title" class="block text-sm font-medium text-gray-700">Titel</label>
                    <input type="text" id="block-title" placeholder="Kurzer Titel für die Lektion" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-6">
                    <label for="block-description" class="block text-sm font-medium text-gray-700">Beschreibung</label>
                    <textarea id="block-description" rows="3" placeholder="Genaue Beschreibung, worum es geht" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-between">
                    <div>
                        <button type="button" id="save-sol-block-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-indigo-700 transition duration-300">
                            Speichern
                        </button>
                        <button type="button" id="cancel-sol-block-btn" class="ml-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-400 transition duration-300">
                            Abbrechen
                        </button>
                    </div>
                    <div>
                        <button type="button" id="delete-sol-block-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300 hidden">
                            Löschen
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal für Arbeitsplan-Aufträge (im Arbeitsplan-Tab) -->
    <div id="workplan-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full m-4">
            <h3 id="workplan-modal-title" class="text-2xl font-bold mb-4 text-gray-800">Auftrag hinzufügen</h3>
            <form id="workplan-form">
                <input type="hidden" id="workplan-subject-name">
                <input type="hidden" id="workplan-assignment-index">
                <div class="mb-4">
                    <label for="workplan-title" class="block text-sm font-medium text-gray-700">Titel des Auftrags</label>
                    <input type="text" id="workplan-title" placeholder="Z.B. Einführung in Brüche" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="workplan-grundanforderungen" class="block text-sm font-medium text-gray-700">Grundanforderungen</label>
                    <textarea id="workplan-grundanforderungen" rows="3" placeholder="Beschreiben Sie hier die Grundanforderungen" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="mb-6">
                    <label for="workplan-erweiterte-anforderungen" class="block text-sm font-medium text-gray-700">Erweiterte Anforderungen (optional)</label>
                    <textarea id="workplan-erweiterte-anforderungen" rows="3" placeholder="Beschreiben Sie hier die erweiterten Anforderungen" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-between">
                    <div>
                        <button type="button" id="save-workplan-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-indigo-700 transition duration-300">
                            Speichern
                        </button>
                        <button type="button" id="cancel-workplan-btn" class="ml-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-400 transition duration-300">
                            Abbrechen
                        </button>
                    </div>
                    <div>
                        <button type="button" id="delete-workplan-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300 hidden">
                            Löschen
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Benutzerdefinierte Bestätigungsbox (ersetzt window.confirm) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-[1000] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full m-4">
            <p id="confirmation-message" class="text-center text-lg font-medium mb-4">Sind Sie sicher?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-yes" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300">
                    Ja
                </button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-400 transition duration-300">
                    Nein
                </button>
            </div>
        </div>
    </div>
    
    <!-- Benutzerdefinierte Meldungsbox -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-[1001] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full m-4 text-center">
            <p id="alert-message" class="text-lg font-medium mb-4">Meldung</p>
            <button id="alert-ok-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-indigo-700 transition duration-300">
                OK
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore-Konfiguration (automatisch vom Canvas bereitgestellt)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBVRTrFbNL-jMpfWtDVv739vkuqrCY8PDw",
            authDomain: "selbstorganisiertes-lernen-7a.firebaseapp.com",
            projectId: "selbstorganisiertes-lernen-7a",
            storageBucket: "selbstorganisiertes-lernen-7a.appspot.com",
            messagingSenderId: "283834841911",
            appId: "1:283834841911:web:189c328bca0c2ec167b8b2"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialisieren Sie Firebase und Dienste
        let app, auth, db;
        let isAuthReady = false;
        
        // HTML-Element-Referenzen
        const logoutBtn = document.getElementById('logoutBtn');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const subTabButtons = document.querySelectorAll('.sub-tab-button');
        const subTabContents = document.querySelectorAll('.sub-tab-content');
        const weeklyTimetableContainer = document.getElementById('weekly-timetable-container');
        const adminTimetableContainer = document.getElementById('admin-timetable-container');
        const saveTimetableBtn = document.getElementById('saveTimetableBtn');
        const statusMessage = document.getElementById('statusMessage');
        const solSubjectsContainer = document.getElementById('sol-subjects-container');
        const saveSolSubjectsBtn = document.getElementById('saveSolSubjectsBtn');
        const solBlockModal = document.getElementById('sol-block-modal');
        const modalTitle = document.getElementById('modal-title');
        const solBlockForm = document.getElementById('sol-block-form');
        const blockTypeSelect = document.getElementById('block-type');
        const blockTitleInput = document.getElementById('block-title');
        const blockDescriptionTextarea = document.getElementById('block-description');
        const saveSolBlockBtn = document.getElementById('save-sol-block-btn');
        const cancelSolBlockBtn = document.getElementById('cancel-sol-block-btn');
        const deleteSolBlockBtn = document.getElementById('delete-sol-block-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');

        // Neue Referenzen für den Arbeitsplan
        const solArbeitsplanContainer = document.getElementById('sol-arbeitsplan-container');
        const workplanModal = document.getElementById('workplan-modal');
        const workplanModalTitle = document.getElementById('workplan-modal-title');
        const workplanForm = document.getElementById('workplan-form');
        const workplanSubjectNameInput = document.getElementById('workplan-subject-name');
        const workplanAssignmentIndexInput = document.getElementById('workplan-assignment-index');
        const workplanTitleInput = document.getElementById('workplan-title');
        const workplanGrundAnforderungenTextarea = document.getElementById('workplan-grundanforderungen');
        const workplanErweiterteAnforderungenTextarea = document.getElementById('workplan-erweiterte-anforderungen');
        const saveWorkplanBtn = document.getElementById('save-workplan-btn');
        const cancelWorkplanBtn = document.getElementById('cancel-workplan-btn');
        const deleteWorkplanBtn = document.getElementById('delete-workplan-btn');

        // Globale Variablen für Modals und Daten
        let currentDay = '';
        let currentSlot = '';
        let latestTimetable = {};
        let latestSolSubjects = [];
        let latestSolBlocks = {};
        let latestWorkPlans = {};

        // Konstanten für Fächer, Zeitfenster und Wochentage
        const subjects = [
            { name: 'Frei', color: 'bg-gray-200', lightColor: 'bg-gray-50', textColor: 'text-gray-700' },
            { name: 'SOL', color: 'bg-slate-300', lightColor: 'bg-slate-100', textColor: 'text-slate-800' },
            { name: 'Deutsch', color: 'bg-red-400', lightColor: 'bg-red-50', textColor: 'text-red-700' },
            { name: 'Englisch', color: 'bg-blue-400', lightColor: 'bg-blue-50', textColor: 'text-blue-700' },
            { name: 'Franzoesisch', color: 'bg-purple-400', lightColor: 'bg-purple-50', textColor: 'text-purple-700' },
            { name: 'Mathematik', color: 'bg-green-400', lightColor: 'bg-green-50', textColor: 'text-green-700' },
            { name: 'Natur und Technik', color: 'bg-yellow-400', lightColor: 'bg-yellow-50', textColor: 'text-yellow-700' },
            { name: 'NT / MI', color: 'bg-yellow-300', lightColor: 'bg-yellow-50', textColor: 'text-yellow-700' },
            { name: 'Raeume Zeiten Gesellschaften', color: 'bg-orange-400', lightColor: 'bg-orange-50', textColor: 'text-orange-700' },
            { name: 'Ethik Religion Gemeinschaft', color: 'bg-pink-400', lightColor: 'bg-pink-50', textColor: 'text-pink-700' },
            { name: 'Bewegung und Sport', color: 'bg-red-500', lightColor: 'bg-red-50', textColor: 'text-red-700' },
            { name: 'Textiles und Technisches Gestalten', color: 'bg-indigo-400', lightColor: 'bg-indigo-50', textColor: 'text-indigo-700' },
            { name: 'Musik', color: 'bg-violet-400', lightColor: 'bg-violet-50', textColor: 'text-violet-700' },
            { name: 'Bildnerisches Gestalten', color: 'bg-teal-400', lightColor: 'bg-teal-50', textColor: 'text-teal-700' },
            { name: 'Lernatelier', color: 'bg-gray-400', lightColor: 'bg-gray-50', textColor: 'text-gray-700' },
            { name: 'Individuelle Vertiefung', color: 'bg-cyan-400', lightColor: 'bg-cyan-50', textColor: 'text-cyan-700' },
            { name: 'Wirtschaft, Arbeit, Haushalt', color: 'bg-amber-400', lightColor: 'bg-amber-50', textColor: 'text-amber-700' }
        ];
        
        const timeSlots = [
            { id: 1, time: '07:30 - 08:15' },
            { id: 2, time: '08:20 - 09:05' },
            { id: 3, time: '09:10 - 09:55' },
            { id: 4, time: '10:20 - 11:05' },
            { id: 5, time: '11:10 - 11:55' },
            { id: 6, time: '12:10 - 12:55' },
            { id: 7, time: '13:00 - 13:45' },
            { id: 8, time: '13:50 - 14:35' },
            { id: 9, time: '14:40 - 15:25' },
            { id: 10, time: '15:40 - 16:25' },
            { id: 11, time: '16:30 - 17:15' }
        ];

        const daysOfWeek = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];

        /**
         * Zeigt ein benutzerdefiniertes Meldungsmodal an.
         * @param {string} message Die anzuzeigende Meldung.
         */
        function customAlert(message) {
            alertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
        }

        /**
         * Zeigt eine Statusmeldung an.
         * @param {string} message Die anzuzeigende Meldung.
         * @param {string} type Der Meldungstyp ('success', 'error', 'info').
         */
        function showStatusMessage(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'font-semibold text-sm transition duration-300';
            if (type === 'success') {
                statusMessage.classList.add('text-green-600');
            } else if (type === 'error') {
                statusMessage.classList.add('text-red-600');
            } else {
                statusMessage.classList.add('text-gray-600');
            }
        }
        
        // Tab-Wechsel-Funktionalität
        function showTab(tabId) {
            tabContents.forEach(content => content.classList.add('hidden'));
            tabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`${tabId}-tab`).classList.add('active');

            if (tabId === 'arbeitsplan') {
                renderArbeitsplanTab(latestWorkPlans, latestSolSubjects);
            } else if (tabId === 'verwaltung') {
                showSubTab('stundenplan'); // Standard-Untertab anzeigen
            }
        }

        // Unter-Tab-Wechsel-Funktionalität
        function showSubTab(subTabId) {
            subTabContents.forEach(content => content.classList.add('hidden'));
            subTabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(`${subTabId}-subtab`).classList.remove('hidden');
            document.getElementById(`${subTabId}-subtab-btn`).classList.add('active');
            
            if (subTabId === 'stundenplan') {
                renderAdminTimetableGrid(latestTimetable);
            } else if (subTabId === 'sol') {
                renderSolSubjectCheckboxes(latestSolSubjects);
            }
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.id.replace('-tab', ''));
            });
        });

        subTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showSubTab(button.id.replace('-subtab-btn', ''));
            });
        });

        /**
         * Rendert die Stundenplan-Tabelle für den Wochenplan-Tab (Lehrpersonenansicht).
         * @param {object} timetable Die Stundenplan-Daten.
         * @param {object} solBlocks Die SOL-Block-Daten.
         */
        function renderWeeklyTimetableGrid(timetable, solBlocks) {
            let tableHTML = `
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="py-2 px-3 bg-gray-100 text-gray-600 font-bold uppercase text-xs rounded-tl-xl timetable-time-cell">Zeit / Tag</th>
                            ${daysOfWeek.map(day => `<th class="py-2 px-3 bg-gray-100 text-gray-600 font-bold uppercase text-xs">${day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            timeSlots.forEach(slot => {
                tableHTML += `<tr>
                    <td class="border-t border-gray-200 py-2 px-3 text-gray-700 font-semibold timetable-time-cell">${slot.time}</td>
                    ${daysOfWeek.map(day => {
                        const subjectName = timetable?.[day]?.[slot.time] || 'Frei';
                        const subject = subjects.find(s => s.name === subjectName) || subjects[0];
                        const block = solBlocks?.[day]?.[slot.time];
                        const isSol = latestSolSubjects.includes(subject.name);
                        
                        let cellContent;
                        let cellClass = `border-t border-gray-200 py-2 px-3 timetable-grid-cell cursor-pointer transition-colors`;
                        
                        if (isSol) {
                            if (block) {
                                // Geblockte SOL-Lektion
                                cellClass += ` bg-slate-300 text-slate-800 font-bold`;
                                cellContent = `
                                    <div class="font-bold">${block.title}</div>
                                    <div class="text-xs text-slate-600">${block.type}</div>
                                `;
                            } else {
                                // Nicht geblockte SOL-Lektion
                                cellClass += ` ${subject.lightColor} text-slate-800 font-medium hover:bg-slate-200`;
                                cellContent = 'SOL';
                            }
                        } else {
                            // Reguläre Lektion
                            cellClass += ` ${subject.lightColor} ${subject.textColor} font-medium`;
                            cellContent = subject.name;
                        }

                        return `<td class="${cellClass}" data-day="${day}" data-slot="${slot.time}" data-is-sol="${isSol}">${cellContent}</td>`;
                    }).join('')}
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            weeklyTimetableContainer.innerHTML = tableHTML;
        }

        /**
         * Rendert die Stundenplan-Tabelle für den Verwaltung-Tab (Admin-Ansicht).
         * @param {object} savedTimetable Die Stundenplan-Daten.
         */
        function renderAdminTimetableGrid(savedTimetable) {
            let tableHTML = `
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="py-2 px-3 bg-gray-100 text-gray-600 font-bold uppercase text-xs rounded-tl-xl timetable-time-cell">Zeit / Tag</th>
                            ${daysOfWeek.map(day => `<th class="py-2 px-3 bg-gray-100 text-gray-600 font-bold uppercase text-xs">${day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            timeSlots.forEach(slot => {
                tableHTML += `<tr>
                    <td class="border-t border-gray-200 py-2 px-3 text-gray-700 font-semibold timetable-time-cell">${slot.time}</td>
                    ${daysOfWeek.map(day => {
                        const savedSubjectName = savedTimetable?.[day]?.[slot.time] || '';
                        return `
                            <td class="border-t border-gray-200 py-1 px-2">
                                <input 
                                    type="text" 
                                    class="w-full p-1 border border-gray-300 rounded-lg timetable-grid-cell focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                    list="subject-list" 
                                    value="${savedSubjectName}" 
                                    data-day="${day}" 
                                    data-slot="${slot.time}"
                                />
                            </td>
                        `;
                    }).join('')}
                </tr>`;
            });
            tableHTML += `</tbody></table>`;

            adminTimetableContainer.innerHTML = tableHTML;
            
            // Eine Datalist für Fach-Vorschläge erstellen
            const datalist = document.createElement('datalist');
            datalist.id = 'subject-list';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.name;
                datalist.appendChild(option);
            });
            document.body.appendChild(datalist);
        }

        /**
         * Rendert die Checkboxen für SOL-Fächer im Verwaltung-Tab.
         * @param {string[]} solSubjects Die Liste der aktuellen SOL-Fächer.
         */
        function renderSolSubjectCheckboxes(solSubjects) {
            solSubjectsContainer.innerHTML = '';
            
            // 'Frei' und 'SOL' als wählbare Fächer ausschliessen
            const selectableSubjects = subjects.filter(s => s.name !== 'Frei' && s.name !== 'SOL');
            
            selectableSubjects.forEach(subject => {
                const isChecked = solSubjects.includes(subject.name);
                const container = document.createElement('label');
                container.className = `flex items-center space-x-2 p-2 rounded-lg cursor-pointer transition-colors ${isChecked ? 'bg-indigo-100' : 'bg-gray-100 hover:bg-gray-200'}`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-checkbox h-4 w-4 text-indigo-600 rounded';
                checkbox.value = subject.name;
                checkbox.checked = isChecked;
                
                const span = document.createElement('span');
                span.className = 'text-sm font-medium text-gray-700';
                span.textContent = subject.name;
                
                container.appendChild(checkbox);
                container.appendChild(span);
                solSubjectsContainer.appendChild(container);
            });
        }

        /**
         * Rendert die "Post-its" für den Arbeitsplan-Tab.
         * @param {object} workPlans Die Arbeitsplan-Daten.
         * @param {string[]} solSubjects Die Liste der SOL-Fächer.
         */
        function renderArbeitsplanTab(workPlans, solSubjects) {
            solArbeitsplanContainer.innerHTML = '';

            if (solSubjects.length === 0) {
                solArbeitsplanContainer.innerHTML = `<div class="col-span-full text-center text-gray-500 my-8">
                    Es wurden keine SOL-Fächer in der <a href="#" onclick="showTab('verwaltung')" class="text-indigo-600 underline">Verwaltung</a> festgelegt.
                </div>`;
                return;
            }
            
            solSubjects.forEach(subjectName => {
                const assignments = workPlans[subjectName] || [];
                const postIt = document.createElement('div');
                postIt.className = 'post-it p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col justify-between';
                postIt.dataset.subject = subjectName;

                let assignmentsHTML = assignments.map((assignment, index) => {
                    return `
                        <div class="mb-4 p-4 bg-white rounded-lg shadow-inner cursor-pointer hover:bg-gray-50 transition-colors" data-index="${index}">
                            <div class="font-semibold text-lg text-gray-800">${assignment.title}</div>
                            <div class="text-sm text-gray-600 mt-2">
                                <p class="font-medium text-gray-700">Grundanforderungen:</p>
                                <p class="whitespace-pre-wrap">${assignment.grundAnforderungen}</p>
                            </div>
                            ${assignment.erweiterteAnforderungen ? `
                            <div class="text-sm text-gray-600 mt-2">
                                <p class="font-medium text-gray-700">Erweiterte Anforderungen:</p>
                                <p class="whitespace-pre-wrap">${assignment.erweiterteAnforderungen}</p>
                            </div>` : ''}
                        </div>
                    `;
                }).join('');

                postIt.innerHTML = `
                    <div>
                        <h3 class="post-it-title text-2xl font-bold mb-4">${subjectName}</h3>
                        <div class="assignments-list">
                            ${assignmentsHTML}
                        </div>
                    </div>
                    <div class="mt-4">
                        <button class="add-assignment-btn w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            Auftrag hinzufügen
                        </button>
                    </div>
                `;
                solArbeitsplanContainer.appendChild(postIt);
            });

            // Event listener für das Öffnen des Modals zum Hinzufügen von Aufträgen
            document.querySelectorAll('.add-assignment-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const subjectName = event.target.closest('.post-it').dataset.subject;
                    openWorkplanModal(subjectName);
                });
            });

            // Event listener für das Bearbeiten von Aufträgen
            document.querySelectorAll('.assignments-list > div').forEach(assignmentEl => {
                assignmentEl.addEventListener('click', (event) => {
                    const subjectName = event.target.closest('.post-it').dataset.subject;
                    const index = parseInt(event.target.closest('.assignments-list > div').dataset.index);
                    openWorkplanModal(subjectName, index);
                });
            });
        }
        
        /**
         * Speichert den Stundenplan von der Admin-Ansicht in Firestore.
         */
        async function saveTimetable() {
            if (!isAuthReady) {
                customAlert('Die Authentifizierung ist nicht bereit. Daten können nicht gespeichert werden.');
                return;
            }

            const updatedTimetable = {};
            document.querySelectorAll('#admin-timetable-container input').forEach(input => {
                const day = input.dataset.day;
                const slot = input.dataset.slot;
                const subject = input.value.trim();
                
                if (!updatedTimetable[day]) {
                    updatedTimetable[day] = {};
                }
                updatedTimetable[day][slot] = subject;
            });
            
            try {
                const timetableDocRef = doc(db, `artifacts/${appId}/public/data/timetables`, 'schoolTimetable');
                await setDoc(timetableDocRef, updatedTimetable);
                showStatusMessage('Stundenplan erfolgreich gespeichert!', 'success');
            } catch (error) {
                console.error('Fehler beim Speichern des Stundenplans:', error);
                customAlert('Fehler beim Speichern des Stundenplans. Bitte erneut versuchen.');
            }
        }
        
        /**
         * Speichert die SOL-Fächer von der Admin-Ansicht in Firestore.
         */
        async function saveSolSubjects() {
            if (!isAuthReady) {
                customAlert('Die Authentifizierung ist nicht bereit. Daten können nicht gespeichert werden.');
                return;
            }

            const updatedSolSubjects = [];
            document.querySelectorAll('#sol-subjects-container input[type="checkbox"]:checked').forEach(checkbox => {
                updatedSolSubjects.push(checkbox.value);
            });
            
            try {
                const solSubjectsDocRef = doc(db, `artifacts/${appId}/public/data/settings`, 'solSubjects');
                await setDoc(solSubjectsDocRef, { subjects: updatedSolSubjects });
                showStatusMessage('SOL-Fächer erfolgreich gespeichert!', 'success');
            } catch (error) {
                console.error('Fehler beim Speichern der SOL-Fächer:', error);
                customAlert('Fehler beim Speichern der SOL-Fächer. Bitte erneut versuchen.');
            }
        }

        // Event-Listener für die Admin-Sektion-Buttons
        saveTimetableBtn.addEventListener('click', saveTimetable);
        saveSolSubjectsBtn.addEventListener('click', saveSolSubjects);
        alertOkBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
        });

        // Event-Listener für das Öffnen des Modals beim Klick auf eine SOL-Lektion
        weeklyTimetableContainer.addEventListener('click', (event) => {
            const cell = event.target.closest('td');
            if (cell && cell.dataset.isSol === 'true') {
                currentDay = cell.dataset.day;
                currentSlot = cell.dataset.slot;
                openSolBlockModal(currentDay, currentSlot);
            }
        });
        
        // Modal-Funktionen für den Stundenplan
        async function openSolBlockModal(day, slot) {
            const block = latestSolBlocks?.[day]?.[slot];
            
            if (block) {
                // Bestehenden Block bearbeiten
                modalTitle.textContent = "SOL-Lektion bearbeiten";
                blockTypeSelect.value = block.type;
                blockTitleInput.value = block.title;
                blockDescriptionTextarea.value = block.description;
                deleteSolBlockBtn.classList.remove('hidden');
            } else {
                // Neuen Block erstellen
                modalTitle.textContent = "SOL-Lektion blockieren";
                solBlockForm.reset();
                deleteSolBlockBtn.classList.add('hidden');
            }
            solBlockModal.classList.remove('hidden');
        }

        function closeSolBlockModal() {
            solBlockModal.classList.add('hidden');
            solBlockForm.reset();
        }

        // SOL-Block speichern
        saveSolBlockBtn.addEventListener('click', async () => {
            const blockType = blockTypeSelect.value;
            const blockTitle = blockTitleInput.value.trim();
            const blockDescription = blockDescriptionTextarea.value.trim();

            if (!blockTitle) {
                customAlert('Bitte geben Sie einen Titel für die Lektion ein.');
                return;
            }
            
            const block = {
                type: blockType,
                title: blockTitle,
                description: blockDescription
            };
            
            const solBlocksDocRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
            
            const updatedBlocks = {
                ...latestSolBlocks,
                [currentDay]: {
                    ...(latestSolBlocks[currentDay] || {}),
                    [currentSlot]: block
                }
            };

            try {
                await setDoc(solBlocksDocRef, updatedBlocks);
                closeSolBlockModal();
                showStatusMessage('Lektion erfolgreich blockiert!', 'success');
            } catch (error) {
                console.error('Fehler beim Speichern des SOL-Blocks:', error);
                customAlert('Fehler beim Speichern der Lektion. Bitte erneut versuchen.');
            }
        });

        // SOL-Block löschen
        deleteSolBlockBtn.addEventListener('click', async () => {
            confirmationModal.classList.remove('hidden');
        });

        // Bestätigungs-Handler
        confirmYesBtn.addEventListener('click', async () => {
            confirmationModal.classList.add('hidden');
            
            const solBlocksDocRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
            const updatedBlocks = {
                ...latestSolBlocks,
                [currentDay]: {
                    ...(latestSolBlocks[currentDay] || {})
                }
            };
            delete updatedBlocks[currentDay][currentSlot];
            
            if (Object.keys(updatedBlocks[currentDay]).length === 0) {
                delete updatedBlocks[currentDay];
            }

            try {
                if (Object.keys(updatedBlocks).length === 0) {
                    await deleteDoc(solBlocksDocRef);
                } else {
                    await setDoc(solBlocksDocRef, updatedBlocks);
                }
                closeSolBlockModal();
                showStatusMessage('Lektion erfolgreich gelöscht!', 'success');
            } catch (error) {
                console.error('Fehler beim Löschen des SOL-Blocks:', error);
                customAlert('Fehler beim Löschen der Lektion. Bitte erneut versuchen.');
            }
        });

        confirmNoBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
        });

        // Modal abbrechen
        cancelSolBlockBtn.addEventListener('click', closeSolBlockModal);

        // Modal-Funktionen für den Arbeitsplan
        function openWorkplanModal(subjectName, assignmentIndex = null) {
            workplanSubjectNameInput.value = subjectName;
            workplanAssignmentIndexInput.value = assignmentIndex !== null ? assignmentIndex : '';

            if (assignmentIndex !== null) {
                const assignment = latestWorkPlans[subjectName][assignmentIndex];
                workplanModalTitle.textContent = 'Auftrag bearbeiten';
                workplanTitleInput.value = assignment.title;
                workplanGrundAnforderungenTextarea.value = assignment.grundAnforderungen;
                workplanErweiterteAnforderungenTextarea.value = assignment.erweiterteAnforderungen;
                deleteWorkplanBtn.classList.remove('hidden');
            } else {
                workplanModalTitle.textContent = 'Auftrag hinzufügen';
                workplanForm.reset();
                deleteWorkplanBtn.classList.add('hidden');
            }
            workplanModal.classList.remove('hidden');
        }

        function closeWorkplanModal() {
            workplanModal.classList.add('hidden');
            workplanForm.reset();
        }

        saveWorkplanBtn.addEventListener('click', async () => {
            const subjectName = workplanSubjectNameInput.value;
            const assignmentIndex = workplanAssignmentIndexInput.value !== '' ? parseInt(workplanAssignmentIndexInput.value) : null;
            const title = workplanTitleInput.value.trim();
            const grundAnforderungen = workplanGrundAnforderungenTextarea.value.trim();
            const erweiterteAnforderungen = workplanErweiterteAnforderungenTextarea.value.trim();

            if (!title || !grundAnforderungen) {
                customAlert('Bitte füllen Sie mindestens den Titel und die Grundanforderungen aus.');
                return;
            }

            const workPlanDocRef = doc(db, `artifacts/${appId}/public/data/workPlans`, 'weeklyWorkPlan');
            const newAssignment = {
                title,
                grundAnforderungen,
                erweiterteAnforderungen
            };

            let updatedWorkPlans = { ...latestWorkPlans };
            if (!updatedWorkPlans[subjectName]) {
                updatedWorkPlans[subjectName] = [];
            }

            if (assignmentIndex !== null) {
                updatedWorkPlans[subjectName][assignmentIndex] = newAssignment;
            } else {
                updatedWorkPlans[subjectName].push(newAssignment);
            }

            try {
                await setDoc(workPlanDocRef, updatedWorkPlans, { merge: true });
                closeWorkplanModal();
                showStatusMessage('Auftrag erfolgreich gespeichert!', 'success');
            } catch (error) {
                console.error('Fehler beim Speichern des Auftrags:', error);
                customAlert('Fehler beim Speichern des Auftrags. Bitte erneut versuchen.');
            }
        });

        deleteWorkplanBtn.addEventListener('click', () => {
            confirmationModal.classList.remove('hidden');
        });
        
        // Confirmation handler for deleting a workplan assignment
        // NOTE: This overrides the existing confirmYesBtn listener. I need to make a new one or modify it.
        // Let's modify the confirmation modal logic to be more generic.
        let confirmationAction = null;
        confirmYesBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            if (typeof confirmationAction === 'function') {
                confirmationAction();
            }
        });

        // Let's redefine the delete listeners with the new confirmation logic
        deleteWorkplanBtn.addEventListener('click', () => {
            confirmationAction = async () => {
                const subjectName = workplanSubjectNameInput.value;
                const assignmentIndex = parseInt(workplanAssignmentIndexInput.value);
                
                const workPlanDocRef = doc(db, `artifacts/${appId}/public/data/workPlans`, 'weeklyWorkPlan');
                let updatedWorkPlans = { ...latestWorkPlans };
                
                updatedWorkPlans[subjectName].splice(assignmentIndex, 1);

                try {
                    await setDoc(workPlanDocRef, updatedWorkPlans, { merge: true });
                    closeWorkplanModal();
                    showStatusMessage('Auftrag erfolgreich gelöscht!', 'success');
                } catch (error) {
                    console.error('Fehler beim Löschen des Auftrags:', error);
                    customAlert('Fehler beim Löschen des Auftrags. Bitte erneut versuchen.');
                }
            };
            confirmationModal.classList.remove('hidden');
        });
        
        // Update the deleteSolBlockBtn listener to use the generic confirmation logic as well
        deleteSolBlockBtn.addEventListener('click', () => {
            confirmationAction = async () => {
                const solBlocksDocRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
                const updatedBlocks = {
                    ...latestSolBlocks,
                    [currentDay]: {
                        ...(latestSolBlocks[currentDay] || {})
                    }
                };
                delete updatedBlocks[currentDay][currentSlot];
                
                if (Object.keys(updatedBlocks[currentDay]).length === 0) {
                    delete updatedBlocks[currentDay];
                }

                try {
                    if (Object.keys(updatedBlocks).length === 0) {
                        await deleteDoc(solBlocksDocRef);
                    } else {
                        await setDoc(solBlocksDocRef, updatedBlocks);
                    }
                    closeSolBlockModal();
                    showStatusMessage('Lektion erfolgreich gelöscht!', 'success');
                } catch (error) {
                    console.error('Fehler beim Löschen des SOL-Blocks:', error);
                    customAlert('Fehler beim Löschen der Lektion. Bitte erneut versuchen.');
                }
            };
            confirmationModal.classList.remove('hidden');
        });
        
        cancelWorkplanBtn.addEventListener('click', closeWorkplanModal);

        // Firestore-Echtzeit-Listener für alle Daten
        function setupFirestoreListeners() {
            if (!isAuthReady) {
                console.warn('Firestore-Listener können nicht eingerichtet werden: Authentifizierung nicht bereit.');
                return;
            }

            const timetableRef = doc(db, `artifacts/${appId}/public/data/timetables`, 'schoolTimetable');
            const solSubjectsRef = doc(db, `artifacts/${appId}/public/data/settings`, 'solSubjects');
            const solBlocksRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
            const workPlansRef = doc(db, `artifacts/${appId}/public/data/workPlans`, 'weeklyWorkPlan');

            // Stundenplan-Listener
            onSnapshot(timetableRef, (docSnap) => {
                latestTimetable = docSnap.exists() ? docSnap.data() : {};
                renderWeeklyTimetableGrid(latestTimetable, latestSolBlocks);
                renderAdminTimetableGrid(latestTimetable);
            }, (error) => {
                console.error("Fehler beim Abrufen des Stundenplans:", error);
                showStatusMessage('Fehler beim Abrufen des Stundenplans.', 'error');
            });

            // SOL-Fächer-Listener
            onSnapshot(solSubjectsRef, (docSnap) => {
                latestSolSubjects = docSnap.exists() ? docSnap.data().subjects || [] : [];
                renderWeeklyTimetableGrid(latestTimetable, latestSolBlocks);
                renderSolSubjectCheckboxes(latestSolSubjects);
                renderArbeitsplanTab(latestWorkPlans, latestSolSubjects); // Rerender Arbeitsplan
            }, (error) => {
                console.error("Fehler beim Abrufen der SOL-Fächer:", error);
                showStatusMessage('Fehler beim Abrufen der SOL-Fächer.', 'error');
            });

            // SOL-Blöcke-Listener
            onSnapshot(solBlocksRef, (docSnap) => {
                latestSolBlocks = docSnap.exists() ? docSnap.data() : {};
                renderWeeklyTimetableGrid(latestTimetable, latestSolBlocks);
            }, (error) => {
                console.error("Fehler beim Abrufen der SOL-Blöcke:", error);
            });

            // Arbeitsplan-Listener (neu)
            onSnapshot(workPlansRef, (docSnap) => {
                latestWorkPlans = docSnap.exists() ? docSnap.data() : {};
                renderArbeitsplanTab(latestWorkPlans, latestSolSubjects);
            }, (error) => {
                console.error("Fehler beim Abrufen des Arbeitsplans:", error);
            });
        }
        
        // Initialisierungsfunktion
        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const user = await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        unsubscribe();
                        resolve(user);
                    });
                });

                if (user) {
                    isAuthReady = true;
                    setupFirestoreListeners();
                } else {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            isAuthReady = true;
                            setupFirestoreListeners();
                        } catch (tokenError) {
                            console.error('Error with signInWithCustomToken:', tokenError);
                            try {
                                await signInAnonymously(auth);
                                isAuthReady = true;
                                setupFirestoreListeners();
                            } catch (anonError) {
                                console.error('Error with signInAnonymously:', anonError);
                                throw new Error('Anonyme Anmeldung fehlgeschlagen.');
                            }
                        }
                    } else {
                        try {
                            await signInAnonymously(auth);
                            isAuthReady = true;
                            setupFirestoreListeners();
                        } catch (anonError) {
                            console.error('Error with signInAnonymously:', anonError);
                            throw new Error('Anonyme Anmeldung fehlgeschlagen.');
                        }
                    }
                }
                
                // Den Standard-Tab anzeigen
                showTab('wochenplan');
                showSubTab('stundenplan');
            } catch (error) {
                console.error('Initialisierungsfehler:', error);
                customAlert('Die Initialisierung ist fehlgeschlagen. Bitte versuchen Sie es später erneut.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeAppAndAuth);

        // Abmelde-Funktionalität
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                customAlert('Sie wurden erfolgreich abgemeldet.');
            } catch (error) {
                console.error('Fehler beim Abmelden:', error);
                customAlert('Fehler beim Abmelden.');
            }
        });
    </script>
</body>
</html>
