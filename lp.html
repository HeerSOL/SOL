<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL - Lehrpersonen-Dashboard</title>
    <!-- Tailwind CSS CDN für modernes Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            background-color: #ffffff;
            background-image: radial-gradient(at 0% 0%, #a5b4fc 0, transparent 50%),
                              radial-gradient(at 100% 100%, #60a5fa 0, transparent 50%);
            background-size: 100% 100%;
            background-position: center;
        }
        .header-container {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Style für den aktiven Haupt-Tab */
        .tab-button.active {
            color: #4338ca;
            border-bottom-width: 3px;
            border-color: #4338ca;
            font-weight: 600;
        }
        /* Style für den aktiven Unter-Tab */
        .sub-tab-button.active {
            color: #4338ca;
            border-bottom-width: 2px;
            border-color: #4338ca;
            font-weight: 600;
        }
        /* CSS-Übergänge für reibungslose Tab-Wechsel */
        .tab-content, .sub-tab-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Angepasste, kompaktere Stile für die Stundenplan-Zellen */
        .timetable-grid-cell {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .timetable-time-cell {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            width: 100px;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header with title and logout button -->
    <header class="header-container py-4 px-6 md:px-10 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Lehrpersonen-Dashboard</h1>
        <button id="logoutBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300">
            Abmelden
        </button>
    </header>

    <!-- Main content with tabs -->
    <main class="flex-1 flex items-center justify-center p-6 md:p-10">
        <div class="main-container max-w-6xl w-full p-8 md:p-12 rounded-3xl shadow-2xl">
            <!-- Main tab navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex flex-wrap space-x-4 md:space-x-8" aria-label="Tabs">
                    <button id="wochenplan-tab" class="tab-button active inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Wochenstundenplan
                    </button>
                    <button id="arbeitsplan-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Arbeitsplan
                    </button>
                    <button id="sus-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        SuS-Übersicht
                    </button>
                    <button id="verwaltung-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Verwaltung
                    </button>
                </nav>
            </div>

            <!-- Tab contents -->
            <div id="tab-content-container">
                <!-- Wochenstundenplan Content (visible by default) -->
                <div id="wochenplan-content" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Wochenstundenplan</h2>
                    <p class="text-gray-600">
                        Hier wird der Stundenplan für die aktuelle Woche angezeigt. Klicken Sie auf eine "SOL"-Lektion, um sie zu blockieren und eine Aktivität hinzuzufügen.
                    </p>
                    <div id="weekly-timetable-container" class="mt-6">
                        <!-- The timetable will be inserted here by JS -->
                        <div class="text-center text-gray-500 my-8">
                            <span class="animate-pulse">Stundenplan wird geladen...</span>
                        </div>
                    </div>
                </div>

                <!-- Arbeitsplan Content -->
                <div id="arbeitsplan-content" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Arbeitsplan</h2>
                    <p class="text-gray-600">
                        Hier können Lehrpersonen Arbeitspläne erstellen, bearbeiten und zuweisen.
                    </p>
                </div>

                <!-- SuS-Übersicht Content -->
                <div id="sus-content" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">SuS-Übersicht</h2>
                    <p class="text-gray-600">
                        Hier erhalten Lehrpersonen einen Überblick über den Fortschritt der Schülerinnen und Schüler.
                    </p>
                </div>

                <!-- Verwaltung Content with sub-tabs -->
                <div id="verwaltung-content" class="tab-content hidden">
                    <!-- Sub-tab navigation -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8" aria-label="Sub-Tabs">
                            <button id="stundenplan-subtab-btn" class="sub-tab-button active inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                Stundenplan
                            </button>
                            <button id="sol-subtab-btn" class="sub-tab-button inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                SOL-Fächer
                            </button>
                            <button id="accounts-subtab-btn" class="sub-tab-button inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                Accounts
                            </button>
                        </nav>
                    </div>

                    <!-- Sub-tab contents -->
                    <div id="sub-tab-content-container">
                        <!-- Stundenplan management -->
                        <div id="stundenplan-subtab" class="sub-tab-content">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Stundenplan-Verwaltung</h2>
                            <p class="text-gray-600 mb-6">
                                Tragen Sie hier den Stundenplan für die ganze Woche ein. Die Änderungen werden gespeichert, sobald Sie auf den "Speichern"-Button klicken.
                            </p>
                            <div id="admin-timetable-container" class="overflow-x-auto">
                                <!-- Timetable table will be inserted here by JS -->
                                <div class="text-center text-gray-500 my-8">
                                    <span class="animate-pulse">Stundenplan wird geladen...</span>
                                </div>
                            </div>
                            <div class="mt-8 flex flex-col md:flex-row items-center justify-between gap-4">
                                <button id="saveTimetableBtn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300">
                                    Stundenplan speichern
                                </button>
                                <div id="statusMessage" class="font-semibold text-sm"></div>
                            </div>
                        </div>

                        <!-- SOL subjects management -->
                        <div id="sol-subtab" class="sub-tab-content hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">SOL-Fächer-Verwaltung</h2>
                            <p class="text-gray-600 mb-6">
                                Wählen Sie aus, welche Fächer als "Selbstorganisiertes Lernen" (SOL) unterrichtet werden sollen. Im Stundenplan werden diese dann als "SOL" angezeigt.
                            </p>
                            <div id="sol-subjects-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <!-- Subject checkboxes will be inserted here by JS -->
                                <div class="text-center text-gray-500 my-8 col-span-full">
                                    <span class="animate-pulse">SOL-Fächer werden geladen...</span>
                                </div>
                            </div>
                            <button id="saveSolSubjectsBtn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300">
                                SOL-Fächer speichern
                            </button>
                        </div>
                        
                        <!-- Accounts management (placeholder) -->
                        <div id="accounts-subtab" class="sub-tab-content hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Accounts-Verwaltung</h2>
                            <p class="text-gray-600">
                                Hier werden in Zukunft Accounts für Schülerinnen, Schüler und Lehrpersonen verwaltet.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal for SOL lessons -->
    <div id="sol-block-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full m-4">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">SOL-Lektion blockieren</h3>
            <form id="sol-block-form">
                <div class="mb-4">
                    <label for="block-type" class="block text-sm font-medium text-gray-700">Aktivitätstyp</label>
                    <select id="block-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Lernkontrolle">Lernkontrolle</option>
                        <option value="LP-Input">LP-Input</option>
                        <option value="Anderes">Anderes</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="block-title" class="block text-sm font-medium text-gray-700">Titel</label>
                    <input type="text" id="block-title" placeholder="Kurzer Titel für die Lektion" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-6">
                    <label for="block-description" class="block text-sm font-medium text-gray-700">Beschreibung</label>
                    <textarea id="block-description" rows="3" placeholder="Genaue Beschreibung, worum es geht" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-between">
                    <div>
                        <button type="button" id="save-sol-block-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-indigo-700 transition duration-300">
                            Speichern
                        </button>
                        <button type="button" id="cancel-sol-block-btn" class="ml-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-400 transition duration-300">
                            Abbrechen
                        </button>
                    </div>
                    <div>
                        <button type="button" id="delete-sol-block-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300 hidden">
                            Löschen
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Custom confirmation modal box (replaces window.confirm) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-[1000] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full m-4">
            <p id="confirmation-message" class="text-center text-lg font-medium mb-4">Sind Sie sicher?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-yes" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300">
                    Ja
                </button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-400 transition duration-300">
                    Nein
                </button>
            </div>
        </div>
    </div>
    
    <!-- Custom alert modal box -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-[1001] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full m-4 text-center">
            <p id="alert-message" class="text-lg font-medium mb-4">Meldung</p>
            <button id="alert-ok-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-indigo-700 transition duration-300">
                OK
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore configuration (automatically provided by Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBVRTrFbNL-jMpfWtDVv739vkuqrCY8PDw",
            authDomain: "selbstorganisiertes-lernen-7a.firebaseapp.com",
            projectId: "selbstorganisiertes-lernen-7a",
            storageBucket: "selbstorganisiertes-lernen-7a.appspot.com",
            messagingSenderId: "283834841911",
            appId: "1:283834841911:web:189c328bca0c2ec167b8b2"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase and services
        let app, auth, db;
        let isAuthReady = false;
        
        // HTML element references
        const logoutBtn = document.getElementById('logoutBtn');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const subTabButtons = document.querySelectorAll('.sub-tab-button');
        const subTabContents = document.querySelectorAll('.sub-tab-content');
        const weeklyTimetableContainer = document.getElementById('weekly-timetable-container');
        const adminTimetableContainer = document.getElementById('admin-timetable-container'); // Changed from timetable-container to avoid conflict
        const saveTimetableBtn = document.getElementById('saveTimetableBtn');
        const statusMessage = document.getElementById('statusMessage');
        const solSubjectsContainer = document.getElementById('sol-subjects-container');
        const saveSolSubjectsBtn = document.getElementById('saveSolSubjectsBtn');
        const solBlockModal = document.getElementById('sol-block-modal');
        const modalTitle = document.getElementById('modal-title');
        const solBlockForm = document.getElementById('sol-block-form');
        const blockTypeSelect = document.getElementById('block-type');
        const blockTitleInput = document.getElementById('block-title');
        const blockDescriptionTextarea = document.getElementById('block-description');
        const saveSolBlockBtn = document.getElementById('save-sol-block-btn');
        const cancelSolBlockBtn = document.getElementById('cancel-sol-block-btn');
        const deleteSolBlockBtn = document.getElementById('delete-sol-block-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmYesBtn = document.getElementById('confirm-yes');
        const confirmNoBtn = document.getElementById('confirm-no');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');

        // Global variables for the modal and data
        let currentDay = '';
        let currentSlot = '';
        let latestTimetable = {};
        let latestSolSubjects = [];
        let latestSolBlocks = {};

        // Constants for subjects, time slots, and days of the week
        const subjects = [
            { name: 'Frei', color: 'bg-gray-200', lightColor: 'bg-gray-50', textColor: 'text-gray-700' },
            { name: 'SOL', color: 'bg-slate-300', lightColor: 'bg-slate-100', textColor: 'text-slate-800' },
            { name: 'Deutsch', color: 'bg-red-400', lightColor: 'bg-red-50', textColor: 'text-red-700' },
            { name: 'Englisch', color: 'bg-blue-400', lightColor: 'bg-blue-50', textColor: 'text-blue-700' },
            { name: 'Franzoesisch', color: 'bg-purple-400', lightColor: 'bg-purple-50', textColor: 'text-purple-700' },
            { name: 'Mathematik', color: 'bg-green-400', lightColor: 'bg-green-50', textColor: 'text-green-700' },
            { name: 'Natur und Technik', color: 'bg-yellow-400', lightColor: 'bg-yellow-50', textColor: 'text-yellow-700' },
            { name: 'NT / MI', color: 'bg-yellow-300', lightColor: 'bg-yellow-50', textColor: 'text-yellow-700' },
            { name: 'Raeume Zeiten Gesellschaften', color: 'bg-orange-400', lightColor: 'bg-orange-50', textColor: 'text-orange-700' },
            { name: 'Ethik Religion Gemeinschaft', color: 'bg-pink-400', lightColor: 'bg-pink-50', textColor: 'text-pink-700' },
            { name: 'Bewegung und Sport', color: 'bg-red-500', lightColor: 'bg-red-50', textColor: 'text-red-700' },
            { name: 'Textiles und Technisches Gestalten', color: 'bg-indigo-400', lightColor: 'bg-indigo-50', textColor: 'text-indigo-700' },
            { name: 'Musik', color: 'bg-violet-400', lightColor: 'bg-violet-50', textColor: 'text-violet-700' },
            { name: 'Bildnerisches Gestalten', color: 'bg-teal-400', lightColor: 'bg-teal-50', textColor: 'text-teal-700' },
            { name: 'Lernatelier', color: 'bg-gray-400', lightColor: 'bg-gray-50', textColor: 'text-gray-700' },
            { name: 'Individuelle Vertiefung', color: 'bg-cyan-400', lightColor: 'bg-cyan-50', textColor: 'text-cyan-700' },
            { name: 'Wirtschaft, Arbeit, Haushalt', color: 'bg-amber-400', lightColor: 'bg-amber-50', textColor: 'text-amber-700' }
        ];
        
        const timeSlots = [
            { id: 1, time: '07:30 - 08:15' },
            { id: 2, time: '08:20 - 09:05' },
            { id: 3, time: '09:10 - 09:55' },
            { id: 4, time: '10:20 - 11:05' },
            { id: 5, time: '11:10 - 11:55' },
            { id: 6, time: '12:10 - 12:55' },
            { id: 7, time: '13:00 - 13:45' },
            { id: 8, time: '13:50 - 14:35' },
            { id: 9, time: '14:40 - 15:25' },
            { id: 10, time: '15:40 - 16:25' },
            { id: 11, time: '16:30 - 17:15' }
        ];

        const daysOfWeek = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];

        /**
         * Displays a custom alert modal.
         * @param {string} message The message to display.
         */
        function customAlert(message) {
            alertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
        }

        /**
         * Displays a status message.
         * @param {string} message The message to display.
         * @param {string} type The message type ('success', 'error', 'info').
         */
        function showStatusMessage(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'font-semibold text-sm transition duration-300';
            if (type === 'success') {
                statusMessage.classList.add('text-green-600');
            } else if (type === 'error') {
                statusMessage.classList.add('text-red-600');
            } else {
                statusMessage.classList.add('text-gray-600');
            }
        }
        
        // Tab-Wechsel-Funktionalität
        function showTab(tabId) {
            tabContents.forEach(content => content.classList.add('hidden'));
            tabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }

        // Unter-Tab-Wechsel-Funktionalität
        function showSubTab(subTabId) {
            subTabContents.forEach(content => content.classList.add('hidden'));
            subTabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(`${subTabId}-subtab`).classList.remove('hidden');
            document.getElementById(`${subTabId}-subtab-btn`).classList.add('active');
            
            // Wenn der Stundenplan-Sub-Tab angezeigt wird, lade die Daten
            if (subTabId === 'stundenplan') {
                renderAdminTimetableGrid(latestTimetable);
            } else if (subTabId === 'sol') {
                renderSolSubjectCheckboxes(latestSolSubjects);
            }
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.id.replace('-tab', ''));
            });
        });

        subTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showSubTab(button.id.replace('-subtab-btn', ''));
            });
        });

        /**
         * Renders the timetable table for the Wochenplan tab (teacher view).
         * @param {object} timetable The timetable data.
         * @param {object} solBlocks The SOL blocks data.
         */
        function renderWeeklyTimetableGrid(timetable, solBlocks) {
            let tableHTML = `
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="py-2 px-3 bg-gray-100 text-gray-600 font-bold uppercase text-xs rounded-tl-xl timetable-time-cell">Zeit / Tag</th>
                            ${daysOfWeek.map(day => `<th class="py-2 px-3 bg-gray-100 text-gray-600 font-bold uppercase text-xs">${day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            timeSlots.forEach(slot => {
                tableHTML += `<tr>
                    <td class="border-t border-gray-200 py-2 px-3 text-gray-700 font-semibold timetable-time-cell">${slot.time}</td>
                    ${daysOfWeek.map(day => {
                        const subjectName = timetable?.[day]?.[slot.time] || 'Frei';
                        const subject = subjects.find(s => s.name === subjectName) || subjects[0];
                        const block = solBlocks?.[day]?.[slot.time];
                        const isSol = latestSolSubjects.includes(subject.name);
                        
                        let cellContent;
                        let cellClass = `border-t border-gray-200 py-2 px-3 timetable-grid-cell cursor-pointer transition-colors`;
                        
                        if (isSol) {
                            if (block) {
                                // Blocked SOL lesson
                                cellClass += ` bg-slate-300 text-slate-800 font-bold`;
                                cellContent = `
                                    <div class="font-bold">${block.title}</div>
                                    <div class="text-xs text-slate-600">${block.type}</div>
                                `;
                            } else {
                                // Unblocked SOL lesson
                                cellClass += ` ${subject.lightColor} text-slate-800 font-medium hover:bg-slate-200`;
                                cellContent = 'SOL';
                            }
                        } else {
                            // Regular lesson
                            cellClass += ` ${subject.lightColor} ${subject.textColor} font-medium`;
                            cellContent = subject.name;
                        }

                        return `<td class="${cellClass}" data-day="${day}" data-slot="${slot.time}" data-is-sol="${isSol}">${cellContent}</td>`;
                    }).join('')}
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            weeklyTimetableContainer.innerHTML = tableHTML;
        }

        /**
         * Renders the timetable table for the Verwaltung tab (admin view).
         * @param {object} savedTimetable The timetable data.
         */
        function renderAdminTimetableGrid(savedTimetable) {
            let tableHTML = `
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="py-2 px-3 bg-gray-100 text-gray-600 font-bold uppercase text-xs rounded-tl-xl timetable-time-cell">Zeit / Tag</th>
                            ${daysOfWeek.map(day => `<th class="py-2 px-3 bg-gray-100 text-gray-600 font-bold uppercase text-xs">${day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;
            timeSlots.forEach(slot => {
                tableHTML += `<tr>
                    <td class="border-t border-gray-200 py-2 px-3 text-gray-700 font-semibold timetable-time-cell">${slot.time}</td>
                    ${daysOfWeek.map(day => {
                        const savedSubjectName = savedTimetable?.[day]?.[slot.time] || '';
                        return `
                            <td class="border-t border-gray-200 py-1 px-2">
                                <input 
                                    type="text" 
                                    class="w-full p-1 border border-gray-300 rounded-lg timetable-grid-cell focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                    list="subject-list" 
                                    value="${savedSubjectName}" 
                                    data-day="${day}" 
                                    data-slot="${slot.time}"
                                />
                            </td>
                        `;
                    }).join('')}
                </tr>`;
            });
            tableHTML += `</tbody></table>`;

            adminTimetableContainer.innerHTML = tableHTML;
            
            // Create a datalist for subject suggestions
            const datalist = document.createElement('datalist');
            datalist.id = 'subject-list';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.name;
                datalist.appendChild(option);
            });
            document.body.appendChild(datalist);
        }

        /**
         * Renders the checkboxes for SOL subjects in the Verwaltung tab.
         * @param {string[]} solSubjects The list of current SOL subjects.
         */
        function renderSolSubjectCheckboxes(solSubjects) {
            solSubjectsContainer.innerHTML = '';
            
            // Filter out 'Frei' and 'SOL' subjects as they cannot be selected as SOL
            const selectableSubjects = subjects.filter(s => s.name !== 'Frei' && s.name !== 'SOL');
            
            selectableSubjects.forEach(subject => {
                const isChecked = solSubjects.includes(subject.name);
                const container = document.createElement('label');
                container.className = `flex items-center space-x-2 p-2 rounded-lg cursor-pointer transition-colors ${isChecked ? 'bg-indigo-100' : 'bg-gray-100 hover:bg-gray-200'}`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-checkbox h-4 w-4 text-indigo-600 rounded';
                checkbox.value = subject.name;
                checkbox.checked = isChecked;
                
                const span = document.createElement('span');
                span.className = 'text-sm font-medium text-gray-700';
                span.textContent = subject.name;
                
                container.appendChild(checkbox);
                container.appendChild(span);
                solSubjectsContainer.appendChild(container);
            });
        }
        
        /**
         * Saves the timetable from the admin view to Firestore.
         */
        async function saveTimetable() {
            if (!isAuthReady) {
                customAlert('Authentication not ready. Cannot save data.');
                return;
            }

            const updatedTimetable = {};
            document.querySelectorAll('#admin-timetable-container input').forEach(input => {
                const day = input.dataset.day;
                const slot = input.dataset.slot;
                const subject = input.value.trim();
                
                if (!updatedTimetable[day]) {
                    updatedTimetable[day] = {};
                }
                updatedTimetable[day][slot] = subject;
            });
            
            try {
                const timetableDocRef = doc(db, `artifacts/${appId}/public/data/timetables`, 'schoolTimetable');
                await setDoc(timetableDocRef, updatedTimetable);
                showStatusMessage('Stundenplan erfolgreich gespeichert!', 'success');
            } catch (error) {
                console.error('Error saving timetable:', error);
                customAlert('Fehler beim Speichern des Stundenplans. Bitte erneut versuchen.');
            }
        }
        
        /**
         * Saves the SOL subjects from the admin view to Firestore.
         */
        async function saveSolSubjects() {
            if (!isAuthReady) {
                customAlert('Authentication not ready. Cannot save data.');
                return;
            }

            const updatedSolSubjects = [];
            document.querySelectorAll('#sol-subjects-container input[type="checkbox"]:checked').forEach(checkbox => {
                updatedSolSubjects.push(checkbox.value);
            });
            
            try {
                const solSubjectsDocRef = doc(db, `artifacts/${appId}/public/data/settings`, 'solSubjects');
                await setDoc(solSubjectsDocRef, { subjects: updatedSolSubjects });
                showStatusMessage('SOL-Fächer erfolgreich gespeichert!', 'success');
            } catch (error) {
                console.error('Error saving SOL subjects:', error);
                customAlert('Fehler beim Speichern der SOL-Fächer. Bitte erneut versuchen.');
            }
        }

        // Event listeners for the admin section buttons
        saveTimetableBtn.addEventListener('click', saveTimetable);
        saveSolSubjectsBtn.addEventListener('click', saveSolSubjects);
        alertOkBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
        });

        // Event listener for opening the modal when clicking an SOL lesson
        weeklyTimetableContainer.addEventListener('click', (event) => {
            const cell = event.target.closest('td');
            if (cell && cell.dataset.isSol === 'true') {
                currentDay = cell.dataset.day;
                currentSlot = cell.dataset.slot;
                openSolBlockModal(currentDay, currentSlot);
            }
        });
        
        // Modal functions
        async function openSolBlockModal(day, slot) {
            const block = latestSolBlocks?.[day]?.[slot];
            
            if (block) {
                // Edit existing block
                modalTitle.textContent = "SOL-Lektion bearbeiten";
                blockTypeSelect.value = block.type;
                blockTitleInput.value = block.title;
                blockDescriptionTextarea.value = block.description;
                deleteSolBlockBtn.classList.remove('hidden');
            } else {
                // Create new block
                modalTitle.textContent = "SOL-Lektion blockieren";
                solBlockForm.reset();
                deleteSolBlockBtn.classList.add('hidden');
            }
            solBlockModal.classList.remove('hidden');
        }

        function closeSolBlockModal() {
            solBlockModal.classList.add('hidden');
            solBlockForm.reset();
        }

        // Save SOL block
        saveSolBlockBtn.addEventListener('click', async () => {
            const blockType = blockTypeSelect.value;
            const blockTitle = blockTitleInput.value.trim();
            const blockDescription = blockDescriptionTextarea.value.trim();

            if (!blockTitle) {
                customAlert('Bitte geben Sie einen Titel für die Lektion ein.');
                return;
            }
            
            const block = {
                type: blockType,
                title: blockTitle,
                description: blockDescription
            };
            
            const solBlocksDocRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
            
            const updatedBlocks = {
                ...latestSolBlocks,
                [currentDay]: {
                    ...(latestSolBlocks[currentDay] || {}),
                    [currentSlot]: block
                }
            };

            try {
                await setDoc(solBlocksDocRef, updatedBlocks);
                closeSolBlockModal();
                showStatusMessage('Lektion erfolgreich blockiert!', 'success');
            } catch (error) {
                console.error('Error saving SOL block:', error);
                customAlert('Fehler beim Speichern der Lektion. Bitte erneut versuchen.');
            }
        });

        // Delete SOL block
        deleteSolBlockBtn.addEventListener('click', async () => {
            confirmationModal.classList.remove('hidden');
        });

        // Confirmation handlers
        confirmYesBtn.addEventListener('click', async () => {
            confirmationModal.classList.add('hidden');
            
            const solBlocksDocRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
            const updatedBlocks = {
                ...latestSolBlocks,
                [currentDay]: {
                    ...(latestSolBlocks[currentDay] || {})
                }
            };
            delete updatedBlocks[currentDay][currentSlot];
            
            if (Object.keys(updatedBlocks[currentDay]).length === 0) {
                delete updatedBlocks[currentDay];
            }

            try {
                if (Object.keys(updatedBlocks).length === 0) {
                    await deleteDoc(solBlocksDocRef);
                } else {
                    await setDoc(solBlocksDocRef, updatedBlocks);
                }
                closeSolBlockModal();
                showStatusMessage('Lektion erfolgreich gelöscht!', 'success');
            } catch (error) {
                console.error('Error deleting SOL block:', error);
                customAlert('Fehler beim Löschen der Lektion. Bitte erneut versuchen.');
            }
        });

        confirmNoBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
        });

        // Cancel modal
        cancelSolBlockBtn.addEventListener('click', closeSolBlockModal);

        // Firestore real-time listeners for all data
        function setupFirestoreListeners() {
            if (!isAuthReady) {
                console.warn('Firestore listeners cannot be set up: Auth not ready.');
                return;
            }

            const timetableRef = doc(db, `artifacts/${appId}/public/data/timetables`, 'schoolTimetable');
            const solSubjectsRef = doc(db, `artifacts/${appId}/public/data/settings`, 'solSubjects');
            const solBlocksRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');

            // Timetable listener
            onSnapshot(timetableRef, (docSnap) => {
                latestTimetable = docSnap.exists() ? docSnap.data() : {};
                // Rerender both views with the new data
                renderWeeklyTimetableGrid(latestTimetable, latestSolBlocks);
                renderAdminTimetableGrid(latestTimetable);
            }, (error) => {
                console.error("Error fetching timetable:", error);
                showStatusMessage('Fehler beim Abrufen des Stundenplans.', 'error');
            });

            // SOL subjects listener
            onSnapshot(solSubjectsRef, (docSnap) => {
                latestSolSubjects = docSnap.exists() ? docSnap.data().subjects || [] : [];
                // Rerender both views with the new data
                renderWeeklyTimetableGrid(latestTimetable, latestSolBlocks);
                renderSolSubjectCheckboxes(latestSolSubjects);
            }, (error) => {
                console.error("Error fetching SOL subjects:", error);
                showStatusMessage('Fehler beim Abrufen der SOL-Fächer.', 'error');
            });

            // SOL blocks listener
            onSnapshot(solBlocksRef, (docSnap) => {
                latestSolBlocks = docSnap.exists() ? docSnap.data() : {};
                // Rerender the Wochenplan view with the new data
                renderWeeklyTimetableGrid(latestTimetable, latestSolBlocks);
            }, (error) => {
                console.error("Error fetching SOL blocks:", error);
            });
        }
        
        // Initialisierungsfunktion
        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const user = await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        unsubscribe();
                        resolve(user);
                    });
                });

                if (user) {
                    isAuthReady = true;
                    setupFirestoreListeners();
                } else {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            isAuthReady = true;
                            setupFirestoreListeners();
                        } catch (tokenError) {
                            console.error('Error with signInWithCustomToken:', tokenError);
                            try {
                                await signInAnonymously(auth);
                                isAuthReady = true;
                                setupFirestoreListeners();
                            } catch (anonError) {
                                console.error('Error with signInAnonymously:', anonError);
                                throw new Error('Anonyme Anmeldung fehlgeschlagen.');
                            }
                        }
                    } else {
                        try {
                            await signInAnonymously(auth);
                            isAuthReady = true;
                            setupFirestoreListeners();
                        } catch (anonError) {
                            console.error('Error with signInAnonymously:', anonError);
                            throw new Error('Anonyme Anmeldung fehlgeschlagen.');
                        }
                    }
                }
                
                // Show the default tab
                showTab('wochenplan');
                showSubTab('stundenplan'); // Ensure default subtab is shown for Verwaltung
            } catch (error) {
                console.error('Initialization error:', error);
                customAlert('Die Initialisierung ist fehlgeschlagen. Bitte versuchen Sie es später erneut.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeAppAndAuth);

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // Redirect or handle post-logout state
                customAlert('Sie wurden erfolgreich abgemeldet.');
            } catch (error) {
                console.error('Error during logout:', error);
                customAlert('Fehler beim Abmelden.');
            }
        });
    </script>
</body>
</html>
