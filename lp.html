<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOL - Lehrpersonen-Dashboard</title>
    <!-- Tailwind CSS CDN für modernes Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-container {
            background-color: #ffffff;
            background-image: radial-gradient(at 0% 0%, #a5b4fc 0, transparent 50%),
                              radial-gradient(at 100% 100%, #60a5fa 0, transparent 50%);
            background-size: 100% 100%;
            background-position: center;
        }
        .header-container {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Style für den aktiven Haupt-Tab */
        .tab-button.active {
            color: #4338ca;
            border-bottom-width: 3px;
            border-color: #4338ca;
            font-weight: 600;
        }
        /* Style für den aktiven Unter-Tab */
        .sub-tab-button.active {
            color: #4338ca;
            border-bottom-width: 2px;
            border-color: #4338ca;
            font-weight: 600;
        }
        /* CSS-Übergänge für reibungslose Tab-Wechsel */
        .tab-content, .sub-tab-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Angepasste, kompaktere Stile für die Stundenplan-Zellen */
        .timetable-grid-cell {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .timetable-time-cell {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            width: 100px;
        }
        /* Post-it-Stil für den Arbeitsplan */
        .post-it {
            background-color: #fcf19d; /* Helles Gelb für den Post-it-Effekt */
            transform: rotate(1deg);
            transition: transform 0.2s ease-in-out;
        }
        .post-it:hover {
            transform: rotate(-1deg);
        }
        .post-it-title {
            font-family: 'Poppins', sans-serif;
            color: #4b5563; /* graue Farbe */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header mit Titel und Abmelde-Button -->
    <header class="header-container py-4 px-6 md:px-10 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Lehrpersonen-Dashboard</h1>
        <button id="logoutBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300">
            Abmelden
        </button>
    </header>

    <!-- Hauptinhalt mit Tabs -->
    <main class="flex-1 flex items-center justify-center p-6 md:p-10">
        <div class="main-container max-w-6xl w-full p-8 md:p-12 rounded-3xl shadow-2xl">
            <!-- Haupt-Tab-Navigation -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex flex-wrap space-x-4 md:space-x-8" aria-label="Tabs">
                    <button id="wochenplan-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Wochenstundenplan
                    </button>
                    <button id="arbeitsplan-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Arbeitsplan
                    </button>
                    <button id="sus-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        SuS-Übersicht
                    </button>
                    <button id="verwaltung-tab" class="tab-button inline-flex items-center px-1 py-4 text-lg font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                        Verwaltung
                    </button>
                </nav>
            </div>

            <!-- Tab-Inhalte -->
            <div id="tab-content-container">
                <!-- Wochenstundenplan-Inhalt -->
                <div id="wochenplan-content" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Wochenstundenplan</h2>
                    <p class="text-gray-600">
                        Hier wird der Stundenplan für die aktuelle Woche angezeigt. Klicken Sie auf eine "SOL"-Lektion, um sie zu blockieren und eine Aktivität hinzuzufügen.
                    </p>
                    <div id="weekly-timetable-container" class="mt-6">
                        <!-- Stundenplan wird hier durch JS eingefügt -->
                        <div class="text-center text-gray-500 my-8">
                            <span class="animate-pulse">Stundenplan wird geladen...</span>
                        </div>
                    </div>
                </div>

                <!-- Arbeitsplan-Inhalt -->
                <div id="arbeitsplan-content" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Arbeitsplan</h2>
                    <p class="text-gray-600 mb-6">
                        Hier können Sie Aufträge für die SOL-Fächer hinzufügen.
                    </p>
                    <div id="sol-arbeitsplan-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Die Post-its werden hier von JS eingefügt -->
                        <div class="text-center text-gray-500 my-8 col-span-full">
                            <span class="animate-pulse">Arbeitspläne werden geladen...</span>
                        </div>
                    </div>
                </div>

                <!-- SuS-Übersicht-Inhalt -->
                <div id="sus-content" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">SuS-Übersicht</h2>
                    <p class="text-gray-600">
                        Hier erhalten Lehrpersonen einen Überblick über den Fortschritt der Schülerinnen und Schüler.
                    </p>
                </div>

                <!-- Verwaltung-Inhalt mit Unter-Tabs -->
                <div id="verwaltung-content" class="tab-content hidden">
                    <!-- Unter-Tab-Navigation -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8" aria-label="Sub-Tabs">
                            <button id="stundenplan-subtab-btn" class="sub-tab-button active inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                Stundenplan
                            </button>
                            <button id="sol-subtab-btn" class="sub-tab-button inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                SOL-Fächer
                            </button>
                            <button id="accounts-subtab-btn" class="sub-tab-button inline-flex items-center px-1 py-4 text-base font-medium text-gray-500 hover:text-gray-700 transition duration-200">
                                Accounts
                            </button>
                        </nav>
                    </div>

                    <!-- Unter-Tab-Inhalte -->
                    <div id="sub-tab-content-container">
                        <!-- Stundenplan-Verwaltung -->
                        <div id="stundenplan-subtab" class="sub-tab-content">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Stundenplan-Verwaltung</h2>
                            <p class="text-gray-600 mb-6">
                                Tragen Sie hier den Stundenplan für die ganze Woche ein. Die Änderungen werden gespeichert, sobald Sie auf den "Speichern"-Button klicken.
                            </p>
                            <div id="admin-timetable-container" class="overflow-x-auto">
                                <!-- Stundenplan-Tabelle wird hier durch JS eingefügt -->
                                <div class="text-center text-gray-500 my-8">
                                    <span class="animate-pulse">Stundenplan wird geladen...</span>
                                </div>
                            </div>
                            <div class="mt-8 flex flex-col md:flex-row items-center justify-between gap-4">
                                <button id="saveTimetableBtn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300">
                                    Stundenplan speichern
                                </button>
                                <div id="statusMessage" class="font-semibold text-sm"></div>
                            </div>
                        </div>

                        <!-- SOL-Fächer-Verwaltung -->
                        <div id="sol-subtab" class="sub-tab-content hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">SOL-Fächer-Verwaltung</h2>
                            <p class="text-gray-600 mb-6">
                                Wählen Sie aus, welche Fächer als "Selbstorganisiertes Lernen" (SOL) unterrichtet werden sollen. Im Stundenplan werden diese dann als "SOL" angezeigt.
                            </p>
                            <div id="sol-subjects-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <!-- Fächer-Checkboxen werden hier durch JS eingefügt -->
                                <div class="text-center text-gray-500 my-8 col-span-full">
                                    <span class="animate-pulse">SOL-Fächer werden geladen...</span>
                                </div>
                            </div>
                            <button id="saveSolSubjectsBtn" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300">
                                SOL-Fächer speichern
                            </button>
                        </div>
                        
                        <!-- Accounts-Verwaltung (Platzhalter) -->
                        <div id="accounts-subtab" class="sub-tab-content hidden">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Accounts-Verwaltung</h2>
                            <p class="text-gray-600">
                                Hier werden in Zukunft Accounts für Schülerinnen, Schüler und Lehrpersonen verwaltet.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal für SOL-Lektionen (im Stundenplan) -->
    <div id="sol-block-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full m-4">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">SOL-Lektion blockieren</h3>
            <form id="sol-block-form">
                <div class="mb-4">
                    <label for="block-type" class="block text-sm font-medium text-gray-700">Aktivitätstyp</label>
                    <select id="block-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Lernkontrolle">Lernkontrolle</option>
                        <option value="LP-Input">LP-Input</option>
                        <option value="Anderes">Anderes</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="block-title" class="block text-sm font-medium text-gray-700">Titel</label>
                    <input type="text" id="block-title" placeholder="Kurzer Titel für die Lektion" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-6">
                    <label for="block-description" class="block text-sm font-medium text-gray-700">Beschreibung</label>
                    <textarea id="block-description" rows="3" placeholder="Genaue Beschreibung, worum es geht" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-between">
                    <div>
                        <button type="button" id="save-sol-block-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-indigo-700 transition duration-300">
                            Speichern
                        </button>
                        <button type="button" id="cancel-sol-block-btn" class="ml-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-400 transition duration-300">
                            Abbrechen
                        </button>
                    </div>
                    <div>
                        <button type="button" id="delete-sol-block-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300 hidden">
                            Löschen
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal für Arbeitsplan-Aufträge (im Arbeitsplan-Tab) -->
    <div id="workplan-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full m-4">
            <h3 id="workplan-modal-title" class="text-2xl font-bold mb-4 text-gray-800">Auftrag hinzufügen</h3>
            <form id="workplan-form">
                <input type="hidden" id="workplan-subject-name">
                <input type="hidden" id="workplan-assignment-index">
                <div class="mb-4">
                    <label for="workplan-title" class="block text-sm font-medium text-gray-700">Titel des Auftrags</label>
                    <input type="text" id="workplan-title" placeholder="Z.B. Einführung in Brüche" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="mb-4">
                    <label for="workplan-grundanforderungen" class="block text-sm font-medium text-gray-700">Grundanforderungen</label>
                    <textarea id="workplan-grundanforderungen" rows="3" placeholder="Beschreiben Sie hier die Grundanforderungen" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="mb-6">
                    <label for="workplan-erweiterte-anforderungen" class="block text-sm font-medium text-gray-700">Erweiterte Anforderungen (optional)</label>
                    <textarea id="workplan-erweiterte-anforderungen" rows="3" placeholder="Beschreiben Sie hier die erweiterten Anforderungen" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-between">
                    <div>
                        <button type="button" id="save-workplan-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-indigo-700 transition duration-300">
                            Speichern
                        </button>
                        <button type="button" id="cancel-workplan-btn" class="ml-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-400 transition duration-300">
                            Abbrechen
                        </button>
                    </div>
                    <div>
                        <button type="button" id="delete-workplan-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300 hidden">
                            Löschen
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Benutzerdefinierte Bestätigungsbox (ersetzt window.confirm) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-[1000] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full m-4">
            <p id="confirmation-message" class="text-center text-lg font-medium mb-4">Sind Sie sicher?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-yes" class="bg-red-500 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-red-600 transition duration-300">
                    Ja
                </button>
                <button id="confirm-no" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-xl shadow hover:bg-gray-400 transition duration-300">
                    Nein
                </button>
            </div>
        </div>
    </div>
    
    <!-- Benutzerdefinierte Meldungsbox -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-[1001] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full m-4 text-center">
            <p id="alert-message" class="text-lg font-medium mb-4">Meldung</p>
            <button id="alert-ok-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow hover:bg-indigo-700 transition duration-300">
                OK
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore-Konfiguration (automatisch vom Canvas bereitgestellt)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBVRTrFbNL-jMpfWtDVv739vkuqrCY8PDw",
            authDomain: "selbstorganisiertes-lernen-7a.firebaseapp.com",
            projectId: "selbstorganisiertes-lernen-7a",
            storageBucket: "selbstorganisiertes-lernen-7a.appspot.com",
            messagingSenderId: "283834841911",
            appId: "1:283834841911:web:189c328bca0c2ec167b8b2"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialisieren Sie Firebase und Dienste
        let app, auth, db;
        let isAuthReady = false;
        let userId = null;

        // HTML-Element-Referenzen
        const logoutBtn = document.getElementById('logoutBtn');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const subTabButtons = document.querySelectorAll('.sub-tab-button');
        const subTabContents = document.querySelectorAll('.sub-tab-content');
        const weeklyTimetableContainer = document.getElementById('weekly-timetable-container');
        const adminTimetableContainer = document.getElementById('admin-timetable-container');
        const saveTimetableBtn = document.getElementById('saveTimetableBtn');
        const statusMessage = document.getElementById('statusMessage');
        const solSubjectsContainer = document.getElementById('sol-subjects-container');
        const saveSolSubjectsBtn = document.getElementById('saveSolSubjectsBtn');
        const solBlockModal = document.getElementById('sol-block-modal');
        const modalTitle = document.getElementById('modal-title');
        const solBlockForm = document.getElementById('sol-block-form');
        const saveSolBlockBtn = document.getElementById('save-sol-block-btn');
        const cancelSolBlockBtn = document.getElementById('cancel-sol-block-btn');
        const deleteSolBlockBtn = document.getElementById('delete-sol-block-btn');
        const solArbeitsplanContainer = document.getElementById('sol-arbeitsplan-container');
        const workplanModal = document.getElementById('workplan-modal');
        const workplanModalTitle = document.getElementById('workplan-modal-title');
        const workplanForm = document.getElementById('workplan-form');
        const saveWorkplanBtn = document.getElementById('save-workplan-btn');
        const cancelWorkplanBtn = document.getElementById('cancel-workplan-btn');
        const deleteWorkplanBtn = document.getElementById('delete-workplan-btn');
        const customAlertModal = document.getElementById('custom-alert-modal');
        const alertMessage = document.getElementById('alert-message');
        const alertOkBtn = document.getElementById('alert-ok-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYes = document.getElementById('confirm-yes');
        const confirmNo = document.getElementById('confirm-no');
        
        // Globale Variablen für Daten und Status
        let latestTimetable = {};
        let latestSolSubjects = [];
        let latestSolBlocks = {};
        let latestWorkplans = {};

        // Temporäre Daten für die Stundenplan-Verwaltung
        let tempTimetable = {};
        let selectedSolBlockTime = null;
        let selectedSolBlockDay = null;

        // Konstanten für Fächer, Zeitfenster und Wochentage
        const subjects = [
            { name: 'Frei', color: 'bg-gray-200', lightColor: 'bg-gray-50', textColor: 'text-gray-700' },
            { name: 'SOL', color: 'bg-slate-300', lightColor: 'bg-slate-100', textColor: 'text-slate-800' },
            { name: 'Deutsch', color: 'bg-red-400', lightColor: 'bg-red-50', textColor: 'text-red-700' },
            { name: 'Englisch', color: 'bg-blue-400', lightColor: 'bg-blue-50', textColor: 'text-blue-700' },
            { name: 'Franzoesisch', color: 'bg-purple-400', lightColor: 'bg-purple-50', textColor: 'text-purple-700' },
            { name: 'Mathematik', color: 'bg-green-400', lightColor: 'bg-green-50', textColor: 'text-green-700' },
            { name: 'Natur und Technik', color: 'bg-yellow-400', lightColor: 'bg-yellow-50', textColor: 'text-yellow-700' },
            { name: 'NT / MI', color: 'bg-yellow-300', lightColor: 'bg-yellow-50', textColor: 'text-yellow-700' },
            { name: 'Raeume Zeiten Gesellschaften', color: 'bg-orange-400', lightColor: 'bg-orange-50', textColor: 'text-orange-700' },
            { name: 'Ethik Religion Gemeinschaft', color: 'bg-pink-400', lightColor: 'bg-pink-50', textColor: 'text-pink-700' },
            { name: 'Bewegung und Sport', color: 'bg-red-500', lightColor: 'bg-red-50', textColor: 'text-red-700' },
            { name: 'Textiles und Technisches Gestalten', color: 'bg-indigo-400', lightColor: 'bg-indigo-50', textColor: 'text-indigo-700' },
            { name: 'Musik', color: 'bg-violet-400', lightColor: 'bg-violet-50', textColor: 'text-violet-700' },
            { name: 'Bildnerisches Gestalten', color: 'bg-teal-400', lightColor: 'bg-teal-50', textColor: 'text-teal-700' },
            { name: 'Lernatelier', color: 'bg-gray-400', lightColor: 'bg-gray-50', textColor: 'text-gray-700' },
            { name: 'Individuelle Vertiefung', color: 'bg-cyan-400', lightColor: 'bg-cyan-50', textColor: 'text-cyan-700' },
            { name: 'Wirtschaft, Arbeit, Haushalt', color: 'bg-amber-400', lightColor: 'bg-amber-50', textColor: 'text-amber-700' }
        ];

        const timeSlots = [
            { id: 1, time: '07:30 - 08:15' },
            { id: 2, time: '08:20 - 09:05' },
            { id: 3, time: '09:10 - 09:55' },
            { id: 4, time: '10:20 - 11:05' },
            { id: 5, time: '11:10 - 11:55' },
            { id: 6, time: '12:10 - 12:55' },
            { id: 7, time: '13:00 - 13:45' },
            { id: 8, time: '13:50 - 14:35' },
            { id: 9, time: '14:40 - 15:25' },
            { id: 10, time: '15:40 - 16:25' },
            { id: 11, time: '16:30 - 17:15' }
        ];

        const daysOfWeek = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];

        // Initialisierung des Stundenplans für die Verwaltung
        function initAdminTimetable(currentTimetable) {
            tempTimetable = JSON.parse(JSON.stringify(currentTimetable));
            renderAdminTimetable(tempTimetable);
        }

        /**
         * Zeigt ein benutzerdefiniertes Meldungsmodal an.
         * @param {string} message Die anzuzeigende Meldung.
         */
        function customAlert(message) {
            alertMessage.textContent = message;
            customAlertModal.classList.remove('hidden');
        }

        // Event-Listener für das Meldungsmodal
        alertOkBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
        });

        /**
         * Zeigt ein benutzerdefiniertes Bestätigungsmodal an.
         * @param {string} message Die anzuzeigende Meldung.
         * @returns {Promise<boolean>} Resolves with true for 'Ja', false for 'Nein'.
         */
        function customConfirm(message) {
            return new Promise((resolve) => {
                confirmationMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                confirmYes.onclick = () => {
                    confirmationModal.classList.add('hidden');
                    resolve(true);
                };
                confirmNo.onclick = () => {
                    confirmationModal.classList.add('hidden');
                    resolve(false);
                };
            });
        }

        // Haupt-Tab-Wechsel-Funktionalität
        function showTab(tabId) {
            tabContents.forEach(content => content.classList.add('hidden'));
            tabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            if (tabId === 'wochenplan') {
                // Bei Wechsel zum Wochenplan den Stundenplan neu rendern, um die neuesten Daten anzuzeigen
                renderWeeklyTimetableGrid(latestTimetable, latestSolSubjects, latestSolBlocks);
            } else if (tabId === 'verwaltung') {
                // Bei Wechsel zur Verwaltung den Admin-Stundenplan und SOL-Fächer neu rendern
                showSubTab('stundenplan');
                initAdminTimetable(latestTimetable);
                renderSolSubjectsAdmin(latestSolSubjects);
            } else if (tabId === 'arbeitsplan') {
                renderWorkplans(latestWorkplans);
            }
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.id.replace('-tab', ''));
            });
        });
        
        // Unter-Tab-Wechsel-Funktionalität für den Verwaltungs-Tab
        function showSubTab(tabId) {
            subTabContents.forEach(content => content.classList.add('hidden'));
            subTabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(`${tabId}-subtab`).classList.remove('hidden');
            document.getElementById(`${tabId}-subtab-btn`).classList.add('active');
        }

        subTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showSubTab(button.id.replace('-subtab-btn', ''));
            });
        });

        /**
         * Rendert die Stundenplan-Tabelle für den Wochenplan-Tab.
         * @param {object} timetable Die Stundenplan-Daten.
         * @param {string[]} solSubjects Die Liste der SOL-Fächer.
         * @param {object} solBlocks Die SOL-Block-Daten.
         */
        function renderWeeklyTimetableGrid(timetable, solSubjects, solBlocks) {
            let tableHTML = `
                <div class="timetable-grid-container border rounded-xl shadow-sm grid grid-cols-[100px_repeat(5,1fr)]">
                    <div class="timetable-header contents">
                        <div class="timetable-header-cell px-2 py-3 bg-gray-100 text-gray-500 font-semibold text-xs rounded-tl-xl flex items-center justify-center">Zeit / Tag</div>
                        ${daysOfWeek.map((day, index) => `<div class="timetable-header-cell px-2 py-3 bg-gray-100 text-gray-500 font-semibold text-xs ${index === 4 ? 'rounded-tr-xl' : ''}">${day}</div>`).join('')}
                    </div>
            `;
            timeSlots.forEach(slot => {
                tableHTML += `
                    <div class="timetable-row contents">
                        <div class="timetable-time-cell p-2 bg-gray-50 text-gray-700 font-medium text-xs flex flex-col justify-center text-center border-r border-gray-200">${slot.time.replace(' - ', '<br>')}</div>
                        ${daysOfWeek.map(day => {
                            const subjectName = timetable?.[day]?.[slot.time] || 'Frei';
                            const subject = subjects.find(s => s.name === subjectName) || subjects[0];
                            const block = solBlocks?.[day]?.[slot.time];
                            const isSol = solSubjects.includes(subject.name);
                            
                            let cellContent;
                            let cellClass = `p-2 border-b border-r border-gray-200 flex flex-col justify-center items-center text-center timetable-grid-cell ${subject.lightColor} ${subject.textColor} ${isSol ? 'cursor-pointer hover:bg-indigo-100 transition-colors' : ''}`;
                            
                            if (isSol) {
                                if (block) {
                                    // Geblockte SOL-Lektion
                                    cellClass = `p-2 border-b border-r border-gray-200 flex flex-col justify-center items-center text-center timetable-grid-cell bg-indigo-200 text-indigo-800 font-bold cursor-pointer hover:bg-indigo-300 transition-colors`;
                                    cellContent = `
                                        <div class="font-bold">${block.title}</div>
                                        <div class="text-xs text-indigo-600">${block.type}</div>
                                    `;
                                } else {
                                    // Normale SOL-Lektion
                                    cellClass = `p-2 border-b border-r border-gray-200 flex flex-col justify-center items-center text-center timetable-grid-cell ${subject.lightColor} ${subject.textColor} font-bold cursor-pointer hover:bg-indigo-100 transition-colors`;
                                    cellContent = `<div>${subject.name}</div>`;
                                }
                            } else {
                                // Reguläre Lektion
                                cellClass += ` ${subject.textColor} font-medium`;
                                cellContent = `<div>${subject.name.replace(' ', '<br>')}</div>`;
                            }

                            return `<div class="${cellClass}" data-day="${day}" data-time="${slot.time}">${cellContent}</div>`;
                        }).join('')}
                    </div>
                `;
            });
            tableHTML += `</div>`;
            weeklyTimetableContainer.innerHTML = tableHTML;
            
            // Event-Listener für das Öffnen des Modals
            weeklyTimetableContainer.querySelectorAll('.cursor-pointer').forEach(cell => {
                cell.addEventListener('click', () => {
                    selectedSolBlockDay = cell.dataset.day;
                    selectedSolBlockTime = cell.dataset.time;
                    openSolBlockModal(selectedSolBlockDay, selectedSolBlockTime);
                });
            });
        }
        
        // Rendert die Stundenplan-Tabelle für die Verwaltung
        function renderAdminTimetable(timetable) {
            let selectOptions = subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            let tableHTML = `
                <div class="timetable-grid-container border rounded-xl shadow-sm grid grid-cols-[100px_repeat(5,1fr)]">
                    <div class="timetable-header contents">
                        <div class="timetable-header-cell px-2 py-3 bg-gray-100 text-gray-500 font-semibold text-xs rounded-tl-xl flex items-center justify-center">Zeit / Tag</div>
                        ${daysOfWeek.map((day, index) => `<div class="timetable-header-cell px-2 py-3 bg-gray-100 text-gray-500 font-semibold text-xs ${index === 4 ? 'rounded-tr-xl' : ''}">${day}</div>`).join('')}
                    </div>
            `;
            timeSlots.forEach(slot => {
                tableHTML += `
                    <div class="timetable-row contents">
                        <div class="timetable-time-cell p-2 bg-gray-50 text-gray-700 font-medium text-xs flex flex-col justify-center text-center border-r border-gray-200">${slot.time.replace(' - ', '<br>')}</div>
                        ${daysOfWeek.map(day => {
                            const currentSubject = timetable?.[day]?.[slot.time] || 'Frei';
                            return `
                                <div class="p-2 border-b border-r border-gray-200 flex flex-col justify-center items-center text-center timetable-grid-cell">
                                    <select class="w-full p-1 border border-gray-300 rounded-md text-sm"
                                            data-day="${day}" data-time="${slot.time}">
                                        ${subjects.map(s => `<option value="${s.name}" ${s.name === currentSubject ? 'selected' : ''}>${s.name}</option>`).join('')}
                                    </select>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });
            tableHTML += `</div>`;
            adminTimetableContainer.innerHTML = tableHTML;

            // Event-Listener für Änderungen im Admin-Stundenplan
            adminTimetableContainer.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', (event) => {
                    const day = event.target.dataset.day;
                    const time = event.target.dataset.time;
                    const subject = event.target.value;
                    if (!tempTimetable[day]) {
                        tempTimetable[day] = {};
                    }
                    tempTimetable[day][time] = subject;
                });
            });
        }
        
        // Speichern des Stundenplans
        saveTimetableBtn.addEventListener('click', async () => {
            try {
                if (!isAuthReady) {
                    customAlert('Authentifizierung nicht bereit. Bitte versuchen Sie es erneut.');
                    return;
                }
                const docRef = doc(db, `artifacts/${appId}/public/data/timetables`, 'schoolTimetable');
                await setDoc(docRef, tempTimetable);
                statusMessage.textContent = 'Stundenplan erfolgreich gespeichert!';
                statusMessage.classList.remove('text-red-500');
                statusMessage.classList.add('text-green-500');
                setTimeout(() => { statusMessage.textContent = ''; }, 3000);
            } catch (error) {
                console.error("Fehler beim Speichern des Stundenplans:", error);
                statusMessage.textContent = 'Fehler beim Speichern.';
                statusMessage.classList.remove('text-green-500');
                statusMessage.classList.add('text-red-500');
            }
        });
        
        // Rendert die Checkboxen für die SOL-Fächer-Verwaltung
        function renderSolSubjectsAdmin(solSubjects) {
            const allSubjects = subjects.filter(s => s.name !== 'Frei' && s.name !== 'SOL');
            const subjectCheckboxesHTML = allSubjects.map(subject => `
                <div class="flex items-center">
                    <input type="checkbox" id="sol-subject-${subject.name}" value="${subject.name}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${solSubjects.includes(subject.name) ? 'checked' : ''}>
                    <label for="sol-subject-${subject.name}" class="ml-2 block text-sm font-medium text-gray-700">${subject.name}</label>
                </div>
            `).join('');
            solSubjectsContainer.innerHTML = subjectCheckboxesHTML;
        }

        // Speichern der SOL-Fächer
        saveSolSubjectsBtn.addEventListener('click', async () => {
            try {
                if (!isAuthReady) {
                    customAlert('Authentifizierung nicht bereit. Bitte versuchen Sie es erneut.');
                    return;
                }
                const selectedSubjects = Array.from(solSubjectsContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                const docRef = doc(db, `artifacts/${appId}/public/data/settings`, 'solSubjects');
                await setDoc(docRef, { subjects: selectedSubjects });
                customAlert('SOL-Fächer erfolgreich gespeichert.');
            } catch (error) {
                console.error("Fehler beim Speichern der SOL-Fächer:", error);
                customAlert('Fehler beim Speichern der SOL-Fächer.');
            }
        });

        // Öffnen des Modals zum Blockieren von SOL-Lektionen
        function openSolBlockModal(day, time) {
            const blockData = latestSolBlocks?.[day]?.[time];
            
            solBlockForm.reset();
            deleteSolBlockBtn.classList.add('hidden');
            modalTitle.textContent = `SOL-Lektion am ${day} um ${time}`;

            if (blockData) {
                document.getElementById('block-type').value = blockData.type || 'Anderes';
                document.getElementById('block-title').value = blockData.title || '';
                document.getElementById('block-description').value = blockData.description || '';
                deleteSolBlockBtn.classList.remove('hidden');
            }
            
            solBlockModal.classList.remove('hidden');
        }

        // Schließen des SOL-Block-Modals
        cancelSolBlockBtn.addEventListener('click', () => {
            solBlockModal.classList.add('hidden');
        });
        
        // Speichern eines SOL-Blocks
        saveSolBlockBtn.addEventListener('click', async () => {
            if (!selectedSolBlockDay || !selectedSolBlockTime) return;

            const blockData = {
                type: document.getElementById('block-type').value,
                title: document.getElementById('block-title').value,
                description: document.getElementById('block-description').value,
            };

            if (!blockData.title || !blockData.description) {
                customAlert('Bitte geben Sie einen Titel und eine Beschreibung ein.');
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
                const docSnap = await getDoc(docRef);
                const currentBlocks = docSnap.exists() ? docSnap.data() : {};
                
                const updatedBlocks = {
                    ...currentBlocks,
                    [selectedSolBlockDay]: {
                        ...currentBlocks[selectedSolBlockDay],
                        [selectedSolBlockTime]: blockData,
                    },
                };

                await setDoc(docRef, updatedBlocks);
                solBlockModal.classList.add('hidden');
                customAlert('SOL-Lektion erfolgreich blockiert.');
            } catch (error) {
                console.error("Fehler beim Speichern des Blocks:", error);
                customAlert('Fehler beim Speichern des Blocks.');
            }
        });
        
        // Löschen eines SOL-Blocks
        deleteSolBlockBtn.addEventListener('click', async () => {
            if (!selectedSolBlockDay || !selectedSolBlockTime) return;
            const confirm = await customConfirm('Möchten Sie diesen SOL-Block wirklich löschen?');
            if (!confirm) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
                const docSnap = await getDoc(docRef);
                const currentBlocks = docSnap.exists() ? docSnap.data() : {};
                
                if (currentBlocks[selectedSolBlockDay] && currentBlocks[selectedSolBlockDay][selectedSolBlockTime]) {
                    delete currentBlocks[selectedSolBlockDay][selectedSolBlockTime];
                    // Wenn der Tag jetzt leer ist, entfernen wir ihn ganz
                    if (Object.keys(currentBlocks[selectedSolBlockDay]).length === 0) {
                        delete currentBlocks[selectedSolBlockDay];
                    }
                }

                await setDoc(docRef, currentBlocks);
                solBlockModal.classList.add('hidden');
                customAlert('SOL-Block erfolgreich gelöscht.');
            } catch (error) {
                console.error("Fehler beim Löschen des Blocks:", error);
                customAlert('Fehler beim Löschen des Blocks.');
            }
        });

        // Rendert die Arbeitsplan-Post-its
        function renderWorkplans(workplans) {
            solArbeitsplanContainer.innerHTML = '';
            const allSubjects = subjects.filter(s => s.name !== 'Frei' && s.name !== 'SOL');
            
            allSubjects.forEach(subject => {
                const assignments = workplans[subject.name] || [];
                let assignmentsHtml = '';
                if (assignments.length > 0) {
                    assignmentsHtml = `
                        <ul class="list-disc ml-5 mt-2">
                            ${assignments.map((assignment, index) => `
                                <li class="mb-2 cursor-pointer hover:underline" data-subject="${subject.name}" data-index="${index}">
                                    <div class="font-semibold text-lg">${assignment.title}</div>
                                    <div class="text-sm">Grundanforderungen: ${assignment.grundanforderungen.substring(0, 50)}...</div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                } else {
                    assignmentsHtml = `<p class="text-gray-500 italic mt-4">Noch keine Aufträge vorhanden.</p>`;
                }

                const postItHtml = `
                    <div class="post-it p-6 rounded-lg shadow-lg flex flex-col justify-between">
                        <div>
                            <h3 class="post-it-title text-2xl font-bold mb-4">${subject.name}</h3>
                            ${assignmentsHtml}
                        </div>
                        <button class="mt-4 bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300" data-subject="${subject.name}">
                            Neuen Auftrag hinzufügen
                        </button>
                    </div>
                `;
                solArbeitsplanContainer.innerHTML += postItHtml;
            });
            
            // Event-Listener für das Hinzufügen/Bearbeiten von Aufträgen
            solArbeitsplanContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    openWorkplanModal(button.dataset.subject);
                });
            });
            solArbeitsplanContainer.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', () => {
                    const subjectName = li.dataset.subject;
                    const index = parseInt(li.dataset.index, 10);
                    openWorkplanModal(subjectName, index);
                });
            });
        }
        
        // Öffnen des Modals zum Hinzufügen/Bearbeiten von Arbeitsplan-Aufträgen
        function openWorkplanModal(subjectName, index = null) {
            workplanForm.reset();
            document.getElementById('workplan-subject-name').value = subjectName;
            document.getElementById('workplan-assignment-index').value = index !== null ? index : '';
            workplanModalTitle.textContent = index !== null ? `Auftrag bearbeiten (${subjectName})` : `Neuen Auftrag hinzufügen (${subjectName})`;
            deleteWorkplanBtn.classList.add('hidden');
            
            if (index !== null) {
                const assignment = latestWorkplans?.[subjectName]?.[index];
                if (assignment) {
                    document.getElementById('workplan-title').value = assignment.title;
                    document.getElementById('workplan-grundanforderungen').value = assignment.grundanforderungen;
                    document.getElementById('workplan-erweiterte-anforderungen').value = assignment.erweiterteAnforderungen || '';
                    deleteWorkplanBtn.classList.remove('hidden');
                }
            }
            
            workplanModal.classList.remove('hidden');
        }

        // Schließen des Workplan-Modals
        cancelWorkplanBtn.addEventListener('click', () => {
            workplanModal.classList.add('hidden');
        });
        
        // Speichern oder Aktualisieren eines Arbeitsplan-Auftrags
        saveWorkplanBtn.addEventListener('click', async () => {
            const subjectName = document.getElementById('workplan-subject-name').value;
            const index = document.getElementById('workplan-assignment-index').value;
            
            const newAssignment = {
                title: document.getElementById('workplan-title').value,
                grundanforderungen: document.getElementById('workplan-grundanforderungen').value,
                erweiterteAnforderungen: document.getElementById('workplan-erweiterte-anforderungen').value,
            };

            if (!newAssignment.title || !newAssignment.grundanforderungen) {
                customAlert('Bitte geben Sie mindestens Titel und Grundanforderungen ein.');
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/workplans`, 'solWorkplans');
                const docSnap = await getDoc(docRef);
                const currentWorkplans = docSnap.exists() ? docSnap.data() : {};
                
                const updatedWorkplans = { ...currentWorkplans };
                if (!updatedWorkplans[subjectName]) {
                    updatedWorkplans[subjectName] = [];
                }

                if (index !== '') {
                    updatedWorkplans[subjectName][parseInt(index, 10)] = newAssignment;
                } else {
                    updatedWorkplans[subjectName].push(newAssignment);
                }

                await setDoc(docRef, updatedWorkplans);
                workplanModal.classList.add('hidden');
                customAlert('Auftrag erfolgreich gespeichert.');
            } catch (error) {
                console.error("Fehler beim Speichern des Auftrags:", error);
                customAlert('Fehler beim Speichern des Auftrags.');
            }
        });
        
        // Löschen eines Arbeitsplan-Auftrags
        deleteWorkplanBtn.addEventListener('click', async () => {
            const subjectName = document.getElementById('workplan-subject-name').value;
            const index = document.getElementById('workplan-assignment-index').value;
            
            if (index === '') return;
            const confirm = await customConfirm('Möchten Sie diesen Auftrag wirklich löschen?');
            if (!confirm) return;

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/workplans`, 'solWorkplans');
                const docSnap = await getDoc(docRef);
                const currentWorkplans = docSnap.exists() ? docSnap.data() : {};
                
                if (currentWorkplans[subjectName]) {
                    currentWorkplans[subjectName].splice(parseInt(index, 10), 1);
                    if (currentWorkplans[subjectName].length === 0) {
                        delete currentWorkplans[subjectName];
                    }
                }

                await setDoc(docRef, currentWorkplans);
                workplanModal.classList.add('hidden');
                customAlert('Auftrag erfolgreich gelöscht.');
            } catch (error) {
                console.error("Fehler beim Löschen des Auftrags:", error);
                customAlert('Fehler beim Löschen des Auftrags.');
            }
        });


        // Firestore-Echtzeit-Listener für alle Daten
        function setupFirestoreListeners() {
            if (!isAuthReady) {
                console.warn('Firestore-Listener können nicht eingerichtet werden: Authentifizierung nicht bereit.');
                return;
            }
            
            // Öffentliche Daten
            const timetableRef = doc(db, `artifacts/${appId}/public/data/timetables`, 'schoolTimetable');
            const solSubjectsRef = doc(db, `artifacts/${appId}/public/data/settings`, 'solSubjects');
            const solBlocksRef = doc(db, `artifacts/${appId}/public/data/solBlocks`, 'weeklyBlocks');
            const workplansRef = doc(db, `artifacts/${appId}/public/data/workplans`, 'solWorkplans');

            // Stundenplan-Listener
            onSnapshot(timetableRef, (docSnap) => {
                latestTimetable = docSnap.exists() ? docSnap.data() : {};
                if (document.getElementById('wochenplan-content').classList.contains('active')) {
                    renderWeeklyTimetableGrid(latestTimetable, latestSolSubjects, latestSolBlocks);
                }
                if (document.getElementById('stundenplan-subtab').classList.contains('active')) {
                    initAdminTimetable(latestTimetable);
                }
            }, (error) => {
                console.error("Fehler beim Abrufen des Stundenplans:", error);
                customAlert('Fehler beim Abrufen des Stundenplans.');
            });

            // SOL-Fächer-Listener
            onSnapshot(solSubjectsRef, (docSnap) => {
                latestSolSubjects = docSnap.exists() ? docSnap.data().subjects || [] : [];
                if (document.getElementById('wochenplan-content').classList.contains('active')) {
                    renderWeeklyTimetableGrid(latestTimetable, latestSolSubjects, latestSolBlocks);
                }
                if (document.getElementById('sol-subtab').classList.contains('active')) {
                    renderSolSubjectsAdmin(latestSolSubjects);
                }
            }, (error) => {
                console.error("Fehler beim Abrufen der SOL-Fächer:", error);
                customAlert('Fehler beim Abrufen der SOL-Fächer.');
            });

            // SOL-Blöcke-Listener
            onSnapshot(solBlocksRef, (docSnap) => {
                latestSolBlocks = docSnap.exists() ? docSnap.data() : {};
                if (document.getElementById('wochenplan-content').classList.contains('active')) {
                    renderWeeklyTimetableGrid(latestTimetable, latestSolSubjects, latestSolBlocks);
                }
            }, (error) => {
                console.error("Fehler beim Abrufen der SOL-Blöcke:", error);
            });
            
            // Arbeitsplan-Listener
            onSnapshot(workplansRef, (docSnap) => {
                latestWorkplans = docSnap.exists() ? docSnap.data() : {};
                if (document.getElementById('arbeitsplan-content').classList.contains('active')) {
                    renderWorkplans(latestWorkplans);
                }
            }, (error) => {
                console.error("Fehler beim Abrufen der Arbeitspläne:", error);
            });
        }
        
        // Initialisierungsfunktion
        async function initializeAppAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const user = await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        unsubscribe();
                        resolve(user);
                    });
                });

                if (user) {
                    isAuthReady = true;
                    userId = user.uid;
                    setupFirestoreListeners();
                } else {
                    if (initialAuthToken) {
                        try {
                            const credential = await signInWithCustomToken(auth, initialAuthToken);
                            isAuthReady = true;
                            userId = credential.user.uid;
                            setupFirestoreListeners();
                        } catch (tokenError) {
                            console.error('Error with signInWithCustomToken:', tokenError);
                            try {
                                const anonCredential = await signInAnonymously(auth);
                                isAuthReady = true;
                                userId = anonCredential.user.uid;
                                setupFirestoreListeners();
                            } catch (anonError) {
                                console.error('Error with signInAnonymously:', anonError);
                                throw new Error('Anonyme Anmeldung fehlgeschlagen.');
                            }
                        }
                    } else {
                        try {
                            const anonCredential = await signInAnonymously(auth);
                            isAuthReady = true;
                            userId = anonCredential.user.uid;
                            setupFirestoreListeners();
                        } catch (anonError) {
                            console.error('Error with signInAnonymously:', anonError);
                            throw new Error('Anonyme Anmeldung fehlgeschlagen.');
                        }
                    }
                }
                
                // Den Standard-Tab anzeigen
                showTab('wochenplan');
            } catch (error) {
                console.error('Initialisierungsfehler:', error);
                customAlert('Die Initialisierung ist fehlgeschlagen. Bitte versuchen Sie es später erneut.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeAppAndAuth);

        // Abmelde-Funktionalität
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                customAlert('Sie wurden erfolgreich abgemeldet.');
            } catch (error) {
                console.error('Fehler beim Abmelden:', error);
                customAlert('Fehler beim Abmelden.');
            }
        });
    </script>
</body>
</html>
