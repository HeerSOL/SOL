<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP Beurteilungsportal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modals */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modern-button {
            transition: all 0.2s ease-in-out;
        }
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .modern-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        /* Progress Bar Styling */
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 9999px; /* Full rounded corners */
            overflow: hidden;
            height: 24px; /* Fixed height for the bar */
            display: flex;
        }
        .progress-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            transition: width 0.5s ease-in-out;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: clip; /* Clip text that overflows */
        }
        .segment-red { background-color: #ef4444; } /* Tailwind red-500 */
        .segment-yellow { background-color: #f59e0b; } /* Tailwind amber-500 */
        .segment-green { background-color: #22c55e; } /* Tailwind green-500 */
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md text-center">
            <div class="w-12 h-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Firebase wird geladen...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-96">
            <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">LP Beurteilungsportal Login</h1>
            <div>
                <div class="mb-4">
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Passwort</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                </div>
                <button id="loginButton" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 modern-button text-lg font-semibold">
                    Anmelden
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="min-h-screen hidden">
        <div class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-3xl font-bold text-gray-900">LP Beurteilungsportal</h1>
                    <div class="flex items-center space-x-4">
                        <span id="userEmail" class="text-base text-gray-600 font-medium"></span>
                        <button id="logoutButton" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 p-2 rounded-md hover:bg-gray-100 transition-colors modern-button">
                            <span>Abmelden</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <!-- Tabs for Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-8 px-6">
                        <button data-tab="subjects" class="tab-button py-4 px-2 border-b-2 font-medium text-base border-transparent text-gray-500 hover:text-gray-700 transition-colors">
                            üìö F√§cher & Lernziele
                        </button>
                        <button data-tab="students" class="tab-button py-4 px-2 border-b-2 font-medium text-base border-transparent text-gray-500 hover:text-gray-700 transition-colors">
                            üßë‚Äçüéì Sch√ºler-Beurteilung
                        </button>
                    </nav>
                </div>

                <!-- Main Content Views -->
                <div id="mainContentViews">
                    <!-- Subjects Overview Tab Content -->
                    <div id="subjects-overview-view" class="main-view hidden">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">F√§cher & Lernziele definieren</h2>
                        <div id="subjectsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <!-- Subjects will be rendered here -->
                        </div>
                    </div>

                    <!-- Subject Detail View -->
                    <div id="subject-detail-view" class="main-view hidden">
                        <button id="backToSubjectsButton" class="modern-button px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 mb-6">
                            ‚Üê Zur√ºck zu F√§chern
                        </button>
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Lernziele f√ºr <span id="subjectDetailName" class="font-bold"></span></h2>
                        <div class="mb-4">
                            <button id="addLearningGoalButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 modern-button">
                                + Lernziel hinzuf√ºgen
                            </button>
                        </div>
                        <div id="learningGoalsList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                            <!-- Learning goals will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Students Overview Tab Content -->
                    <div id="students-overview-view" class="main-view hidden">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Sch√ºler-Beurteilung</h2>
                        <p class="text-gray-600 mb-6">W√§hlen Sie einen Sch√ºler, um seine Beurteilungen zu verwalten.</p>
                        <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <!-- Student cards will be rendered here -->
                        </div>
                        <p id="noStudentsMessage" class="text-gray-500 text-center mt-8 hidden">
                            Es sind noch keine Sch√ºler-Accounts vorhanden.
                        </p>
                    </div>

                    <!-- Student Detail View (List of Subjects for a Student) -->
                    <div id="student-detail-view" class="main-view hidden">
                        <button id="backToStudentsButton" class="modern-button px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 mb-6">
                            ‚Üê Zur√ºck zu Sch√ºlern
                        </button>
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Beurteilungs√ºbersicht f√ºr <span id="studentDetailName" class="font-bold"></span></h2>
                        <div id="studentSubjectOverview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Subject overview cards for the student will be rendered here -->
                        </div>
                    </div>

                    <!-- Student Subject Assessment View (Assess Learning Goals for a Student in a Specific Subject) -->
                    <div id="student-subject-assessment-view" class="main-view hidden">
                        <button id="backToStudentOverviewButton" class="modern-button px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 mb-6">
                            ‚Üê Zur√ºck zur Sch√ºler√ºbersicht
                        </button>
                        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Beurteilung f√ºr <span id="assessmentStudentName" class="font-bold"></span> in <span id="assessmentSubjectName" class="font-bold"></span></h2>

                        <div id="assessmentLearningGoalsList" class="space-y-6 mb-8">
                            <!-- Learning goals with assessment options will be dynamically added here -->
                        </div>

                        <button id="saveStudentAssessmentButton" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 modern-button text-lg font-semibold">
                            Beurteilung speichern
                        </button>

                        <div class="mt-12 p-6 bg-gray-50 rounded-xl shadow-md">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800">Grafische Auswertungen (Platzhalter)</h3>
                            <p class="text-gray-600">Hier werden zuk√ºnftig Diagramme und detaillierte Auswertungen zur Lernzielerreichung angezeigt.</p>
                            <div class="mt-4 text-center text-gray-400">
                                <div class="text-5xl mb-2">üìä</div>
                                <p>Diagramme werden hier generiert.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Learning Goal Form Modal -->
    <div id="addEditLearningGoalModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-[100]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4 text-gray-900" id="addEditLearningGoalModalTitle">Lernziel hinzuf√ºgen</h3>
            <form id="learningGoalForm" class="space-y-4">
                <div>
                    <label for="lgDescription" class="block text-sm font-medium text-gray-700">Beschreibung</label>
                    <input type="text" id="lgDescription" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="lgType" class="block text-sm font-medium text-gray-700">Typ</label>
                    <select id="lgType" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="GA">Grundanforderung (GA)</option>
                        <option value="EA">Erweiterte Anforderung (EA)</option>
                    </select>
                </div>
                <div>
                    <label for="lgWeight" class="block text-sm font-medium text-gray-700">Gewichtung</label>
                    <input type="number" id="lgWeight" min="1" value="1" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelLearningGoalForm" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 modern-button">Abbrechen</button>
                    <button type="submit" id="saveLearningGoalButton" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 modern-button">Speichern</button>
                    <button type="button" id="deleteLearningGoalButton" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden modern-button">L√∂schen</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Custom Message Modal -->
    <div id="customMessageModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-[9999]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="customMessageTitle" class="text-xl font-semibold mb-4 text-gray-900"></h3>
            <p id="customMessageContent" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="customMessageCloseButton" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 modern-button">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-[9999]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="customConfirmTitle" class="text-xl font-semibold mb-4 text-gray-900">Best√§tigung</h3>
            <p id="customConfirmContent" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="customConfirmCancelButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 modern-button">Abbrechen</button>
                <button id="customConfirmOkButton" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 modern-button">L√∂schen</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, getDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app;
        let auth;
        let db;
        let user = null; // Firebase user object
        let userId = null; // User ID (UID)
        let isAuthReady = false; // Flag to ensure Firestore operations wait for auth

        // Global variables provided by the Canvas environment (if applicable)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Log the current appId for debugging
        console.log('Aktuelle App ID:', appId);


        // Ihre Firebase-Konfiguration (direkt eingef√ºgt)
        const firebaseConfig = {
            apiKey: "AIzaSyAsexnWyCjkYz8kfAPd7Od1g0xsfcSEKRk",
            authDomain: "sol-portal-cf905.firebaseapp.com",
            projectId: "sol-portal-cf905",
            storageBucket: "sol-portal-cf905.firebasestorage.app",
            messagingSenderId: "478097533058",
            appId: "1:478097533058:web:b2afa0a73892b90d8a2c9b",
            measurementId: "G-JJ3RRJNK7T"
        };

        let activeTab = 'subjects'; // Default tab for LP portal
        let activeView = 'subjects-overview-view'; // Default sub-view within tabs
        let lpAccounts = [];
        let susAccounts = [];
        let currentSubjectForGoals = null; // Stores the subject currently being edited for learning goals (general)
        let learningGoals = []; // Stores learning goals for the current subject (general)
        let currentStudentForAssessment = null; // Stores the student object (id, name) currently being assessed
        let currentSubjectForStudentAssessment = null; // Stores the subject name for the current student assessment
        let studentAssessments = {}; // Stores the assessment status for each learning goal for the current student/subject

        const subjects = [
            { name: 'Deutsch', color: 'bg-red-500' },
            { name: 'Englisch', color: 'bg-blue-500' },
            { name: 'Franzoesisch', color: 'bg-purple-500' },
            { name: 'Mathematik', color: 'bg-green-500' },
            { name: 'Natur und Technik', color: 'bg-yellow-500' },
            { name: 'Wirtschaft, Arbeit, Haushalt', color: 'bg-amber-500' },
            { name: 'Raeume, Zeiten, Gesellschaften', color: 'bg-orange-500' },
            { name: 'Musik', color: 'bg-violet-500' },
            { name: 'Textiles Gestalten', color: 'bg-indigo-500' },
            { name: 'Technisches Gestalten', color: 'bg-pink-500' },
            { name: 'Bildnerisches Gestalten', color: 'bg-teal-500' },
            { name: 'Bewegung und Sport', color: 'bg-red-600' }
        ];

        // Helper function to determine contrasting text color
        function getContrastTextColor(bgColorClass) {
            // A more robust approach would calculate luminance, but for Tailwind classes,
            // we can map known light colors to dark text and assume others are dark enough for white.
            const lightColors = ['bg-yellow-500', 'bg-yellow-400', 'bg-teal-500', 'bg-blue-100', 'bg-gray-100'];
            if (lightColors.includes(bgColorClass)) {
                return 'text-gray-900'; // Use dark text for light backgrounds
            }
            return 'text-white'; // Use white text for other (assumed darker) backgrounds
        }

        // Helper to get a Firestore document (now using getDoc for a single fetch)
        async function getFirestoreDoc(dbInstance, collectionName, docId) {
            // Use the simplified path construction, assuming collectionName is top-level
            const docRef = doc(dbInstance, collectionName, docId);
            try {
                const docSnapshot = await getDoc(docRef);
                return docSnapshot;
            } catch (error) {
                console.error("Error fetching Firestore document:", error);
                throw error; // Re-throw the error for handling in the calling function
            }
        }

        // --- Firebase Initialization ---
        window.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (firebaseUser) => {
                    user = firebaseUser;
                    if (user) {
                        userId = user.uid;
                        // If a user is already logged in (e.g., session restored),
                        // verify if they are an LP and then show the main app.
                        // Adjusted path for lpAccounts to be root-level
                        const lpDoc = await getFirestoreDoc(db, 'lpAccounts', userId);
                        // IMPORTANT: Check for existence AND the role field
                        if (lpDoc.exists() && lpDoc.data().role === 'LP') {
                            showMainApp();
                            await loadUserData();
                        } else {
                            // If logged in user is NOT an LP, sign them out and show login screen
                            await signOut(auth);
                            showLoginScreen();
                            showCustomMessage('Dieser Account ist kein Lehrpersonen-Account. Bitte melden Sie sich mit einem g√ºltigen LP-Account an.', 'error', 'Zugriff verweigert');
                        }
                    } else {
                        // If no user is logged in, always show the login screen first.
                        showLoginScreen();
                    }
                    isAuthReady = true;
                    hideLoadingScreen();
                });

                initializeEventListeners();
                renderSubjectsGrid(); // Initial render of subjects overview
            } catch (error) {
                console.error('Fehler bei Firebase-Initialisierung:', error);
                showCustomMessage('Firebase-Initialisierung fehlgeschlagen: ' + error.message, 'error', 'Initialisierungsfehler');
                hideLoadingScreen();
            }
        }

        // --- UI State Management ---
        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = user ? user.email : 'Gast';
            // Initially show the subjects overview when main app loads
            switchTab(activeTab);
            navigateToView(activeView);
        }

        function switchTab(tabName) {
            activeTab = tabName;

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add('border-blue-500', 'text-blue-600');
                    button.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    button.classList.remove('border-blue-500', 'text-blue-600');
                    button.classList.add('border-transparent', 'text-gray-500');
                }
            });

            // Determine which sub-view to show based on the tab
            if (tabName === 'subjects') {
                activeView = 'subjects-overview-view';
            } else if (tabName === 'students') {
                activeView = 'students-overview-view';
            }
            navigateToView(activeView);
        }

        function navigateToView(viewId) {
            activeView = viewId;
            const allViews = document.querySelectorAll('.main-view');
            allViews.forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            // Specific actions for each view
            if (viewId === 'subjects-overview-view') {
                renderSubjectsGrid();
            } else if (viewId === 'students-overview-view') {
                updateStudentListDisplay();
            }
            // For detail views, content is rendered when navigating to them
        }


        // --- Custom Modals ---
        function showCustomMessage(message, type = 'info', title = 'Nachricht') {
            const modal = document.getElementById('customMessageModal');
            document.getElementById('customMessageTitle').textContent = title;
            document.getElementById('customMessageContent').textContent = message;
            modal.classList.remove('hidden');
        }

        function hideCustomMessage() {
            document.getElementById('customMessageModal').classList.add('hidden');
        }

        document.getElementById('customMessageCloseButton').addEventListener('click', hideCustomMessage);

        function showCustomConfirm(message, callback, title = 'Best√§tigen') {
            const modal = document.getElementById('customConfirmModal');
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmContent').textContent = message;
            modal.classList.remove('hidden');

            const okButton = document.getElementById('customConfirmOkButton');
            const cancelButton = document.getElementById('customConfirmCancelButton');

            okButton.onclick = null;
            cancelButton.onclick = null;

            okButton.onclick = () => {
                modal.classList.add('hidden');
                callback(true);
            };
            cancelButton.onclick = () => {
                modal.classList.add('hidden');
                callback(false);
            };
        }

        // --- Event Listeners ---
        function initializeEventListeners() {
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });

            document.getElementById('logoutButton').addEventListener('click', handleLogout);

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Learning Goal Detail View Listeners (for general subject learning goals)
            document.getElementById('backToSubjectsButton').addEventListener('click', () => navigateToView('subjects-overview-view'));
            document.getElementById('addLearningGoalButton').addEventListener('click', () => showAddEditLearningGoalModal());

            // Student Detail View Listeners (overview of subjects for a student)
            document.getElementById('backToStudentsButton').addEventListener('click', () => navigateToView('students-overview-view'));

            // Student Subject Assessment View Listeners
            document.getElementById('backToStudentOverviewButton').addEventListener('click', () => {
                // Return to the student's main overview page
                if (currentStudentForAssessment) {
                    showStudentDetailView(currentStudentForAssessment.id, currentStudentForAssessment.name);
                } else {
                    navigateToView('students-overview-view');
                }
            });
            document.getElementById('saveStudentAssessmentButton').addEventListener('click', handleSaveStudentAssessment);

            // Add/Edit Learning Goal Form Modal Listeners
            document.getElementById('learningGoalForm').addEventListener('submit', handleSaveLearningGoal);
            document.getElementById('cancelLearningGoalForm').addEventListener('click', hideAddEditLearningGoalModal);
            document.getElementById('deleteLearningGoalButton').addEventListener('click', handleDeleteLearningGoal);
        }

        // --- Authentication Handlers ---
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');

            if (!email || !password) {
                showCustomMessage('Bitte E-Mail und Passwort eingeben.', 'warning', 'Eingabe erforderlich');
                return;
            }

            button.disabled = true;
            button.textContent = 'Anmelden...';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const loggedInUserId = userCredential.user.uid;

                // NOW check if the user is an LP account after successful email/password login
                // Adjusted path for lpAccounts to be root-level
                const lpDoc = await getFirestoreDoc(db, 'lpAccounts', loggedInUserId);
                // IMPORTANT: Check for existence AND the role field
                if (lpDoc.exists() && lpDoc.data().role === 'LP') {
                            showMainApp(); // Show main app if LP
                            await loadUserData(); // Load data after successful LP login
                } else {
                    // If not an LP account, sign out immediately and show error.
                    await signOut(auth);
                    showCustomMessage('Dieser Account ist kein Lehrpersonen-Account. Bitte melden Sie sich mit einem g√ºltigen LP-Account an.', 'error', 'Zugriff verweigert');
                }
            } catch (error) {
                console.error("Login fehlgeschlagen:", error);
                showCustomMessage('Login fehlgeschlagen: ' + error.message, 'error', 'Login Fehler');
            } finally {
                button.disabled = false;
                button.textContent = 'Anmelden';
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                activeTab = 'subjects'; // Reset tab on logout
                activeView = 'subjects-overview-view'; // Reset view on logout
                navigateToView(activeView); // Show the default view
            } catch (error) {
                console.error("Error logging out:", error);
                showCustomMessage("Fehler beim Abmelden: " + error.message, 'error', 'Abmeldefehler');
            }
        }

        // --- Data Loading from Firestore ---
        async function loadUserData() {
            if (!isAuthReady || !userId) {
                console.warn("Auth not ready or user not logged in, skipping data load.");
                return;
            }

            // Listen to LP Accounts (public data) - Adjusted path
            onSnapshot(collection(db, 'lpAccounts'), (querySnapshot) => {
                lpAccounts = [];
                querySnapshot.forEach((doc) => {
                    lpAccounts.push({ id: doc.id, ...doc.data() });
                });
            }, (error) => {
                console.error("Error fetching LP accounts:", error);
                showCustomMessage("Fehler beim Laden der LP-Accounts: " + error.message, 'error', 'Ladefehler');
            });

            // Listen to SuS Accounts (public data) - Adjusted path
            onSnapshot(collection(db, 'susAccounts'), (querySnapshot) => {
                susAccounts = [];
                querySnapshot.forEach((doc) => {
                    susAccounts.push({ id: doc.id, ...doc.data() });
                });
                updateStudentListDisplay();
            }, (error) => {
                console.error("Error fetching SuS accounts:", error);
                showCustomMessage("Fehler beim Laden der SuS-Accounts: " + error.message, 'error', 'Ladefehler');
            });

            // Listeners for learning goals will be set up when subject detail view is opened
            // Listeners for student assessments will be up when student subject assessment view is opened
        }

        // --- Subjects & Learning Goals Tab ---
        function renderSubjectsGrid() {
            const subjectsGrid = document.getElementById('subjectsGrid');
            subjectsGrid.innerHTML = ''; // Clear existing subjects

            subjects.forEach(subject => {
                const subjectCard = document.createElement('div');
                // Use the helper function to get the correct text color
                const textColorClass = getContrastTextColor(subject.color);

                subjectCard.className = `bg-white rounded-xl shadow-lg p-6 cursor-pointer transform transition-transform hover:scale-105 ${subject.color} ${textColorClass} flex flex-col items-center justify-center text-center`;
                subjectCard.style.minHeight = '150px'; // Ensure cards have a consistent height
                subjectCard.setAttribute('data-subject-name', subject.name);
                subjectCard.innerHTML = `
                    <h3 class="text-xl font-bold mb-2">${subject.name}</h3>
                    <p class="text-sm opacity-90">Lernziele definieren</p>
                `;
                subjectCard.addEventListener('click', () => showSubjectDetailView(subject.name));
                subjectsGrid.appendChild(subjectCard);
            });
        }

        async function showSubjectDetailView(subjectName) {
            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um Lernziele zu verwalten.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            currentSubjectForGoals = subjectName;
            document.getElementById('subjectDetailName').textContent = subjectName;
            navigateToView('subject-detail-view');

            // Explicitly build the collection reference for learning goals
            const learningGoalsCollectionRef = collection(
                doc(
                    collection(
                        doc(db, 'artifacts', appId), // Path: artifacts/{appId} (Document)
                        'assessment_data' // Path: artifacts/{appId}/assessment_data (Collection)
                    ),
                    subjectName // Path: artifacts/{appId}/assessment_data/{subjectName} (Document)
                ),
                'learningGoals' // Path: artifacts/{appId}/assessment_data/{subjectName}/learningGoals (Collection)
            );
            console.log(`[showSubjectDetailView] Constructed learningGoalsCollectionRef path: artifacts/${appId}/assessment_data/${subjectName}/learningGoals`);


            onSnapshot(learningGoalsCollectionRef, (querySnapshot) => {
                console.log('onSnapshot triggered for general learning goals. Query Snapshot size:', querySnapshot.size);
                console.log('Documents in snapshot:', querySnapshot.docs.map(d => ({ id: d.id, ...d.data() })));

                learningGoals = [];
                querySnapshot.forEach((doc) => {
                    learningGoals.push({ id: doc.id, ...doc.data() });
                });
                console.log('General learning goals array AFTER onSnapshot update:', learningGoals);
                renderLearningGoalsList();
            }, (error) => {
                console.error("Error fetching learning goals:", error);
                showCustomMessage("Fehler beim Laden der Lernziele: " + error.message, 'error', 'Ladefehler');
            });
        }

        function renderLearningGoalsList() {
            const listContainer = document.getElementById('learningGoalsList');
            listContainer.innerHTML = ''; // Clear existing goals

            if (learningGoals.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Noch keine Lernziele f√ºr dieses Fach definiert.</p>';
                return;
            }

            learningGoals.forEach(goal => {
                const goalItem = document.createElement('div');
                goalItem.className = `bg-gray-50 p-4 rounded-lg shadow-sm flex items-center justify-between border-l-4 ${goal.type === 'GA' ? 'border-blue-400' : 'border-purple-400'}`;
                goalItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${goal.description}</p>
                        <p class="text-sm text-gray-600">
                            Typ: ${goal.type === 'GA' ? 'Grundanforderung (üîµ)' : 'Erweiterte Anforderung (‚≠ê)'} |
                            Gewichtung: ${goal.weight}
                        </p>
                    </div>
                    <button class="edit-goal-button text-blue-500 hover:text-blue-700 p-2 rounded-md hover:bg-blue-100 transition-colors" data-goal-id="${goal.id}">
                        Bearbeiten
                    </button>
                `;
                listContainer.appendChild(goalItem);

                goalItem.querySelector('.edit-goal-button').addEventListener('click', () => showAddEditLearningGoalModal(goal));
            });
        }

        function showAddEditLearningGoalModal(goal = null) {
            const modal = document.getElementById('addEditLearningGoalModal');
            const titleElement = document.getElementById('addEditLearningGoalModalTitle');
            const form = document.getElementById('learningGoalForm');
            const descriptionInput = document.getElementById('lgDescription');
            const typeSelect = document.getElementById('lgType');
            const weightInput = document.getElementById('lgWeight');
            const deleteButton = document.getElementById('deleteLearningGoalButton');

            form.reset(); // Clear form
            deleteButton.classList.add('hidden'); // Hide delete button by default
            form.dataset.goalId = ''; // Clear goal ID

            if (goal) {
                titleElement.textContent = 'Lernziel bearbeiten';
                descriptionInput.value = goal.description;
                typeSelect.value = goal.type;
                weightInput.value = goal.weight;
                deleteButton.classList.remove('hidden');
                form.dataset.goalId = goal.id; // Store goal ID for update/delete
            } else {
                titleElement.textContent = 'Lernziel hinzuf√ºgen';
                weightInput.value = 1; // Default weight for new goals
            }

            modal.classList.remove('hidden');
        }

        function hideAddEditLearningGoalModal() {
            document.getElementById('addEditLearningGoalModal').classList.add('hidden');
            document.getElementById('learningGoalForm').reset();
            document.getElementById('learningGoalForm').dataset.goalId = '';
        }

        async function handleSaveLearningGoal(event) {
            event.preventDefault();

            if (!isAuthReady || !user) {
                showCustomMessage("Fehler: Nicht angemeldet oder keine Berechtigung.", 'error', 'Fehler');
                return;
            }

            if (!currentSubjectForGoals) {
                showCustomMessage("Fehler: Kein Fach ausgew√§hlt, f√ºr das Lernziele gespeichert werden sollen.", 'error', 'Fehler');
                return;
            }

            const form = document.getElementById('learningGoalForm');
            const description = document.getElementById('lgDescription').value.trim();
            const type = document.getElementById('lgType').value;
            const weight = parseInt(document.getElementById('lgWeight').value);
            const goalId = form.dataset.goalId;

            if (!description || !type || isNaN(weight) || weight < 1) {
                showCustomMessage('Bitte alle Felder korrekt ausf√ºllen.', 'warning', 'Eingabe erforderlich');
                return;
            }

            const saveButton = document.getElementById('saveLearningGoalButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Speichern...';

            try {
                const goalData = {
                    description: description,
                    type: type,
                    weight: weight,
                    createdAt: new Date().toISOString(),
                    createdBy: user.email
                };

                // Explicitly build the document reference for saving/updating learning goals
                const learningGoalsCollectionRef = collection(
                    doc(
                        collection(
                            doc(db, 'artifacts', appId),
                            'assessment_data'
                        ),
                        currentSubjectForGoals
                    ),
                    'learningGoals'
                );

                const learningGoalDocRef = goalId ?
                    doc(learningGoalsCollectionRef, goalId) :
                    doc(learningGoalsCollectionRef);

                console.log(`[handleSaveLearningGoal] Constructed learningGoalDocRef path: artifacts/${appId}/assessment_data/${currentSubjectForGoals}/learningGoals/${goalId || '(new ID)'}`);


                if (goalId) {
                    console.log('Updating existing general learning goal with ID:', goalId, 'for subject:', currentSubjectForGoals, 'with data:', goalData);
                    await setDoc(learningGoalDocRef, goalData);
                    showCustomMessage('Lernziel erfolgreich aktualisiert!', 'success', 'Erfolg');
                } else {
                    console.log('Adding new general learning goal for subject:', currentSubjectForGoals, 'with data:', goalData);
                    await setDoc(learningGoalDocRef, goalData); // setDoc on a new docRef creates it
                    showCustomMessage('Lernziel erfolgreich hinzugef√ºgt!', 'success', 'Erfolg');
                }
                hideAddEditLearningGoalModal();
            } catch (error) {
                console.error("Error saving learning goal:", error);
                showCustomMessage('Fehler beim Speichern des Lernziels: ' + error.message, 'error', 'Speicherfehler');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Speichern';
            }
        }

        async function handleDeleteLearningGoal() {
            const form = document.getElementById('learningGoalForm');
            const goalIdToDelete = form.dataset.goalId;

            if (!isAuthReady || !user || !currentSubjectForGoals || !goalIdToDelete) {
                showCustomMessage("Kein Lernziel zum L√∂schen ausgew√§hlt oder keine Berechtigung.", 'warning', 'Fehler');
                return;
            }

            showCustomConfirm('Bist du sicher, dass du dieses Lernziel l√∂schen m√∂chtest? Dies kann nicht r√ºckg√§ngig gemacht werden.', async (confirmed) => {
                if (confirmed) {
                    const deleteButton = document.getElementById('deleteLearningGoalButton');
                    deleteButton.disabled = true;
                    deleteButton.textContent = 'L√∂schen...';

                    try {
                        // Explicitly build the document reference for deletion
                        const learningGoalDocRef = doc(
                            collection(
                                doc(
                                    collection(
                                        doc(db, 'artifacts', appId),
                                        'assessment_data'
                                    ),
                                    currentSubjectForGoals
                                ),
                                'learningGoals'
                            ),
                            goalIdToDelete
                        );
                        console.log('Deleting general learning goal with ID:', goalIdToDelete, 'from subject:', currentSubjectForGoals);
                        await deleteDoc(learningGoalDocRef);
                        showCustomMessage('Lernziel erfolgreich gel√∂scht!', 'success', 'Gel√∂scht');
                        hideAddEditLearningGoalModal();
                    } catch (error) {
                        console.error("Error deleting learning goal:", error);
                        showCustomMessage('Fehler beim L√∂schen des Lernziels: ' + error.message, 'error', 'L√∂schfehler');
                    } finally {
                        deleteButton.disabled = false;
                        deleteButton.textContent = 'L√∂schen';
                    }
                }
            }, 'Lernziel l√∂schen');
        }

        // --- Students Tab ---
        function updateStudentListDisplay() {
            const studentListContainer = document.getElementById('studentList');
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            studentListContainer.innerHTML = ''; // Clear existing cards

            if (susAccounts.length === 0) {
                noStudentsMessage.classList.remove('hidden');
                studentListContainer.classList.add('hidden');
            } else {
                noStudentsMessage.classList.add('hidden');
                studentListContainer.classList.remove('hidden');
                susAccounts.forEach(student => {
                    const firstName = student.email.split('@')[0].split('.')[0]; // Get first part before @ and then before .
                    const studentCard = document.createElement('div');
                    studentCard.className = `bg-blue-100 p-6 rounded-xl shadow-md cursor-pointer transform transition-transform hover:scale-105 flex items-center justify-center text-center`;
                    studentCard.innerHTML = `
                        <h3 class="text-xl font-bold text-blue-800">${firstName}</h3>
                    `;
                    studentCard.addEventListener('click', () => showStudentDetailView(student.id, firstName));
                    studentListContainer.appendChild(studentCard);
                });
            }
        }

        // Student Detail View (Overview of Subjects for a Student)
        async function showStudentDetailView(studentId, studentName) {
            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um Sch√ºlerbeurteilungen zu verwalten.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            currentStudentForAssessment = { id: studentId, name: studentName };
            document.getElementById('studentDetailName').textContent = studentName;
            navigateToView('student-detail-view');

            const studentSubjectOverviewContainer = document.getElementById('studentSubjectOverview');
            studentSubjectOverviewContainer.innerHTML = ''; // Clear existing content

            for (const subject of subjects) {
                const subjectCard = document.createElement('div');
                const textColorClass = getContrastTextColor(subject.color);

                subjectCard.className = `bg-white rounded-xl shadow-lg p-6 cursor-pointer transform transition-transform hover:scale-105 ${subject.color} ${textColorClass} flex flex-col justify-between`;
                subjectCard.style.minHeight = '180px'; // Ensure consistent height

                // --- Calculate actual GA/EA progress ---
                let gaTotalWeight = 0;
                let gaFulfilledWeight = 0;
                let gaPartiallyFulfilledWeight = 0;
                let gaNotFulfilledWeight = 0;

                let eaTotalWeight = 0;
                let eaFulfilledWeight = 0;
                let eaPartiallyFulfilledWeight = 0;
                let eaNotFulfilledWeight = 0;

                // 1. Fetch general learning goals for this subject
                const learningGoalsCollectionRef = collection(
                    doc(
                        collection(
                            doc(db, 'artifacts', appId),
                            'assessment_data'
                        ),
                        subject.name
                    ),
                    'learningGoals'
                );
                console.log(`[showStudentDetailView] Fetching general learning goals for ${subject.name} from path: artifacts/${appId}/assessment_data/${subject.name}/learningGoals`);
                const learningGoalsSnapshot = await getDocs(learningGoalsCollectionRef);
                
                const generalLearningGoals = [];
                learningGoalsSnapshot.forEach(doc => {
                    generalLearningGoals.push({ id: doc.id, ...doc.data() });
                });
                console.log(`[showStudentDetailView] Found ${generalLearningGoals.length} general learning goals for ${subject.name}.`);
                console.log(`[showStudentDetailView] General learning goals for ${subject.name}:`, generalLearningGoals);


                // 2. Fetch existing assessments for this student and subject
                // Explicitly build the collection reference for student assessments
                const studentAssessmentsCollectionRef = collection(
                    doc(
                        collection(
                            doc(
                                collection(
                                    doc(db, 'artifacts', appId), // artifacts/{appId} (Document)
                                    'assessment_data' // assessment_data (Collection)
                                ),
                                'students', // students (Collection) - THIS IS THE KEY FIX
                                studentId // studentId (Document)
                            ),
                            'subjectAssessments' // subjectAssessments (Collection)
                        ),
                        subject.name // subject.name (Document)
                    ),
                    'assessments' // assessments (Collection)
                );
                console.log(`[showStudentDetailView] Constructed studentAssessmentsCollectionRef for ${studentName} in ${subject.name}. Full path: artifacts/${appId}/assessment_data/students/${studentId}/subjectAssessments/${subject.name}/assessments`);

                const studentAssessmentsSnapshot = await getDocs(studentAssessmentsCollectionRef);
                
                const currentStudentAssessments = {};
                studentAssessmentsSnapshot.forEach(doc => {
                    currentStudentAssessments[doc.id] = doc.data().status;
                });
                console.log(`[showStudentDetailView] Found ${Object.keys(currentStudentAssessments).length} existing assessments for ${studentName} in ${subject.name}.`);
                console.log(`[showStudentDetailView] Existing student assessments for ${studentName} in ${subject.name}:`, currentStudentAssessments);


                // 3. Iterate through learning goals and calculate progress
                generalLearningGoals.forEach(goal => {
                    const status = currentStudentAssessments[goal.id] || 'not_assessed'; // Default if not assessed

                    if (goal.type === 'GA') {
                        gaTotalWeight += goal.weight;
                        if (status === 'fulfilled') {
                            gaFulfilledWeight += goal.weight;
                        } else if (status === 'partially_fulfilled') {
                            gaPartiallyFulfilledWeight += goal.weight;
                        } else if (status === 'not_fulfilled') {
                            gaNotFulfilledWeight += goal.weight;
                        }
                    } else if (goal.type === 'EA') {
                        eaTotalWeight += goal.weight;
                        if (status === 'fulfilled') {
                            eaFulfilledWeight += goal.weight;
                        } else if (status === 'partially_fulfilled') {
                            eaPartiallyFulfilledWeight += goal.weight;
                        } else if (status === 'not_fulfilled') {
                            eaNotFulfilledWeight += goal.weight;
                        }
                    }
                });

                // Calculate percentages
                const gaFulfilledPercent = gaTotalWeight > 0 ? (gaFulfilledWeight / gaTotalWeight) * 100 : 0;
                const gaPartiallyFulfilledPercent = gaTotalWeight > 0 ? (gaPartiallyFulfilledWeight / gaTotalWeight) * 100 : 0;
                const gaNotFulfilledPercent = gaTotalWeight > 0 ? (gaNotFulfilledWeight / gaTotalWeight) * 100 : 0;

                const eaFulfilledPercent = eaTotalWeight > 0 ? (eaFulfilledWeight / eaTotalWeight) * 100 : 0;
                const eaPartiallyFulfilledPercent = eaTotalWeight > 0 ? (eaPartiallyFulfilledWeight / eaTotalWeight) * 100 : 0;
                const eaNotFulfilledPercent = eaTotalWeight > 0 ? (eaNotFulfilledWeight / eaTotalWeight) * 100 : 0;

                console.log(`[showStudentDetailView] Calculated GA Percentages for ${subject.name}: F:${gaFulfilledPercent.toFixed(0)}%, P:${gaPartiallyFulfilledPercent.toFixed(0)}%, N:${gaNotFulfilledPercent.toFixed(0)}%`);
                console.log(`[showStudentDetailView] Calculated EA Percentages for ${subject.name}: F:${eaFulfilledPercent.toFixed(0)}%, P:${eaPartiallyFulfilledPercent.toFixed(0)}%, N:${eaNotFulfilledPercent.toFixed(0)}%`);


                subjectCard.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-2">${subject.name}</h3>
                        <p class="text-sm opacity-90 mb-4">Beurteilung & Fortschritt</p>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <h4 class="font-medium text-sm mb-1">GA Fortschritt</h4>
                            <div class="progress-bar-container">
                                <div class="progress-segment segment-green" style="width: ${gaFulfilledPercent}%;">${gaFulfilledPercent.toFixed(0)}%</div>
                                <div class="progress-segment segment-yellow" style="width: ${gaPartiallyFulfilledPercent}%;">${gaPartiallyFulfilledPercent.toFixed(0)}%</div>
                                <div class="progress-segment segment-red" style="width: ${gaNotFulfilledPercent}%;">${gaNotFulfilledPercent.toFixed(0)}%</div>
                            </div>
                            <p class="text-xs opacity-80 mt-1">Erf√ºllt: ${gaFulfilledPercent.toFixed(0)}%, Teilw.: ${gaPartiallyFulfilledPercent.toFixed(0)}%, Nicht: ${gaNotFulfilledPercent.toFixed(0)}%</p>
                        </div>
                        <div>
                            <h4 class="font-medium text-sm mb-1">EA Fortschritt</h4>
                            <div class="progress-bar-container">
                                <div class="progress-segment segment-green" style="width: ${eaFulfilledPercent}%;">${eaFulfilledPercent.toFixed(0)}%</div>
                                <div class="progress-segment segment-yellow" style="width: ${eaPartiallyFulfilledPercent}%;">${eaPartiallyFulfilledPercent.toFixed(0)}%</div>
                                <div class="progress-segment segment-red" style="width: ${eaNotFulfilledPercent}%;">${eaNotFulfilledPercent.toFixed(0)}%</div>
                            </div>
                            <p class="text-xs opacity-80 mt-1">Erf√ºllt: ${eaFulfilledPercent.toFixed(0)}%, Teilw.: ${eaPartiallyFulfilledPercent.toFixed(0)}%, Nicht: ${eaNotFulfilledPercent.toFixed(0)}%</p>
                        </div>
                    </div>
                `;
                subjectCard.addEventListener('click', () => showStudentSubjectAssessmentView(studentId, studentName, subject.name));
                studentSubjectOverviewContainer.appendChild(subjectCard);
            }
        }

        // Student Subject Assessment View (Assess Learning Goals for a Student in a Specific Subject)
        async function showStudentSubjectAssessmentView(studentId, studentName, subjectName) {
            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um Sch√ºlerbeurteilungen zu verwalten.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            currentStudentForAssessment = { id: studentId, name: studentName }; // Ensure this is set
            currentSubjectForStudentAssessment = subjectName; // Set the subject for assessment

            document.getElementById('assessmentStudentName').textContent = studentName;
            document.getElementById('assessmentSubjectName').textContent = subjectName;
            navigateToView('student-subject-assessment-view');

            const assessmentLearningGoalsList = document.getElementById('assessmentLearningGoalsList');
            assessmentLearningGoalsList.innerHTML = ''; // Clear existing content

            // Fetch general learning goals for the subject (explicitly built path)
            const learningGoalsCollectionRef = collection(
                doc(
                    collection(
                        doc(db, 'artifacts', appId),
                        'assessment_data'
                    ),
                    subjectName
                ),
                'learningGoals'
            );
            console.log(`[showStudentSubjectAssessmentView] Fetching general learning goals for assessment from path: artifacts/${appId}/assessment_data/${subjectName}/learningGoals`);
            const learningGoalsSnapshot = await getDocs(learningGoalsCollectionRef);
            
            console.log('[showStudentSubjectAssessmentView] Learning goals collection snapshot size:', learningGoalsSnapshot.size);
            const generalLearningGoals = [];
            learningGoalsSnapshot.forEach(doc => {
                generalLearningGoals.push({ id: doc.id, ...doc.data() });
            });
            console.log('[showStudentSubjectAssessmentView] Fetched general learning goals for assessment:', generalLearningGoals);

            // Fetch existing assessments for this student and subject (explicitly built path)
            const studentAssessmentsCollectionRef = collection(
                doc(
                    collection(
                        doc(
                            collection(
                                doc(db, 'artifacts', appId),
                                'assessment_data'
                            ),
                            'students',
                            studentId
                        ),
                        'subjectAssessments'
                    ),
                    subjectName
                ),
                'assessments'
            );
            console.log(`[showStudentSubjectAssessmentView] Constructed studentAssessmentsCollectionRef for ${studentName} in ${subjectName}. Full path: artifacts/${appId}/assessment_data/students/${studentId}/subjectAssessments/${subjectName}/assessments`);

            const studentAssessmentsSnapshot = await getDocs(studentAssessmentsCollectionRef);
            
            console.log('[showStudentSubjectAssessmentView] Student assessments collection snapshot size:', studentAssessmentsSnapshot.size);
            studentAssessments = {}; // Reset global studentAssessments object
            studentAssessmentsSnapshot.forEach(doc => {
                studentAssessments[doc.id] = doc.data().status; // Store status by goalId
            });
            console.log('[showStudentSubjectAssessmentView] Fetched existing student assessments:', studentAssessments);


            if (generalLearningGoals.length === 0) {
                assessmentLearningGoalsList.innerHTML = '<p class="text-gray-500 text-center py-4">F√ºr dieses Fach sind noch keine Lernziele definiert.</p>';
                return;
            }

            // Render each learning goal with assessment options
            generalLearningGoals.forEach(goal => {
                const currentStatus = studentAssessments[goal.id] || 'not_assessed'; // Default to 'not_assessed'
                const goalItem = document.createElement('div');
                goalItem.className = `bg-gray-50 p-5 rounded-lg shadow-sm border-l-4 ${goal.type === 'GA' ? 'border-blue-400' : 'border-purple-400'}`;
                goalItem.innerHTML = `
                    <p class="font-semibold text-gray-800 mb-2">${goal.description}</p>
                    <p class="text-sm text-gray-600 mb-4">Typ: ${goal.type === 'GA' ? 'Grundanforderung (üîµ)' : 'Erweiterte Anforderung (‚≠ê)'} | Gewichtung: ${goal.weight}</p>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="assessment-${goal.id}" value="fulfilled" class="form-radio text-green-600 h-4 w-4" ${currentStatus === 'fulfilled' ? 'checked' : ''}>
                            <span class="ml-2 text-gray-700">Erf√ºllt</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="assessment-${goal.id}" value="partially_fulfilled" class="form-radio text-yellow-600 h-4 w-4" ${currentStatus === 'partially_fulfilled' ? 'checked' : ''}>
                            <span class="ml-2 text-gray-700">Teilweise Erf√ºllt</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="assessment-${goal.id}" value="not_fulfilled" class="form-radio text-red-600 h-4 w-4" ${currentStatus === 'not_fulfilled' ? 'checked' : ''}>
                            <span class="ml-2 text-gray-700">Nicht Erf√ºllt</span>
                        </label>
                    </div>
                `;
                assessmentLearningGoalsList.appendChild(goalItem);
            });
        }

        async function handleSaveStudentAssessment() {
            if (!isAuthReady || !user) {
                showCustomMessage("Fehler: Nicht angemeldet oder Sch√ºler/Fach nicht ausgew√§hlt.", 'error', 'Fehler');
                return;
            }

            const saveButton = document.getElementById('saveStudentAssessmentButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Speichern...';

            try {
                const assessmentLearningGoalsList = document.getElementById('assessmentLearningGoalsList');
                const goalItems = assessmentLearningGoalsList.querySelectorAll('.bg-gray-50'); // Select each goal item

                for (const goalItem of goalItems) {
                    const goalId = goalItem.querySelector('input[type="radio"]').name.replace('assessment-', '');
                    const selectedRadio = goalItem.querySelector(`input[name="assessment-${goalId}"]:checked`);
                    const status = selectedRadio ? selectedRadio.value : 'not_assessed'; // Default if none selected

                    const assessmentData = {
                        status: status,
                        assessedBy: user.email,
                        assessedAt: new Date().toISOString()
                    };

                    // Save assessment for this specific goal, student, and subject (explicitly built path)
                    const assessmentDocRef = doc(
                        collection(
                            doc(
                                collection(
                                    doc(
                                        collection(
                                            doc(db, 'artifacts', appId),
                                            'assessment_data'
                                        ),
                                        'students',
                                        currentStudentForAssessment.id
                                    ),
                                    'subjectAssessments'
                                ),
                                currentSubjectForStudentAssessment
                            ),
                            'assessments'
                        ),
                        goalId
                    );

                    await setDoc(assessmentDocRef, assessmentData);
                    console.log(`Assessment saved for Goal ID: ${goalId}, Status: ${status}`);
                }

                showCustomMessage('Sch√ºlerbeurteilung erfolgreich gespeichert!', 'success', 'Erfolg');
                // Re-render the student subject assessment view to reflect changes
                showStudentSubjectAssessmentView(currentStudentForAssessment.id, currentStudentForAssessment.name, currentSubjectForStudentAssessment);

            } catch (error) {
                console.error("Fehler beim Speichern der Sch√ºlerbeurteilung:", error);
                showCustomMessage('Fehler beim Speichern der Sch√ºlerbeurteilung: ' + error.message, 'error', 'Speicherfehler');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Beurteilung speichern';
            }
        }

    </script>
</body>
</html>
