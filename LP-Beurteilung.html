<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LP Beurteilungsportal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modals */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modern-button {
            transition: all 0.2s ease-in-out;
        }
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .modern-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md text-center">
            <div class="w-12 h-12 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Firebase wird geladen...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-96">
            <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">LP Beurteilungsportal Login</h1>
            <div>
                <div class="mb-4">
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">E-Mail</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Passwort</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                </div>
                <button id="loginButton" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50 modern-button text-lg font-semibold">
                    Anmelden
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="min-h-screen hidden">
        <div class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-3xl font-bold text-gray-900">LP Beurteilungsportal</h1>
                    <div class="flex items-center space-x-4">
                        <span id="userEmail" class="text-base text-gray-600 font-medium"></span>
                        <button id="logoutButton" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 p-2 rounded-md hover:bg-gray-100 transition-colors modern-button">
                            <span>Abmelden</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <!-- Tabs for Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-8 px-6">
                        <button data-tab="subjects" class="tab-button py-4 px-2 border-b-2 font-medium text-base border-transparent text-gray-500 hover:text-gray-700 transition-colors">
                            üìö F√§cher & Lernziele
                        </button>
                        <button data-tab="students" class="tab-button py-4 px-2 border-b-2 font-medium text-base border-transparent text-gray-500 hover:text-gray-700 transition-colors">
                            üßë‚Äçüéì Sch√ºler-Beurteilung
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div id="subjects-content" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">F√§cher & Lernziele definieren</h2>
                    <div id="subjectsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Subjects will be rendered here -->
                    </div>
                </div>

                <div id="students-content" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800">Sch√ºler-Beurteilung</h2>
                    <p class="text-gray-600 mb-6">W√§hlen Sie einen Sch√ºler, um seine Beurteilungen zu verwalten.</p>
                    <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Student cards will be rendered here -->
                    </div>
                    <p id="noStudentsMessage" class="text-gray-500 text-center mt-8 hidden">
                        Es sind noch keine Sch√ºler-Accounts vorhanden.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Learning Goal Modal -->
    <div id="learningGoalModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full mx-4">
            <h3 class="text-xl font-semibold mb-4 text-gray-900" id="learningGoalModalTitle">Lernziele f√ºr <span id="modalSubjectName" class="font-bold"></span></h3>
            <div class="mb-4">
                <button id="addLearningGoalButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 modern-button">
                    + Lernziel hinzuf√ºgen
                </button>
            </div>
            <div id="learningGoalsList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <!-- Learning goals will be dynamically added here -->
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="closeLearningGoalModal" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 modern-button">Schliessen</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Learning Goal Form Modal -->
    <div id="addEditLearningGoalModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-[100]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4 text-gray-900" id="addEditLearningGoalModalTitle">Lernziel hinzuf√ºgen</h3>
            <form id="learningGoalForm" class="space-y-4">
                <div>
                    <label for="lgDescription" class="block text-sm font-medium text-gray-700">Beschreibung</label>
                    <input type="text" id="lgDescription" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="lgType" class="block text-sm font-medium text-gray-700">Typ</label>
                    <select id="lgType" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="GA">Grundanforderung (GA)</option>
                        <option value="EA">Erweiterte Anforderung (EA)</option>
                    </select>
                </div>
                <div>
                    <label for="lgWeight" class="block text-sm font-medium text-gray-700">Gewichtung</label>
                    <input type="number" id="lgWeight" min="1" value="1" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelLearningGoalForm" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 modern-button">Abbrechen</button>
                    <button type="submit" id="saveLearningGoalButton" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 modern-button">Speichern</button>
                    <button type="button" id="deleteLearningGoalButton" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden modern-button">L√∂schen</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Custom Message Modal -->
    <div id="customMessageModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-[9999]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="customMessageTitle" class="text-xl font-semibold mb-4 text-gray-900"></h3>
            <p id="customMessageContent" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="customMessageCloseButton" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 modern-button">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center z-[9999]">
        <div class="modal-content bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h3 id="customConfirmTitle" class="text-xl font-semibold mb-4 text-gray-900">Best√§tigung</h3>
            <p id="customConfirmContent" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="customConfirmCancelButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 modern-button">Abbrechen</button>
                <button id="customConfirmOkButton" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 modern-button">L√∂schen</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, getDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app;
        let auth;
        let db;
        let user = null; // Firebase user object
        let userId = null; // User ID (UID)
        let isAuthReady = false; // Flag to ensure Firestore operations wait for auth

        // Global variables provided by the Canvas environment (if applicable)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Log the current appId for debugging
        console.log('Aktuelle App ID:', appId);


        // Ihre Firebase-Konfiguration (direkt eingef√ºgt)
        const firebaseConfig = {
            apiKey: "AIzaSyAsexnWyCjkYz8kfAPd7Od1g0xsfcSEKRk",
            authDomain: "sol-portal-cf905.firebaseapp.com",
            projectId: "sol-portal-cf905",
            storageBucket: "sol-portal-cf905.firebasestorage.app",
            messagingSenderId: "478097533058",
            appId: "1:478097533058:web:b2afa0a73892b90d8a2c9b",
            measurementId: "G-JJ3RRJNK7T"
        };

        let activeTab = 'subjects'; // Default tab for LP portal
        let lpAccounts = [];
        let susAccounts = [];
        let currentSubjectForGoals = null; // Stores the subject currently being edited for learning goals
        let learningGoals = []; // Stores learning goals for the current subject

        const subjects = [
            { name: 'Deutsch', color: 'bg-red-500' },
            { name: 'Englisch', color: 'bg-blue-500' },
            { name: 'Franzoesisch', color: 'bg-purple-500' },
            { name: 'Mathematik', color: 'bg-green-500' },
            { name: 'Natur und Technik', color: 'bg-yellow-500' },
            { name: 'Wirtschaft, Arbeit, Haushalt', color: 'bg-amber-500' },
            { name: 'Raeume, Zeiten, Gesellschaften', color: 'bg-orange-500' },
            { name: 'Musik', color: 'bg-violet-500' },
            { name: 'Textiles Gestalten', color: 'bg-indigo-500' },
            { name: 'Technisches Gestalten', color: 'bg-pink-500' },
            { name: 'Bildnerisches Gestalten', color: 'bg-teal-500' },
            { name: 'Bewegung und Sport', color: 'bg-red-600' }
        ];

        // Helper to get a Firestore document (now using getDoc for a single fetch)
        async function getFirestoreDoc(dbInstance, collectionName, docId) {
            const docRef = doc(dbInstance, collectionName, docId); // Adjusted for root-level collections
            try {
                const docSnapshot = await getDoc(docRef);
                return docSnapshot;
            } catch (error) {
                console.error("Error fetching Firestore document:", error);
                throw error; // Re-throw the error for handling in the calling function
            }
        }

        // --- Firebase Initialization ---
        window.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (firebaseUser) => {
                    user = firebaseUser;
                    if (user) {
                        userId = user.uid;
                        // If a user is already logged in (e.g., session restored),
                        // verify if they are an LP and then show the main app.
                        // Adjusted path for lpAccounts to be root-level
                        const lpDoc = await getFirestoreDoc(db, 'lpAccounts', userId);
                        // IMPORTANT: Check for existence AND the role field
                        if (lpDoc.exists() && lpDoc.data().role === 'LP') {
                            showMainApp();
                            await loadUserData();
                        } else {
                            // If logged in user is NOT an LP, sign them out and show login screen
                            await signOut(auth);
                            showLoginScreen();
                            showCustomMessage('Dieser Account ist kein Lehrpersonen-Account. Bitte melden Sie sich mit einem g√ºltigen LP-Account an.', 'error', 'Zugriff verweigert');
                        }
                    } else {
                        // If no user is logged in, always show the login screen first.
                        showLoginScreen();
                    }
                    isAuthReady = true;
                    hideLoadingScreen();
                });

                // Removed initial signInWithCustomToken and signInAnonymously calls
                // These are no longer needed here as the login flow is explicit via email/password.

                initializeEventListeners();
                renderSubjectsGrid(); // Initial render of subjects
            } catch (error) {
                console.error('Fehler bei Firebase-Initialisierung:', error);
                showCustomMessage('Firebase-Initialisierung fehlgeschlagen: ' + error.message, 'error', 'Initialisierungsfehler');
                hideLoadingScreen();
            }
        }

        // --- UI State Management ---
        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = user ? user.email : 'Gast';
            switchTab(activeTab);
        }

        function switchTab(tabName) {
            activeTab = tabName;

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabName) {
                    button.classList.add('border-blue-500', 'text-blue-600');
                    button.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    button.classList.remove('border-blue-500', 'text-blue-600');
                    button.classList.add('border-transparent', 'text-gray-500');
                }
            });

            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName + '-content').classList.remove('hidden');

            if (tabName === 'subjects') {
                renderSubjectsGrid();
            } else if (tabName === 'students') {
                updateStudentListDisplay();
            }
        }

        // --- Custom Modals ---
        function showCustomMessage(message, type = 'info', title = 'Nachricht') {
            const modal = document.getElementById('customMessageModal');
            document.getElementById('customMessageTitle').textContent = title;
            document.getElementById('customMessageContent').textContent = message;
            modal.classList.remove('hidden');
        }

        function hideCustomMessage() {
            document.getElementById('customMessageModal').classList.add('hidden');
        }

        document.getElementById('customMessageCloseButton').addEventListener('click', hideCustomMessage);

        function showCustomConfirm(message, callback, title = 'Best√§tigen') {
            const modal = document.getElementById('customConfirmModal');
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmContent').textContent = message;
            modal.classList.remove('hidden');

            const okButton = document.getElementById('customConfirmOkButton');
            const cancelButton = document.getElementById('customConfirmCancelButton');

            okButton.onclick = null;
            cancelButton.onclick = null;

            okButton.onclick = () => {
                modal.classList.add('hidden');
                callback(true);
            };
            cancelButton.onclick = () => {
                modal.classList.add('hidden');
                callback(false);
            };
        }

        // --- Event Listeners ---
        function initializeEventListeners() {
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });

            document.getElementById('logoutButton').addEventListener('click', handleLogout);

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            // Learning Goal Modal Listeners
            document.getElementById('addLearningGoalButton').addEventListener('click', () => showAddEditLearningGoalModal());
            document.getElementById('closeLearningGoalModal').addEventListener('click', hideLearningGoalModal);

            // Add/Edit Learning Goal Form Modal Listeners
            document.getElementById('learningGoalForm').addEventListener('submit', handleSaveLearningGoal);
            document.getElementById('cancelLearningGoalForm').addEventListener('click', hideAddEditLearningGoalModal);
            document.getElementById('deleteLearningGoalButton').addEventListener('click', handleDeleteLearningGoal);
        }

        // --- Authentication Handlers ---
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');

            if (!email || !password) {
                showCustomMessage('Bitte E-Mail und Passwort eingeben.', 'warning', 'Eingabe erforderlich');
                return;
            }

            button.disabled = true;
            button.textContent = 'Anmelden...';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const loggedInUserId = userCredential.user.uid;

                // NOW check if the user is an LP account after successful email/password login
                // Adjusted path for lpAccounts to be root-level
                const lpDoc = await getFirestoreDoc(db, 'lpAccounts', loggedInUserId);
                // IMPORTANT: Check for existence AND the role field
                if (lpDoc.exists() && lpDoc.data().role === 'LP') {
                    // If it's an LP account, onAuthStateChanged will be triggered
                    // and will handle showing the main app and loading data.
                } else {
                    // If not an LP account, sign out immediately and show error.
                    await signOut(auth);
                    showCustomMessage('Dieser Account ist kein Lehrpersonen-Account. Bitte melden Sie sich mit einem g√ºltigen LP-Account an.', 'error', 'Zugriff verweigert');
                }
            } catch (error) {
                console.error("Login fehlgeschlagen:", error);
                showCustomMessage('Login fehlgeschlagen: ' + error.message, 'error', 'Login Fehler');
            } finally {
                button.disabled = false;
                button.textContent = 'Anmelden';
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                activeTab = 'subjects'; // Reset tab on logout
                switchTab('subjects');
            } catch (error) {
                console.error("Error logging out:", error);
                showCustomMessage("Fehler beim Abmelden: " + error.message, 'error', 'Abmeldefehler');
            }
        }

        // --- Data Loading from Firestore ---
        async function loadUserData() {
            if (!isAuthReady || !userId) {
                console.warn("Auth not ready or user not logged in, skipping data load.");
                return;
            }

            // Listen to LP Accounts (public data) - Adjusted path
            onSnapshot(collection(db, 'lpAccounts'), (querySnapshot) => {
                lpAccounts = [];
                querySnapshot.forEach((doc) => {
                    lpAccounts.push({ id: doc.id, ...doc.data() });
                });
                // updateLpAccountsDisplay(); // Not needed in this portal
            }, (error) => {
                console.error("Error fetching LP accounts:", error);
                showCustomMessage("Fehler beim Laden der LP-Accounts: " + error.message, 'error', 'Ladefehler');
            });

            // Listen to SuS Accounts (public data) - Adjusted path
            onSnapshot(collection(db, 'susAccounts'), (querySnapshot) => {
                susAccounts = [];
                querySnapshot.forEach((doc) => {
                    susAccounts.push({ id: doc.id, ...doc.data() });
                });
                updateStudentListDisplay();
            }, (error) => {
                console.error("Error fetching SuS accounts:", error);
                showCustomMessage("Fehler beim Laden der SuS-Accounts: " + error.message, 'error', 'Ladefehler');
            });

            // Listen to learning goals for the currently selected subject
            // This listener will be set up when showLearningGoalModal is called
        }

        // --- Subjects & Learning Goals Tab ---
        function renderSubjectsGrid() {
            const subjectsGrid = document.getElementById('subjectsGrid');
            subjectsGrid.innerHTML = ''; // Clear existing subjects

            subjects.forEach(subject => {
                const subjectCard = document.createElement('div');
                subjectCard.className = `bg-white rounded-xl shadow-lg p-6 cursor-pointer transform transition-transform hover:scale-105 ${subject.color} text-white flex flex-col items-center justify-center text-center`;
                subjectCard.style.minHeight = '150px'; // Ensure cards have a consistent height
                subjectCard.setAttribute('data-subject-name', subject.name);
                subjectCard.addEventListener('click', () => openLearningGoalModal(subject.name));
                subjectsGrid.appendChild(subjectCard);
            });
        }

        async function openLearningGoalModal(subjectName) {
            if (!isAuthReady || !user) {
                showCustomMessage("Bitte melden Sie sich an, um Lernziele zu verwalten.", 'warning', 'Anmeldung erforderlich');
                return;
            }

            currentSubjectForGoals = subjectName;
            document.getElementById('modalSubjectName').textContent = subjectName;
            document.getElementById('learningGoalModal').classList.remove('hidden');

            // Listen to learning goals for this specific subject
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'assessment', 'subjects', subjectName, 'learningGoals'), (querySnapshot) => {
                learningGoals = [];
                querySnapshot.forEach((doc) => {
                    learningGoals.push({ id: doc.id, ...doc.data() });
                });
                renderLearningGoalsList();
            }, (error) => {
                console.error("Error fetching learning goals:", error);
                showCustomMessage("Fehler beim Laden der Lernziele: " + error.message, 'error', 'Ladefehler');
            });
        }

        function hideLearningGoalModal() {
            document.getElementById('learningGoalModal').classList.add('hidden');
            currentSubjectForGoals = null;
            learningGoals = []; // Clear goals when modal is closed
        }

        function renderLearningGoalsList() {
            const listContainer = document.getElementById('learningGoalsList');
            listContainer.innerHTML = ''; // Clear existing goals

            if (learningGoals.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Noch keine Lernziele f√ºr dieses Fach definiert.</p>';
                return;
            }

            learningGoals.forEach(goal => {
                const goalItem = document.createElement('div');
                goalItem.className = `bg-gray-50 p-4 rounded-lg shadow-sm flex items-center justify-between border-l-4 ${goal.type === 'GA' ? 'border-blue-400' : 'border-purple-400'}`;
                goalItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${goal.description}</p>
                        <p class="text-sm text-gray-600">
                            Typ: ${goal.type === 'GA' ? 'Grundanforderung (üîµ)' : 'Erweiterte Anforderung (‚≠ê)'} |
                            Gewichtung: ${goal.weight}
                        </p>
                    </div>
                    <button class="edit-goal-button text-blue-500 hover:text-blue-700 p-2 rounded-md hover:bg-blue-100 transition-colors" data-goal-id="${goal.id}">
                        Bearbeiten
                    </button>
                `;
                listContainer.appendChild(goalItem);

                goalItem.querySelector('.edit-goal-button').addEventListener('click', () => showAddEditLearningGoalModal(goal));
            });
        }

        function showAddEditLearningGoalModal(goal = null) {
            const modal = document.getElementById('addEditLearningGoalModal');
            const titleElement = document.getElementById('addEditLearningGoalModalTitle');
            const form = document.getElementById('learningGoalForm');
            const descriptionInput = document.getElementById('lgDescription');
            const typeSelect = document.getElementById('lgType');
            const weightInput = document.getElementById('lgWeight');
            const deleteButton = document.getElementById('deleteLearningGoalButton');

            form.reset(); // Clear form
            deleteButton.classList.add('hidden'); // Hide delete button by default
            form.dataset.goalId = ''; // Clear goal ID

            if (goal) {
                titleElement.textContent = 'Lernziel bearbeiten';
                descriptionInput.value = goal.description;
                typeSelect.value = goal.type;
                weightInput.value = goal.weight;
                deleteButton.classList.remove('hidden');
                form.dataset.goalId = goal.id; // Store goal ID for update/delete
            } else {
                titleElement.textContent = 'Lernziel hinzuf√ºgen';
                weightInput.value = 1; // Default weight for new goals
            }

            modal.classList.remove('hidden');
        }

        function hideAddEditLearningGoalModal() {
            document.getElementById('addEditLearningGoalModal').classList.add('hidden');
            document.getElementById('learningGoalForm').reset();
            document.getElementById('learningGoalForm').dataset.goalId = '';
        }

        async function handleSaveLearningGoal(event) {
            event.preventDefault();

            if (!isAuthReady || !user || !currentSubjectForGoals) {
                showCustomMessage("Fehler: Nicht angemeldet oder kein Fach ausgew√§hlt.", 'error', 'Fehler');
                return;
            }

            const form = document.getElementById('learningGoalForm');
            const description = document.getElementById('lgDescription').value.trim();
            const type = document.getElementById('lgType').value;
            const weight = parseInt(document.getElementById('lgWeight').value);
            const goalId = form.dataset.goalId;

            if (!description || !type || isNaN(weight) || weight < 1) {
                showCustomMessage('Bitte alle Felder korrekt ausf√ºllen.', 'warning', 'Eingabe erforderlich');
                return;
            }

            const saveButton = document.getElementById('saveLearningGoalButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Speichern...';

            try {
                const goalData = {
                    description: description,
                    type: type,
                    weight: weight,
                    createdAt: new Date().toISOString(),
                    createdBy: user.email
                };

                if (goalId) {
                    // Update existing goal
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'assessment', 'subjects', currentSubjectForGoals, 'learningGoals', goalId), goalData);
                    showCustomMessage('Lernziel erfolgreich aktualisiert!', 'success', 'Erfolg');
                } else {
                    // Add new goal (Firestore will auto-generate ID)
                    const newDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'assessment', 'subjects', currentSubjectForGoals, 'learningGoals'));
                    await setDoc(newDocRef, goalData);
                    showCustomMessage('Lernziel erfolgreich hinzugef√ºgt!', 'success', 'Erfolg');
                }
                hideAddEditLearningGoalModal();
            } catch (error) {
                console.error("Error saving learning goal:", error);
                showCustomMessage('Fehler beim Speichern des Lernziels: ' + error.message, 'error', 'Speicherfehler');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Speichern';
            }
        }

        async function handleDeleteLearningGoal() {
            const form = document.getElementById('learningGoalForm');
            const goalIdToDelete = form.dataset.goalId;

            if (!isAuthReady || !user || !currentSubjectForGoals || !goalIdToDelete) {
                showCustomMessage("Kein Lernziel zum L√∂schen ausgew√§hlt oder keine Berechtigung.", 'warning', 'Fehler');
                return;
            }

            showCustomConfirm('Bist du sicher, dass du dieses Lernziel l√∂schen m√∂chtest? Dies kann nicht r√ºckg√§ngig gemacht werden.', async (confirmed) => {
                if (confirmed) {
                    const deleteButton = document.getElementById('deleteLearningGoalButton');
                    deleteButton.disabled = true;
                    deleteButton.textContent = 'L√∂schen...';

                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'assessment', 'subjects', currentSubjectForGoals, 'learningGoals', goalIdToDelete));
                        showCustomMessage('Lernziel erfolgreich gel√∂scht!', 'success', 'Gel√∂scht');
                        hideAddEditLearningGoalModal();
                    } catch (error) {
                        console.error("Error deleting learning goal:", error);
                        showCustomMessage('Fehler beim L√∂schen des Lernziels: ' + error.message, 'error', 'L√∂schfehler');
                    } finally {
                        deleteButton.disabled = false;
                        deleteButton.textContent = 'L√∂schen';
                    }
                }
            }, 'Lernziel l√∂schen');
        }

        // --- Students Tab ---
        function updateStudentListDisplay() {
            const studentListContainer = document.getElementById('studentList');
            const noStudentsMessage = document.getElementById('noStudentsMessage');
            studentListContainer.innerHTML = ''; // Clear existing cards

            if (susAccounts.length === 0) {
                noStudentsMessage.classList.remove('hidden');
                studentListContainer.classList.add('hidden');
            } else {
                noStudentsMessage.classList.add('hidden');
                studentListContainer.classList.remove('hidden');
                susAccounts.forEach(student => {
                    const firstName = student.email.split('@')[0].split('.')[0]; // Get first part before @ and then before .
                    const studentCard = document.createElement('div');
                    studentCard.className = `bg-blue-100 p-6 rounded-xl shadow-md cursor-pointer transform transition-transform hover:scale-105 flex items-center justify-center text-center`;
                    studentCard.innerHTML = `
                        <h3 class="text-xl font-bold text-blue-800">${firstName}</h3>
                    `;
                    // studentCard.addEventListener('click', () => openStudentAssessmentPage(student.id, student.email)); // To be implemented later
                    studentListContainer.appendChild(studentCard);
                });
            }
        }

        // Placeholder for future student assessment page
        function openStudentAssessmentPage(studentId, studentEmail) {
            showCustomMessage(`Funktion zum Anzeigen der Beurteilungsseite f√ºr ${studentEmail} (ID: ${studentId}) wird noch implementiert.`, 'info', 'In Bearbeitung');
            console.log(`Navigating to assessment page for student: ${studentEmail} (ID: ${studentId})`);
        }

    </script>
</body>
</html>
